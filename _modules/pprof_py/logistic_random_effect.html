

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pprof_py.logistic_random_effect &mdash; pprof_py 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=e46d07af" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pprof_py
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base_model.html">Base Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_fixed_effect_model.html">Linear Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_random_effect_model.html">Linear Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_fixed_effect_model.html">Logistic Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_random_effect_model.html">Logistic Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../direct_vs_indirect_standardization.html">Direct vs. Indirect Standardization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fixed_vs_random_effects.html">Fixed Effects vs. Random Effects Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pprof_py</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pprof_py.logistic_random_effect</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pprof_py.logistic_random_effect</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rpy2.robjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">r</span>

<span class="c1"># --- Pymer4 Import ---</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pymer4.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lmer</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;The &#39;pymer4&#39; package is required for LogisticRandomEffectModel. Please install it (pip install pymer4) and ensure R and lme4 are configured.&quot;</span><span class="p">)</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">.base_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">,</span> <span class="n">TestMixin</span>


<div class="viewcode-block" id="LogisticRandomEffectModel">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LogisticRandomEffectModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">,</span> <span class="n">TestMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logistic Random Effect Model using pymer4.models.Lmer.</span>

<span class="sd">    Estimates a generalized linear mixed model (GLMM) for binary outcomes using</span>
<span class="sd">    R&#39;s lme4 package via pymer4. It incorporates provider-specific random</span>
<span class="sd">    intercepts to account for clustering.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    (No initialization parameters specific to this model beyond BaseModel)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : pymer4.models.Lmer or None</span>
<span class="sd">        The fitted pymer4 Lmer model object.</span>
<span class="sd">    coefficients_ : dict</span>
<span class="sd">        Contains &#39;fixed_effect&#39; (fixed effects estimates as pd.Series) and</span>
<span class="sd">        &#39;random_effect&#39; (predicted random effects/BLUPs as pd.Series/DataFrame).</span>
<span class="sd">    variances_ : dict</span>
<span class="sd">        Contains &#39;fe_var_cov&#39; (fixed effects variance-covariance matrix as pd.DataFrame)</span>
<span class="sd">        and &#39;re_var&#39; (estimated variance(s) of the random effects from model.ranef_var).</span>
<span class="sd">    fitted_ : pd.Series or None</span>
<span class="sd">        Fitted probabilities (response scale) for the training data.</span>
<span class="sd">    residuals_ : pd.Series or None</span>
<span class="sd">        Response residuals (y - fitted_prob) for the training data.</span>
<span class="sd">    pearson_residuals_ : pd.Series or None</span>
<span class="sd">        Pearson residuals (from pymer4 model if available).</span>
<span class="sd">    # sigma_ attribute from BaseModel is generally not applicable/meaningful for logistic models.</span>
<span class="sd">    aic_ : float or None</span>
<span class="sd">        Akaike Information Criterion.</span>
<span class="sd">    bic_ : float or None</span>
<span class="sd">        Bayesian Information Criterion.</span>
<span class="sd">    loglike_ : float or None</span>
<span class="sd">        Log-likelihood of the fitted model.</span>
<span class="sd">    groups_ : np.ndarray or None</span>
<span class="sd">        Unique group identifiers present in the fitted data.</span>
<span class="sd">    group_sizes_ : np.ndarray or None</span>
<span class="sd">        Number of observations per group.</span>
<span class="sd">    xbeta_ : np.ndarray or None</span>
<span class="sd">        Linear predictor component from fixed effects only ($X\hat{\beta}$) for the fitted data.</span>
<span class="sd">    covariate_names_ : List[str] or None</span>
<span class="sd">        Names of the fixed effect covariates (excluding intercept).</span>
<span class="sd">    # Attributes related to statsmodels results are removed or replaced</span>
<span class="sd">    # by pymer4 equivalents where applicable.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; # Generate synthetic data (replace with actual data)</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(123)</span>
<span class="sd">    &gt;&gt;&gt; n_groups = 20; n_obs_per_group = 50; N = n_groups * n_obs_per_group</span>
<span class="sd">    &gt;&gt;&gt; groups = np.repeat([f&#39;G{i+1}&#39; for i in range(n_groups)], n_obs_per_group) # Use string IDs</span>
<span class="sd">    &gt;&gt;&gt; x1 = np.random.randn(N); x2 = np.random.binomial(1, 0.4, N)</span>
<span class="sd">    &gt;&gt;&gt; true_beta = np.array([0.5, -1.0]); true_intercept = -0.5; true_re_sd = 0.8</span>
<span class="sd">    &gt;&gt;&gt; true_re_dict = {f&#39;G{i+1}&#39;: np.random.normal(0, true_re_sd) for i in range(n_groups)}</span>
<span class="sd">    &gt;&gt;&gt; true_re_obs = np.array([true_re_dict[g] for g in groups])</span>
<span class="sd">    &gt;&gt;&gt; lin_pred = true_intercept + x1 * true_beta[0] + x2 * true_beta[1] + true_re_obs</span>
<span class="sd">    &gt;&gt;&gt; prob = 1 / (1 + np.exp(-lin_pred)); y = np.random.binomial(1, prob)</span>
<span class="sd">    &gt;&gt;&gt; data = pd.DataFrame({&#39;Y&#39;: y, &#39;X1&#39;: x1, &#39;X2&#39;: x2, &#39;GroupID&#39;: groups})</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Fit the model using pymer4</span>
<span class="sd">    &gt;&gt;&gt; logit_re_model = LogisticRandomEffectModel()</span>
<span class="sd">    &gt;&gt;&gt; logit_re_model.fit(X=data, y_var=&#39;Y&#39;, x_vars=[&#39;X1&#39;, &#39;X2&#39;], group_var=&#39;GroupID&#39;)</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Get summary (fixed effects)</span>
<span class="sd">    &gt;&gt;&gt; print(logit_re_model.summary())</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Get standardized differences (based on BLUPs)</span>
<span class="sd">    &gt;&gt;&gt; # sm = logit_re_model.calculate_standardized_measures(null=&#39;median&#39;)</span>
<span class="sd">    &gt;&gt;&gt; # print(sm[&#39;indirect&#39;].head())</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Plot provider effects (BLUPs)</span>
<span class="sd">    &gt;&gt;&gt; # logit_re_model.plot_provider_effects() # Requires matplotlib</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LogisticRandomEffectModel.__init__">
<a class="viewcode-back" href="../../_autosummary_generated/pprof_py.logistic_random_effect.LogisticRandomEffectModel.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the LogisticRandomEffectModel with placeholders.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span> <span class="c1"># Initialize BaseModel attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Lmer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Type hint for pymer4 model</span>
        <span class="c1"># Remove attributes specific to statsmodels results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># No separate result object needed like statsmodels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pearson_residuals_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviance_residuals_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Lmer might not provide this easily</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loglike_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Store original endog if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_fe_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Store design matrix if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Store RE design matrix if needed</span></div>



<div class="viewcode-block" id="LogisticRandomEffectModel.fit">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">X</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">x_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">y_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">group_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LogisticRandomEffectModel&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the logistic random effect model using pymer4 Lmer with family=&#39;binomial&#39;.</span>

<span class="sd">        Requires either a DataFrame `X` with `y_var`, `x_vars`, `group_var` specified,</span>
<span class="sd">        or separate arrays/Series for `X`, `y`, and `groups`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame or array-like, optional</span>
<span class="sd">            Dataset containing covariates and potentially outcome and group ID, or a design matrix.</span>
<span class="sd">        y : pd.Series or array-like, optional</span>
<span class="sd">            Binary response variable (0 or 1). Required if not in `X` DataFrame via `y_var`.</span>
<span class="sd">        groups : pd.Series or array-like, optional</span>
<span class="sd">            Group identifiers for random effects. Required if not in `X` DataFrame via `group_var`.</span>
<span class="sd">        x_vars : list of str, optional</span>
<span class="sd">            Predictor column names in `X` DataFrame. Required if `X` is DataFrame.</span>
<span class="sd">        y_var : str, optional</span>
<span class="sd">            Response column name in `X` DataFrame. Required if `X` is DataFrame.</span>
<span class="sd">        group_var : str, optional</span>
<span class="sd">            Group identifier column name in `X` DataFrame. Required if `X` is DataFrame.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments passed to `pymer4.models.Lmer`. Common arguments</span>
<span class="sd">            might include `factors` to specify categorical variables if not auto-detected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : LogisticRandomEffectModel</span>
<span class="sd">            The fitted model instance.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If input data is insufficient or response variable is not binary.</span>
<span class="sd">        ImportError</span>
<span class="sd">            If pymer4 or its dependencies (R, lme4) are not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># _validate_and_convert_inputs is expected to set self.covariate_names_ if X is array</span>
        <span class="c1"># and to return numpy arrays for X_processed, y_processed, groups_processed.</span>
        <span class="n">X_processed</span><span class="p">,</span> <span class="n">y_processed</span><span class="p">,</span> <span class="n">groups_processed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="n">y_var</span><span class="p">,</span> <span class="n">group_var</span><span class="p">,</span> <span class="n">use_dataprep</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># self.covariate_names_ should be set by _validate_and_convert_inputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Covariate names were not properly set during input validation.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure binary response</span>
        <span class="n">unique_y_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_processed</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_y_values</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response variable must be binary (0 or 1). Found unique values: </span><span class="si">{</span><span class="n">unique_y_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Prepare DataFrame for Lmer ---</span>
        <span class="c1"># Use safe column names for formula construction if original names might be problematic</span>
        <span class="c1"># For this example, we assume provided x_vars, y_var, group_var are R-compatible</span>
        <span class="c1"># If not, sanitization would be needed here.</span>
        <span class="n">current_y_var</span> <span class="o">=</span> <span class="n">y_var</span> <span class="k">if</span> <span class="n">y_var</span> <span class="k">else</span> <span class="s1">&#39;outcome_LRE&#39;</span>
        <span class="n">current_x_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span>
        <span class="n">current_group_var</span> <span class="o">=</span> <span class="n">group_var</span> <span class="k">if</span> <span class="n">group_var</span> <span class="k">else</span> <span class="s1">&#39;group_LRE&#39;</span>

        <span class="n">df_for_lmer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_processed</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">current_x_vars</span><span class="p">)</span>
        <span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_y_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_processed</span>
        <span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_group_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups_processed</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_string_dtype</span><span class="p">(</span><span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_group_var</span><span class="p">])</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_group_var</span><span class="p">])):</span>
            <span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_group_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_group_var</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># --- Fit the GLMM using pymer4 ---</span>
        <span class="n">fixed_part</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_x_vars</span><span class="p">)</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_y_var</span><span class="si">}</span><span class="s2"> ~ </span><span class="si">{</span><span class="n">fixed_part</span><span class="si">}</span><span class="s2"> + (1 | </span><span class="si">{</span><span class="n">current_group_var</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting Lmer model with formula: </span><span class="si">{</span><span class="n">formula</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Lmer</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_for_lmer</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;binomial&#39;</span><span class="p">)</span>
            <span class="c1"># Pass summarize=False by default, let summary method handle it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">summarize</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;summarize&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during pymer4 Lmer fitting: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;logfile&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- R Logfile ---&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span> <span class="c1"># Check if fitting actually succeeded</span>
            <span class="n">log_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logfile</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;logfile&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;No logfile available.&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pymer4 model fitting failed. Check R/lme4 installation and model specification. Log: </span><span class="si">{</span><span class="n">log_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_results</span><span class="p">(</span><span class="n">y_processed</span><span class="p">,</span> <span class="n">groups_processed</span><span class="p">,</span> <span class="n">current_x_vars</span><span class="p">,</span> <span class="n">current_y_var</span><span class="p">,</span> <span class="n">current_group_var</span><span class="p">)</span>

        <span class="c1"># --- Calculate fixed-effect linear predictor (X*beta) ---</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;design_matrix&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">design_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">and</span> <span class="s1">&#39;fixed_effect&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">:</span>

            <span class="n">design_matrix_fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">design_matrix</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;fixed_effect&#39;</span><span class="p">]</span> <span class="c1"># Should have &#39;(Intercept)&#39;</span>

            <span class="c1"># Check alignment (more robust check)</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">design_matrix_fe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">fe_params</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                <span class="c1"># Ensure order matches for dot product</span>
                <span class="n">ordered_design_matrix</span> <span class="o">=</span> <span class="n">design_matrix_fe</span><span class="p">[</span><span class="n">fe_params</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exog_fe_</span> <span class="o">=</span> <span class="n">ordered_design_matrix</span> <span class="c1"># Store the aligned design matrix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ordered_design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fe_params</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This warning should ideally not trigger if naming is fixed</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Mismatch between design matrix columns and fixed effect names even after attempting consistency. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Design Matrix cols: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">design_matrix_fe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;FE params index: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">fe_params</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Attempting reconstruction for xbeta.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span>
                <span class="p">)</span>
                <span class="c1"># Fallback reconstruction (less ideal)</span>
                <span class="n">temp_df_for_design</span> <span class="o">=</span> <span class="n">df_for_lmer</span><span class="p">[</span><span class="n">current_x_vars</span><span class="p">]</span>
                <span class="n">fe_param_names</span> <span class="o">=</span> <span class="n">fe_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;(Intercept)&#39;</span> <span class="ow">in</span> <span class="n">fe_param_names</span><span class="p">:</span>
                    <span class="c1"># Use add_constant matching pymer4/lme4 behavior (prepend=True)</span>
                    <span class="n">design_matrix_fe_recon</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">temp_df_for_design</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># Ensure column name is &#39;(Intercept)&#39; to match R default</span>
                    <span class="n">design_matrix_fe_recon</span> <span class="o">=</span> <span class="n">design_matrix_fe_recon</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;const&#39;</span><span class="p">:</span> <span class="s1">&#39;(Intercept)&#39;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">design_matrix_fe_recon</span> <span class="o">=</span> <span class="n">temp_df_for_design</span>

                <span class="c1"># Ensure columns and order match fe_params exactly</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">design_matrix_fe_recon</span> <span class="o">=</span> <span class="n">design_matrix_fe_recon</span><span class="p">[</span><span class="n">fe_param_names</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exog_fe_</span> <span class="o">=</span> <span class="n">design_matrix_fe_recon</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_fe_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fe_params</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                     <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to reconstruct design matrix for xbeta calculation due to missing columns: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. xbeta_ set to zeros.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_processed</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_processed</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not calculate xbeta_ due to missing model components (design_matrix or fixed_effects).&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model fitting complete.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_store_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">y_orig</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">groups_orig</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_vars</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
        <span class="n">y_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">group_var</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store fitted pymer4 Lmer model results in class attributes.</span>
<span class="sd">        </span>
<span class="sd">        Orchestrates the extraction of model components and stores them in</span>
<span class="sd">        standardized class attributes.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_orig : np.ndarray</span>
<span class="sd">            Original response variable array.</span>
<span class="sd">        groups_orig : np.ndarray</span>
<span class="sd">            Original group identifiers array.</span>
<span class="sd">        x_vars : List[str]</span>
<span class="sd">            Names of fixed effect predictors.</span>
<span class="sd">        y_var : str</span>
<span class="sd">            Name of response variable in model data.</span>
<span class="sd">        group_var : str</span>
<span class="sd">            Name of grouping variable in model data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_model</span><span class="p">():</span>
            <span class="k">return</span>
        
        <span class="c1"># Store original data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_original_data</span><span class="p">(</span><span class="n">y_orig</span><span class="p">,</span> <span class="n">y_var</span><span class="p">)</span>
        
        <span class="c1"># Extract model components</span>
        <span class="c1"># Store original data reference (outcome_ is y, endog_ is y from model data)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_original_data</span><span class="p">(</span><span class="n">y_orig</span><span class="p">,</span> <span class="n">y_var</span><span class="p">)</span>

        <span class="c1"># Extract model components (using consistent naming)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_fixed_effects</span><span class="p">()</span> <span class="c1"># Keeps (Intercept)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_random_effects</span><span class="p">(</span><span class="n">group_var</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_variance_components</span><span class="p">()</span>

        <span class="c1"># Calculate fitted values (probabilities, including RE) - THIS IS THE KEY PART</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fitted_values</span><span class="p">()</span> <span class="c1"># Tries fits, predict, R predict</span>

        <span class="c1"># Calculate residuals based on the full fitted values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_residuals</span><span class="p">()</span>

        <span class="c1"># Extract AIC, BIC, LogLik</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_fit_statistics</span><span class="p">()</span>

        <span class="c1"># Process group info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_group_information</span><span class="p">(</span><span class="n">groups_orig</span><span class="p">)</span>

        <span class="c1"># Note: xbeta_ (fixed effects only) is calculated *after* _store_results in the fit method.</span>
        <span class="c1"># _calculate_linear_predictor is removed as its logic is now split/handled elsewhere.</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that the model has been properly fitted&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model is None. Results not stored.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Check for coefs attribute as a proxy for successful fitting summary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;coefs&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coefs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model fitting may have failed or model attributes (like coefs) are missing.&quot;</span><span class="p">)</span>
            <span class="c1"># Check logfile if fit failed</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;logfile&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- R Logfile Snippet ---&quot;</span><span class="p">)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logfile</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">:])</span> <span class="c1"># Print last part of log</span>
                 <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_store_original_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store original outcome and endogenous variable from model data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_orig</span><span class="p">)</span> <span class="c1"># Store original outcome array/series passed to fit</span>

        <span class="c1"># Get endogenous variable from the DataFrame used by pymer4 model if available</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">y_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endog_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_var</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Use the y-variable from the model&#39;s data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to the originally passed y_orig if model.data is not accessible</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endog_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_fixed_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract fixed effects coefficients, keeping &#39;(Intercept)&#39; name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;coefs&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coefs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)}</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="o">=</span> <span class="p">[]</span>
             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not extract fixed effects: model.coefs missing.&quot;</span><span class="p">)</span>
             <span class="k">return</span>

        <span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Ensure it&#39;s a Series of estimates</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Estimate&#39;</span> <span class="ow">in</span> <span class="n">fe_params</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span><span class="p">[</span><span class="s1">&#39;Estimate&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected format for model.coefs: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span><span class="si">}</span><span class="s2">. Cannot extract fixed effects.&quot;</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)}</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="o">=</span> <span class="p">[]</span>
             <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">:</span> <span class="n">fe_params</span><span class="p">}</span>
        <span class="c1"># Covariate names are non-intercept terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fe_params</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">]))</span>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_random_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract random effects (BLUPs) from the model&quot;&quot;&quot;</span>
        <span class="n">extractors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># Method 1: Direct ranef DataFrame with (Intercept) column</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">[</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;ranef&#39;</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="s1">&#39;(Intercept)&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            
            <span class="c1"># Method 2: Direct ranef DataFrame first column</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;ranef&#39;</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            
            <span class="c1"># Method 3: Ranef dictionary format</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">[</span><span class="n">group_var</span><span class="p">][</span><span class="s1">&#39;(Intercept)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;ranef&#39;</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">group_var</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">[</span><span class="n">group_var</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;(Intercept)&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef</span><span class="p">[</span><span class="n">group_var</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            
            <span class="c1"># Method 4: Ranef table format</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">[</span><span class="s1">&#39;Effect&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(Intercept)&#39;</span><span class="p">][</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">[</span><span class="s1">&#39;Effect&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(Intercept)&#39;</span><span class="p">][</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;ranef_table&#39;</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;Effect&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span> <span class="ow">and</span>
                <span class="s1">&#39;Value&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span> <span class="ow">and</span>
                <span class="s1">&#39;Group&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">ranef_table</span><span class="p">[</span><span class="s1">&#39;Effect&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(Intercept)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span>
            <span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">]</span>
        
        <span class="c1"># Try each extractor until one works</span>
        <span class="n">re_blups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">extractor</span> <span class="ow">in</span> <span class="n">extractors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">re_blups</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re_blups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="c1"># Last resort fallback</span>
        <span class="k">if</span> <span class="n">re_blups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not extract random effects. Using empty Series.&quot;</span><span class="p">)</span>
            <span class="n">re_blups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="c1"># Ensure index name and Series name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">re_blups</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">re_blups</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;group_id&#39;</span>
            <span class="n">re_blups</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;random_effect&quot;</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re_blups</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_variance_components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract variance-covariance matrices for fixed and random effects&quot;&quot;&quot;</span>
        <span class="c1"># Fixed effects variance-covariance matrix</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;vcov&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">vcov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fe_vcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">vcov</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to diagonal matrix from SE values</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;coefs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;SE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">se_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="s1">&#39;SE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">fe_vcv_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">se_vals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">fe_vcv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">fe_vcv_diag</span><span class="p">,</span> 
                    <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                    <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot find variance-covariance matrix. Using placeholder.&quot;</span><span class="p">)</span>
                <span class="n">fe_vcv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
                    <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                    <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fe_var_cov&quot;</span><span class="p">:</span> <span class="n">fe_vcv</span><span class="p">}</span>
        
        <span class="c1"># Random effects variance</span>
        <span class="n">extractors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># Method 1: Direct ranef_var attribute</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_var</span><span class="p">[</span><span class="s1">&#39;Var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;ranef_var&#39;</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ranef_var</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;Var&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_var</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> 
                <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">ranef_var</span><span class="o">.</span><span class="n">empty</span>
            <span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            
            <span class="c1"># Method 2: Variance components via varcor</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">varcor</span><span class="p">[</span><span class="s1">&#39;sdcor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;varcor&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">varcor</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;sdcor&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">varcor</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">varcor</span><span class="o">.</span><span class="n">empty</span>
            <span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            
            <span class="c1"># Method 3: Via summary random effects</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Random effects&#39;</span><span class="p">][</span><span class="s1">&#39;Std.Dev.&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;Random effects&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">summary</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Random effects&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span>
                <span class="s1">&#39;Std.Dev.&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Random effects&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">]</span>
        
        <span class="c1"># Try each extractor</span>
        <span class="n">re_var_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">extractor</span> <span class="ow">in</span> <span class="n">extractors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">re_var_est</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;re_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re_var_est</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_fitted_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate fitted values (probabilities) including random effects.</span>
<span class="sd">        Prioritizes direct model outputs, uses predict as fallback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fitted_vals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># --- Method 1: Use model.fits (most direct from pymer4) ---</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;fits&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fits_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fits</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fits_array</span><span class="p">)</span> <span class="c1"># Get length if not known</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fits_array</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_obs</span><span class="p">:</span>
                    <span class="n">fitted_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">fits_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_obs</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using model.fits for fitted values.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length mismatch: model.fits (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fits_array</span><span class="p">)</span><span class="si">}</span><span class="s2">) vs outcome (</span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">). Cannot use model.fits.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing model.fits: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Method 2: Use pymer4&#39;s predict method (corrected call) ---</span>
        <span class="k">if</span> <span class="n">fitted_vals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting fitted values using model.predict().&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Predict on training data, use rfx, disable verification warning</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">pred_type</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="c1"># Get probabilities</span>
                    <span class="n">use_rfx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>         <span class="c1"># Include random effects</span>
                    <span class="n">verify_predictions</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Suppress warning for predicting on training data</span>
                <span class="p">)</span>
                <span class="n">pred_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_array</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_array</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_obs</span><span class="p">:</span>
                     <span class="n">fitted_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pred_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_obs</span><span class="p">])</span>
                     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using model.predict(verify_predictions=False) for fitted values.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length mismatch: model.predict (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pred_array</span><span class="p">)</span><span class="si">}</span><span class="s2">) vs outcome (</span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">). Cannot use model.predict.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Log the actual error from predict</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error using self.model.predict(data=self.model.data, verify_predictions=False): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="c1"># --- Method 3: Use R&#39;s predict function directly (robust fallback) ---</span>
        <span class="k">if</span> <span class="n">fitted_vals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_R_model&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting fitted values using R predict(type=&#39;response&#39;).&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get probabilities directly from R&#39;s predict.glmerMod</span>
                <span class="c1"># Not specifying newdata uses the training data</span>
                <span class="n">r_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_R_model</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;response&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">n_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_predictions</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_predictions</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_obs</span><span class="p">:</span>
                    <span class="n">fitted_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">r_predictions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_obs</span><span class="p">])</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using R predict(type=&#39;response&#39;) for fitted values.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length mismatch: R predict (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">r_predictions</span><span class="p">)</span><span class="si">}</span><span class="s2">) vs outcome (</span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">). Cannot use R predict.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not calculate fitted values from R predict(type=&#39;response&#39;): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Try R predict with type=&#39;link&#39; as a last resort calculation</span>
                <span class="k">if</span> <span class="n">fitted_vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting fitted values using R predict(type=&#39;link&#39;).&quot;</span><span class="p">)</span>
                     <span class="k">try</span><span class="p">:</span>
                         <span class="n">full_linear_predictor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_R_model</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;link&quot;</span><span class="p">))</span>
                         <span class="k">if</span> <span class="n">n_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_linear_predictor</span><span class="p">)</span>
                         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_linear_predictor</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_obs</span><span class="p">:</span>
                              <span class="n">fitted_vals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                                   <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">full_linear_predictor</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">))),</span>
                                   <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">n_obs</span><span class="p">]</span>
                              <span class="p">)</span>
                              <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using R predict(type=&#39;link&#39;) and inverse logit for fitted values.&quot;</span><span class="p">)</span>
                         <span class="k">else</span><span class="p">:</span>
                              <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length mismatch: R predict(link) (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">full_linear_predictor</span><span class="p">)</span><span class="si">}</span><span class="s2">) vs outcome (</span><span class="si">{</span><span class="n">n_obs</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
                     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_link</span><span class="p">:</span>
                          <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not calculate fitted values from R predict(type=&#39;link&#39;): </span><span class="si">{</span><span class="n">e_link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="c1"># --- Final Assignment ---</span>
        <span class="k">if</span> <span class="n">fitted_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="n">fitted_vals</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="c1"># Only log warning if all attempts failed</span>
             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                 <span class="s2">&quot;Could not calculate full fitted values (including random effects) using any method. &quot;</span>
                 <span class="s2">&quot;Check model fitting success and pymer4/R logs. self.fitted_ will be None.&quot;</span>
             <span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate various residuals based on full fitted probabilities.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pearson_residuals_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deviance_residuals_</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Still likely unavailable</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping residual calculation as fitted_ or outcome_ is None.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Ensure alignment (use intersection of indices)</span>
        <span class="n">common_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_index</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">):</span>
             <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index mismatch between outcome (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span><span class="si">}</span><span class="s2">) and fitted (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                              <span class="s2">&quot;Calculating residuals on {len(common_index)} common observations.&quot;</span><span class="p">)</span>

        <span class="n">outcome_aligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>
        <span class="n">fitted_aligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>

        <span class="c1"># Response residuals (raw difference)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">=</span> <span class="n">outcome_aligned</span> <span class="o">-</span> <span class="n">fitted_aligned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;response_residuals&quot;</span>

        <span class="c1"># Pearson residuals (raw / sqrt(variance))</span>
        <span class="c1"># Add small epsilon for numerical stability if fitted values are exactly 0 or 1</span>
        <span class="n">fitted_var</span> <span class="o">=</span> <span class="n">fitted_aligned</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fitted_aligned</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pearson_residuals_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">fitted_var</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pearson_residuals_</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;pearson_residuals&quot;</span>

        <span class="c1"># Deviance residuals for logistic are more complex, usually obtained from R directly</span>
        <span class="c1"># Formula: sign(y - p) * sqrt(-2 * [y*log(p) + (1-y)*log(1-p)])</span>
        <span class="c1"># Requires careful handling of p=0 or p=1 cases.</span>
        <span class="c1"># If pymer4 doesn&#39;t provide them easily, leave as None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviance_residuals_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># try:</span>
        <span class="c1">#     # Attempt to get from R if possible (conceptual)</span>
        <span class="c1">#     if hasattr(self.model, &#39;_R_model&#39;) and hasattr(self.model, &#39;r&#39;):</span>
        <span class="c1">#          dev_res = np.array(self.model.r.residuals(self.model._R_model, type=&quot;deviance&quot;))</span>
        <span class="c1">#          if len(dev_res) == len(common_index):</span>
        <span class="c1">#               self.deviance_residuals_ = pd.Series(dev_res, index=common_index, name=&quot;deviance_residuals&quot;)</span>
        <span class="c1">#          else:</span>
        <span class="c1">#               logging.warning(&quot;Could not get deviance residuals from R (length mismatch).&quot;)</span>
        <span class="c1"># except Exception as e:</span>
        <span class="c1">#      logging.warning(f&quot;Could not get deviance residuals from R: {e}&quot;)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_fit_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract model fit statistics (LogLik, AIC, BIC).&quot;&quot;&quot;</span>
        <span class="c1"># Use getattr for safe access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loglike_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;logLike&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;AIC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;BIC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Convert to float if they are extracted but not already floats</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglike_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglike_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loglike_</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aic_</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bic_</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_group_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups_orig</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process grouping information (unique groups, sizes, indices).&quot;&quot;&quot;</span>
        <span class="c1"># Ensure groups_orig is treated consistently (e.g., as strings if they were converted)</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">groups_orig</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">groups_orig</span><span class="p">):</span>
             <span class="c1"># If original groups were float/numeric and converted to string for R factor:</span>
             <span class="n">groups_processed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">groups_orig</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">groups_processed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups_orig</span><span class="p">)</span> <span class="c1"># Use as is (int or string)</span>

        <span class="c1"># Get unique group identifiers and the index mapping for each observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups_processed</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Count number of observations per unique group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">))</span>

<div class="viewcode-block" id="LogisticRandomEffectModel.predict">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict probabilities for new data using only the fixed effects part of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            DataFrame containing new data for prediction. Must include columns specified</span>
<span class="sd">            in `x_vars` (or the covariates used during fitting if `x_vars` is None).</span>
<span class="sd">        x_vars : list of str, optional</span>
<span class="sd">            Predictor column names in X. If None, uses covariates from the fitted model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Predicted probabilities based on fixed effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;coefs&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before prediction.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input X must be a pandas DataFrame for prediction.&quot;</span><span class="p">)</span>

        <span class="n">fixed_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;fixed_effect&#39;</span><span class="p">]</span>
        
        <span class="c1"># Check if we have &#39;Intercept&#39; in the model</span>
        <span class="n">has_intercept</span> <span class="o">=</span> <span class="s1">&#39;Intercept&#39;</span> <span class="ow">in</span> <span class="n">fixed_effects</span><span class="o">.</span><span class="n">index</span>

        <span class="k">if</span> <span class="n">x_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use stored covariate names (excluding intercept)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot determine covariates for prediction. Fit model or provide x_vars.&quot;</span><span class="p">)</span>
            <span class="n">pred_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_vars</span> <span class="o">=</span> <span class="n">x_vars</span>

        <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pred_vars</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns in prediction data: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X_pred</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">pred_vars</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Prepare design matrix, adding intercept if needed</span>
        <span class="k">if</span> <span class="n">has_intercept</span><span class="p">:</span>
            <span class="c1"># Add an intercept column</span>
            <span class="n">X_pred_design</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_pred</span><span class="p">,</span> <span class="n">has_constant</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
            <span class="c1"># Rename &#39;const&#39; to &#39;Intercept&#39; to match our standardized name</span>
            <span class="n">X_pred_design</span> <span class="o">=</span> <span class="n">X_pred_design</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;const&#39;</span><span class="p">:</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">})</span>
            
            <span class="c1"># Make sure all coefficient names are in the design matrix</span>
            <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">fixed_effects</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X_pred_design</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing columns in design matrix: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Ensure column order matches coefficients</span>
            <span class="n">X_pred_design</span> <span class="o">=</span> <span class="n">X_pred_design</span><span class="p">[</span><span class="n">fixed_effects</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Ensure column order matches if no intercept</span>
            <span class="n">X_pred_design</span> <span class="o">=</span> <span class="n">X_pred</span><span class="p">[</span><span class="n">fixed_effects</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Calculate linear predictor using fixed effects</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">linear_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X_pred_design</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fixed_effects</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating predictions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Check that design matrix and &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;coefficients are compatible.&quot;</span><span class="p">)</span>

        <span class="c1"># Convert to probability using the logistic function (sigmoid)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">linear_pred</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">probabilities</span></div>


<div class="viewcode-block" id="LogisticRandomEffectModel.summary">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
        <span class="n">null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide summary statistics for the fixed effects coefficients (beta).</span>

<span class="sd">        Extracts results from the fitted pymer4 model summary. Uses Z-tests.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        covariates : list or array, optional</span>
<span class="sd">            Subset of fixed effect covariate names to summarize (e.g., [&#39;X1&#39;, &#39;Intercept&#39;]).</span>
<span class="sd">            Defaults to all fixed effects.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for the intervals.</span>
<span class="sd">        null : float, default=0</span>
<span class="sd">            Null hypothesis value (ignored by pymer4 summary, test is vs 0).</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Alternative hypothesis type (ignored by pymer4 summary, p-value is two-sided).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Summary table with columns: &#39;estimate&#39;, &#39;std_error&#39;, &#39;statistic&#39; (Z-score),</span>
<span class="sd">            &#39;p_value&#39;, &#39;ci_lower&#39;, &#39;ci_upper&#39;. Indexed by fixed effect name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;coefs&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before summarizing.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`null` parameter is ignored for summary; pymer4 tests against 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">!=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
             <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`alternative` parameter is ignored for summary; pymer4 provides two-sided p-values.&quot;</span><span class="p">)</span>

        <span class="c1"># pymer4 model.coefs DataFrame usually contains: Estimate, SE, T-stat (or Z-stat), P-val, DF</span>
        <span class="c1"># For GLMM, it&#39;s typically Z-stat and P-values based on Normal approx.</span>
        <span class="n">summary_df_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">coefs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Rename columns for consistency</span>
        <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Estimate&#39;</span><span class="p">:</span> <span class="s1">&#39;estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">:</span> <span class="s1">&#39;std_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Z-stat&#39;</span><span class="p">:</span> <span class="s1">&#39;statistic&#39;</span><span class="p">,</span> <span class="c1"># Check if it&#39;s &#39;T-stat&#39; or &#39;Z-stat&#39; in your pymer4 version</span>
            <span class="s1">&#39;P-val&#39;</span><span class="p">:</span> <span class="s1">&#39;p_value&#39;</span>
        <span class="p">}</span>
        <span class="c1"># Handle potential T-stat column name</span>
        <span class="k">if</span> <span class="s1">&#39;T-stat&#39;</span> <span class="ow">in</span> <span class="n">summary_df_raw</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;Z-stat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">summary_df_raw</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">rename_map</span><span class="p">[</span><span class="s1">&#39;T-stat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;statistic&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Using T-stat from pymer4 summary as statistic.&quot;</span><span class="p">)</span>

        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df_raw</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_map</span><span class="p">)</span>

        <span class="c1"># Calculate CIs using Normal approximation (consistent with Z-stat/P-val)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;estimate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">]</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;estimate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">]</span>

        <span class="c1"># Select and order columns</span>
        <span class="n">final_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">,</span> <span class="s2">&quot;std_error&quot;</span><span class="p">,</span> <span class="s2">&quot;statistic&quot;</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">,</span> <span class="s2">&quot;ci_lower&quot;</span><span class="p">,</span> <span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span>
        <span class="n">missing_final_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">final_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_final_cols</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find expected columns in pymer4 summary: </span><span class="si">{</span><span class="n">missing_final_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="n">final_cols</span><span class="p">]</span>

        <span class="c1"># Format p-value</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;One or more specified covariates not found in fixed effects: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="LogisticRandomEffectModel.calculate_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.calculate_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_standardized_measures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">measure</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;ratio&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate standardized ratios and rates based on predicted random effects (BLUPs).</span>
<span class="sd">        This implementation follows the R function SM_output.logis_re logic.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or array, optional</span>
<span class="sd">            Subset of group IDs. Defaults to all groups in the model.</span>
<span class="sd">        stdz : str or list, default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method(s): &quot;indirect&quot;, &quot;direct&quot;.</span>
<span class="sd">        null : str or float, default=&quot;median&quot;</span>
<span class="sd">            Baseline for random effects comparison:</span>
<span class="sd">            - &#39;median&#39;: uses median BLUP</span>
<span class="sd">            - &#39;mean&#39;: uses weighted mean of BLUPs (weighted by group sizes)</span>
<span class="sd">            - float: uses a user-specified numeric reference level (typically 0.0)</span>
<span class="sd">        measure : str or list, default=[&quot;rate&quot;, &quot;ratio&quot;]</span>
<span class="sd">            Measures to calculate: &quot;rate&quot;, &quot;ratio&quot;, or both.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with DataFrames for &#39;indirect&#39; and/or &#39;direct&#39; measures.</span>
<span class="sd">            Each DataFrame contains columns:</span>
<span class="sd">            - &#39;group_id&#39;</span>
<span class="sd">            - &#39;{stdz}_difference&#39;: Raw difference between group RE and null RE</span>
<span class="sd">            - &#39;{stdz}_ratio&#39;: Ratio of observed to expected (if &quot;ratio&quot; in measure)</span>
<span class="sd">            - &#39;{stdz}_rate&#39;: Standardized rate (if &quot;rate&quot; in measure)</span>
<span class="sd">            - &#39;observed&#39;: For indirect - sum of observed outcomes; for direct - total observed</span>
<span class="sd">            - &#39;expected&#39;: For indirect - sum of expected probs; for direct - total expected under group&#39;s RE</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted with coefficients, fitted values, xbeta, and outcome.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Group information (groups_, group_indices_, group_sizes_) missing.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure stdz and measure are lists</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">measure</span> <span class="o">=</span> <span class="p">[</span><span class="n">measure</span><span class="p">]</span>
            
        <span class="c1"># Validate parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">method</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;stdz&#39; must include &#39;indirect&#39; and/or &#39;direct&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">measure</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;ratio&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;measure&#39; must include &#39;rate&#39; and/or &#39;ratio&#39;.&quot;</span><span class="p">)</span>

        <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>  <span class="c1"># Series indexed by group_id</span>
        <span class="n">group_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span>  <span class="c1"># Array of unique group IDs in fit order</span>
        <span class="n">n_samples_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span>
        
        <span class="c1"># Calculate population rate (percentage)</span>
        <span class="n">total_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">population_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_observed</span> <span class="o">/</span> <span class="n">n_samples_total</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>

        <span class="c1"># Determine null value for random effects</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> 
            <span class="n">re_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">random_effects</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">valid_re</span> <span class="o">=</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">valid_re</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">re_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">valid_re</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span> 
            <span class="n">re_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;null&#39; argument. Use &#39;median&#39;, &#39;mean&#39;, or float.&quot;</span><span class="p">)</span>

        <span class="c1"># Map group ID to its index (0..m-1) and BLUP</span>
        <span class="n">group_to_idx_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">gid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_names</span><span class="p">)}</span>
        <span class="n">group_to_re_map</span> <span class="o">=</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Select groups to process</span>
        <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">current_groups_ids</span> <span class="o">=</span> <span class="n">group_names</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">current_groups_ids</span> <span class="o">=</span> <span class="n">group_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_names</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">group_ids</span><span class="p">))]</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sigmoid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)))</span>

        <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="c1"># Get the full fitted values (including random effects)</span>
            <span class="c1"># These should be the fitted probabilities from the model</span>
            <span class="c1"># Make sure self.fitted_ contains the actual model predicted probabilities</span>
            <span class="n">full_fitted_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span>
            
            <span class="c1"># Get expected probabilities without random effects (null model)</span>
            <span class="n">exp_prob_null</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)</span>
            
            <span class="c1"># Create dataframes to store group-level calculations</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># First pass: collect observed and expected counts by group</span>
            <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">group_names</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">group_to_idx_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span>
                
                <span class="c1"># FIXED: Use fitted values including random effects as &quot;observed&quot;</span>
                <span class="c1"># This matches R&#39;s approach using fit$fitted</span>
                <span class="n">obs_sum</span> <span class="o">=</span> <span class="n">full_fitted_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Sum of fitted probabilities (with RE)</span>
                <span class="n">exp_sum</span> <span class="o">=</span> <span class="n">exp_prob_null</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Sum of expected probabilities (null model)</span>
                
                <span class="n">group_data</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">obs_sum</span><span class="p">,</span>
                    <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">exp_sum</span><span class="p">,</span>
                <span class="p">}</span>
            
            <span class="c1"># Second pass: calculate ratios and rates for requested groups</span>
            <span class="n">indirect_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">current_groups_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">:</span>
                    <span class="k">continue</span>
                    
                <span class="n">obs_sum</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">gid</span><span class="p">][</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span>
                <span class="n">exp_sum</span> <span class="o">=</span> <span class="n">group_data</span><span class="p">[</span><span class="n">gid</span><span class="p">][</span><span class="s2">&quot;expected&quot;</span><span class="p">]</span>
                
                <span class="c1"># Calculate standardized ratio and rate</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">obs_sum</span> <span class="o">/</span> <span class="n">exp_sum</span> <span class="k">if</span> <span class="n">exp_sum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">gid</span><span class="p">,</span>
                    <span class="s2">&quot;indirect_difference&quot;</span><span class="p">:</span> <span class="n">group_to_re_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">-</span> <span class="n">re_null</span><span class="p">,</span>
                    <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">obs_sum</span><span class="p">,</span>
                    <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">exp_sum</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="s2">&quot;ratio&quot;</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;indirect_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span>
                
                <span class="k">if</span> <span class="s2">&quot;rate&quot;</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;indirect_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
                    
                <span class="n">indirect_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">indirect_data</span><span class="p">:</span>
                <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">indirect_data</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indirect_df</span>

        <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="c1"># Direct standardization calculation (this part remains the same)</span>
            <span class="n">direct_data</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">current_groups_ids</span><span class="p">:</span>
                <span class="n">re_k</span> <span class="o">=</span> <span class="n">group_to_re_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re_k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">re_k</span><span class="p">):</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Calculate expected probabilities for all observations using this group&#39;s RE</span>
                <span class="n">exp_prob_k</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">+</span> <span class="n">re_k</span><span class="p">)</span>
                <span class="n">total_expected_k</span> <span class="o">=</span> <span class="n">exp_prob_k</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                
                <span class="c1"># Calculate standardized ratio and rate</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">total_expected_k</span> <span class="o">/</span> <span class="n">total_observed</span> <span class="k">if</span> <span class="n">total_observed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">gid</span><span class="p">,</span>
                    <span class="s2">&quot;direct_difference&quot;</span><span class="p">:</span> <span class="n">re_k</span> <span class="o">-</span> <span class="n">re_null</span><span class="p">,</span>
                    <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">total_observed</span><span class="p">,</span>
                    <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">total_expected_k</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="s2">&quot;ratio&quot;</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;direct_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span>
                
                <span class="k">if</span> <span class="s2">&quot;rate&quot;</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;direct_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
                    
                <span class="n">direct_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">direct_data</span><span class="p">:</span>
                <span class="n">direct_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">direct_data</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_df</span>

        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_blup_post_se</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract posterior standard errors for BLUPs from the underlying lme4 model.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Series</span>
<span class="sd">            Standard errors for the random effect BLUPs, indexed by group IDs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;model_obj&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted with pymer4&#39;s Lmer.&quot;</span><span class="p">)</span>

        <span class="c1"># Access the underlying R model</span>
        <span class="n">r_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_obj</span>

        <span class="c1"># Extract random effects with posterior variances</span>
        <span class="n">ranef_result</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ranef&#39;</span><span class="p">](</span><span class="n">r_model</span><span class="p">,</span> <span class="n">condVar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Assuming one random effect term (e.g., random intercept)</span>
        <span class="n">re_df</span> <span class="o">=</span> <span class="n">ranef_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># First random effect term</span>
        <span class="n">post_var</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">](</span><span class="n">re_df</span><span class="p">,</span> <span class="s1">&#39;postVar&#39;</span><span class="p">)</span>  <span class="c1"># Posterior variances</span>

        <span class="c1"># Convert to numpy array and squeeze to 1D (for random intercept)</span>
        <span class="n">post_var_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">post_var</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Get group IDs from the random effects DataFrame</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="n">re_df</span><span class="o">.</span><span class="n">rownames</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">re_df</span><span class="p">,</span> <span class="s1">&#39;rownames&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">post_var_array</span><span class="p">))</span>

        <span class="c1"># Compute standard errors</span>
        <span class="n">se_blup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">post_var_array</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">se_blup</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;blup_se&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="LogisticRandomEffectModel.calculate_confidence_intervals">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.calculate_confidence_intervals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_confidence_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
        <span class="n">option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">measure</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">],</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate CIs for random effects (BLUPs) or standardized measures.</span>

<span class="sd">        For `option=&#39;alpha&#39;`, it provides approximate CIs for the random effect BLUPs</span>
<span class="sd">        on the log-odds scale.</span>

<span class="sd">        For `option=&#39;SM&#39;`, calculation of robust CIs for standardized ratios/rates</span>
<span class="sd">        from logistic random effects models is complex and not directly implemented here.</span>
<span class="sd">        This method will raise a NotImplementedError for SM CIs, suggesting alternative</span>
<span class="sd">        approaches or consultation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or array, optional</span>
<span class="sd">            Subset of group IDs.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level.</span>
<span class="sd">        option : str, default=&quot;SM&quot;</span>
<span class="sd">            &quot;alpha&quot; for random effects (BLUPs), &quot;SM&quot; for standardized measures.</span>
<span class="sd">        stdz : str or list, default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method(s) if `option=&#39;SM&#39;`.</span>
<span class="sd">        null : str or float, default=0.0</span>
<span class="sd">            Baseline for SM calculation or null for BLUP comparison.</span>
<span class="sd">        measure : str or list, default=[&quot;rate&quot;, &quot;ratio&quot;]</span>
<span class="sd">            Measures for SM if `option=&#39;SM&#39;`.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Interval type. Must be &#39;two_sided&#39; if `option=&#39;alpha&#39;`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            If `option=&#39;alpha&#39;`, returns `{&#39;alpha_ci&#39;: DataFrame}` with BLUP CIs.</span>
<span class="sd">            Raises `NotImplementedError` if `option=&#39;SM&#39;`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If model not fitted or arguments invalid.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If `option=&#39;SM&#39;` is chosen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted with coefficients, variances, and group sizes.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">and</span> <span class="n">alternative</span> <span class="o">!=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Option &#39;alpha&#39; (random effects) only supports two-sided CIs.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;SM&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Option must be &#39;alpha&#39; or &#39;SM&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Calculating robust confidence intervals for standardized ratios/rates &quot;</span>
                <span class="s2">&quot;from logistic random effect models is statistically complex and beyond &quot;</span>
                <span class="s2">&quot;simple transformation of BLUP confidence intervals. This typically requires &quot;</span>
                <span class="s2">&quot;methods like the Delta method on the log/logit scale, or extensive &quot;</span>
                <span class="s2">&quot;bootstrapping of the entire standardization process. &quot;</span>
                <span class="s2">&quot;Please consult with a statistician or consider these advanced methods. &quot;</span>
                <span class="s2">&quot;You can obtain CIs for the random effects (BLUPs) on the log-odds scale &quot;</span>
                <span class="s2">&quot;using option=&#39;alpha&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># --- option == &quot;alpha&quot; ---</span>
        <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
        <span class="n">se_blup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_blup_post_se</span><span class="p">()</span>  <span class="c1"># Use posterior SEs</span>

        <span class="c1"># Compute CI bounds using Normal distribution</span>
        <span class="n">z_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Two-sided critical value</span>
        <span class="n">lower_re_blup</span> <span class="o">=</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">z_value</span> <span class="o">*</span> <span class="n">se_blup</span><span class="o">.</span><span class="n">values</span>
        <span class="n">upper_re_blup</span> <span class="o">=</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">z_value</span> <span class="o">*</span> <span class="n">se_blup</span><span class="o">.</span><span class="n">values</span>

        <span class="n">df_re_ci_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># BLUP</span>
            <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower_re_blup</span><span class="p">,</span>  <span class="c1"># CI lower bound</span>
            <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper_re_blup</span>  <span class="c1"># CI upper bound</span>
        <span class="p">})</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_re_ci</span> <span class="o">=</span> <span class="n">df_re_ci_full</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_re_ci_full</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">group_ids</span><span class="p">))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">df_re_ci</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;alpha_ci&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()}</span>  <span class="c1"># Return empty DF</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_re_ci</span> <span class="o">=</span> <span class="n">df_re_ci_full</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;alpha_ci&quot;</span><span class="p">:</span> <span class="n">df_re_ci</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()}</span></div>


<div class="viewcode-block" id="LogisticRandomEffectModel.test">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="c1"># Changed default null to 0 for RE</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test random effects (BLUPs) for significance against a null value using Z-tests.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or array, optional</span>
<span class="sd">            Subset of group IDs to test. Defaults to all groups.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level (alpha = 1 - level).</span>
<span class="sd">        null : str or float, default=0.0</span>
<span class="sd">            Null hypothesis value for the random effect (&#39;median&#39; BLUP, &#39;mean&#39; BLUP, or float).</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Alternative hypothesis type (&#39;two_sided&#39;, &#39;greater&#39;, &#39;less&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Test results indexed by group ID, with columns &#39;flag&#39;, &#39;p_value&#39;, &#39;stat&#39; (Z-score), &#39;std_error&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted.&quot;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>  <span class="c1"># Series indexed by group_id</span>
        <span class="n">se_blup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_blup_post_se</span><span class="p">()</span>  <span class="c1"># Use posterior SEs</span>

        <span class="c1"># Determine null value</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">re_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">random_effects</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">valid_re</span> <span class="o">=</span> <span class="n">random_effects</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">valid_re</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">re_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">valid_re</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span> <span class="n">re_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;null&#39; argument.&quot;</span><span class="p">)</span>

        <span class="c1"># Compute Z-statistic, handle NaN SE</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">random_effects</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">valid_se</span> <span class="o">=</span> <span class="n">se_blup</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">se_blup</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">z_score</span><span class="p">[</span><span class="n">valid_se</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">random_effects</span><span class="p">[</span><span class="n">valid_se</span><span class="p">]</span> <span class="o">-</span> <span class="n">re_null</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_blup</span><span class="p">[</span><span class="n">valid_se</span><span class="p">]</span>
        <span class="n">zero_se</span> <span class="o">=</span> <span class="n">se_blup</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">se_blup</span> <span class="o">&lt;=</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">z_score</span><span class="p">[</span><span class="n">zero_se</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">random_effects</span><span class="p">[</span><span class="n">zero_se</span><span class="p">]</span> <span class="o">-</span> <span class="n">re_null</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># Calculate p-values using Normal distribution</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">z_score</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">z_score</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Compute p_value and flag based on alternative hypothesis</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z_score</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">z_score</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_value</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; should be one of &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Handle edge cases for p_value</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">p_value</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">p_value</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">z_score</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1"># Convert flag to pandas Series for consistency</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">z_score</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># Create the result DataFrame</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">z_score</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">se_blup</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">random_effects</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;group_id&quot;</span>
        
        <span class="c1"># Filter by group_ids if provided</span>
        <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;group_ids must be a list, array, or Series&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span>
        
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="c1"># --- Plotting Methods ---</span>
<div class="viewcode-block" id="LogisticRandomEffectModel.plot_funnel">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.plot_funnel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_funnel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Funnel plot for Logistic Random Effect Model.</span>

<span class="sd">        Standard funnel plots with control limits based on expected variance</span>
<span class="sd">        are complex to define rigorously for random effect models, especially</span>
<span class="sd">        logistic ones, due to shrinkage and the nature of random effect variance.</span>
<span class="sd">        Consider using plot_provider_effects (caterpillar plot) instead,</span>
<span class="sd">        or plotting BLUPs vs group size/precision without control limits.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            This method is not implemented due to theoretical complexities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Standard funnel plots with control limits are complex for logistic random effect models. &quot;</span>
            <span class="s2">&quot;Consider plot_provider_effects or a custom scatter plot of BLUPs vs precision.&quot;</span>
            <span class="p">)</span></div>

        
<div class="viewcode-block" id="LogisticRandomEffectModel.plot_provider_effects">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.plot_provider_effects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_provider_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>          
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots predicted random effects (BLUPs) with approximate confidence intervals.</span>

<span class="sd">        Uses the `plot_caterpillar` helper function for visualization.</span>
<span class="sd">        Confidence intervals for BLUPs are approximate and based on asymptotic normality.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or array, optional</span>
<span class="sd">            Subset of provider IDs to plot. Defaults to all.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Color points based on significance flags from `self.test()`.</span>
<span class="sd">        null : str or float, default=0.0</span>
<span class="sd">            Null value for flagging random effects (typically 0 for BLUPs).</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to `plot_caterpillar` (e.g., `orientation`,</span>
<span class="sd">            `title`, `figsize`). See `plot_caterpillar` docstring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first.&quot;</span><span class="p">)</span>

        <span class="c1"># Get CIs for BLUPs (option=&#39;alpha&#39;)</span>
        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;alpha_ci&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ci_results</span> <span class="ow">or</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;alpha_ci&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No random effect CI data found. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;alpha_ci&#39;</span><span class="p">]</span> <span class="c1"># Columns: group_id, alpha, lower, upper</span>

        <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">flag_col_name</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">group_ids</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
                                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
                                    <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> 
                                    <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">)</span>
                <span class="c1"># if not test_df.index.name == &#39;group_id&#39;: </span>
                <span class="c1">#     test_df = test_df.set_index(&#39;group_id&#39;)</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate flags. Plotting without flags. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Set defaults for plot_caterpillar</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;plot_title&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider Random Effects&#39;</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># RE are typically centered around 0</span>

        <span class="c1"># Default orientation and labels for plot_caterpillar</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicted Random Effect (Log-Odds Scale)&#39;</span><span class="p">)</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># horizontal</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider&#39;</span><span class="p">)</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicted Random Effect (Log-Odds Scale)&#39;</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orientation</span> <span class="c1"># Add it back</span>

        <span class="c1"># Call plot_caterpillar, it creates its own figure/axes</span>
        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span> 
            <span class="n">estimate_col</span><span class="o">=</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> 
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> 
            <span class="n">flag_col</span><span class="o">=</span><span class="n">flag_col_name</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LogisticRandomEffectModel.plot_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.plot_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_standardized_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot standardized measures for Logistic Random Effect Model.</span>

<span class="sd">        This plot would typically display standardized ratios or rates with their</span>
<span class="sd">        confidence intervals. However, as robust confidence intervals for these</span>
<span class="sd">        standardized measures (derived from logistic random effect models) are</span>
<span class="sd">        not directly implemented in `calculate_confidence_intervals` due to</span>
<span class="sd">        statistical complexity, this plotting method is also not implemented.</span>

<span class="sd">        To visualize provider differences, consider using `plot_provider_effects`</span>
<span class="sd">        to show the random effects (BLUPs) on the log-odds scale with their</span>
<span class="sd">        approximate confidence intervals.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            This method is not implemented because robust CIs for standardized</span>
<span class="sd">            ratios/rates from this model are not provided by the corresponding</span>
<span class="sd">            CI calculation method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Plotting standardized measures with robust CIs is not implemented for &quot;</span>
            <span class="s2">&quot;LogisticRandomEffectModel because the underlying CI calculation for these &quot;</span>
            <span class="s2">&quot;measures is complex. Please use `plot_provider_effects` to visualize &quot;</span>
            <span class="s2">&quot;random effects (BLUPs) on the log-odds scale.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LogisticRandomEffectModel.plot_coefficient_forest">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.plot_coefficient_forest">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_coefficient_forest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
        <span class="n">refline_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#34495E&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">error_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#95A5A6&quot;</span><span class="p">,</span>
        <span class="n">capsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">errorbar_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">errorbar_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Forest Plot of Fixed Effect Coefficients&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Coefficient Estimate (Log-Odds)&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Covariate&quot;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a forest plot of fixed effect coefficients with confidence intervals.</span>

<span class="sd">        Plots each covariate&#39;s coefficient estimate and its confidence interval</span>
<span class="sd">        in a vertical or horizontal layout, with a reference line at a specified value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orientation : {&#39;vertical&#39;,&#39;horizontal&#39;}, default &#39;vertical&#39;</span>
<span class="sd">            &#39;vertical&#39;: covariate names on the y-axis, estimates on the x-axis.</span>
<span class="sd">            &#39;horizontal&#39;: covariate names on the x-axis, estimates on the y-axis.</span>
<span class="sd">        refline_value : float or None, default 0.0</span>
<span class="sd">            Draws a reference line at this value (vertical or horizontal). None disables it.</span>
<span class="sd">        level : float, default 0.95</span>
<span class="sd">            Confidence level for the intervals (e.g., 0.95 for 95% CI).</span>
<span class="sd">        point_color : str, default &quot;#34495E&quot;</span>
<span class="sd">            Color of the coefficient marker.</span>
<span class="sd">        point_alpha : float, default 0.8</span>
<span class="sd">            Opacity of the coefficient marker.</span>
<span class="sd">        edge_color : str or None, default None</span>
<span class="sd">            Edge color of the marker. None for no edge.</span>
<span class="sd">        edge_linewidth : float, default 0</span>
<span class="sd">            Width of the marker edge.</span>
<span class="sd">        point_size : float, default 0.05</span>
<span class="sd">            Scale factor for marker size.</span>
<span class="sd">        error_color : str, default &quot;#95A5A6&quot;</span>
<span class="sd">            Color of the error bars.</span>
<span class="sd">        capsize : float, default 5</span>
<span class="sd">            Cap size for error bars.</span>
<span class="sd">        errorbar_size : float, default 0.5</span>
<span class="sd">            Thickness of the error bar lines.</span>
<span class="sd">        errorbar_alpha : float, default 0.5</span>
<span class="sd">            Opacity of the error bars.</span>
<span class="sd">        line_color : str, default &quot;red&quot;</span>
<span class="sd">            Color of the reference line.</span>
<span class="sd">        line_style : str, default &quot;--&quot;</span>
<span class="sd">            Line style of the reference line.</span>
<span class="sd">        line_size : float, default 0.8</span>
<span class="sd">            Thickness of the reference line.</span>
<span class="sd">        font_size : float, default 12</span>
<span class="sd">            Font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default 10</span>
<span class="sd">            Font size for tick labels.</span>
<span class="sd">        add_grid : bool, default True</span>
<span class="sd">            Whether to draw a light grid.</span>
<span class="sd">        grid_style : str, default &quot;:&quot;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default 0.6</span>
<span class="sd">            Opacity of the grid.</span>
<span class="sd">        remove_top_right_spines : bool, default True</span>
<span class="sd">            Hide the top and right spines.</span>
<span class="sd">        figure_size : tuple, default (10, 6)</span>
<span class="sd">            Size of the figure in inches.</span>
<span class="sd">        plot_title : str, default &quot;Forest Plot of Fixed Effect Coefficients&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        xlab : str, default &quot;Coefficient Estimate (Log-Odds)&quot;</span>
<span class="sd">            Label for the x-axis (or y-axis if horizontal).</span>
<span class="sd">        ylab : str, default &quot;Covariate&quot;</span>
<span class="sd">            Label for the y-axis (or x-axis if horizontal).</span>
<span class="sd">        save_path : str or None, default None</span>
<span class="sd">            File path to save the figure. If None, the plot is shown.</span>
<span class="sd">        dpi : int, default 300</span>
<span class="sd">            Resolution (dots per inch) for saving.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not fitted or if an invalid orientation is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preconditions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting coefficients.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;vertical&#39; or &#39;horizontal&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Use summary method to get CIs based on Normal distribution (Z-scores)</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two_sided&quot;</span><span class="p">)</span> <span class="c1"># Get two-sided CIs</span>

        <span class="c1"># Prepare DataFrame for plot_caterpillar</span>
        <span class="n">coef_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[[</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;ci_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;ci_upper&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Use renamed columns</span>
        <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;covariate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef_df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Positions for plotting</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_df</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Prepare coordinates and errors based on orientation</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">],</span> <span class="n">positions</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">positions</span><span class="p">,</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="c1"># Set up the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>

        <span class="c1"># Draw error bars and points</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">errorbar_size</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                <span class="n">markeredgewidth</span><span class="o">=</span><span class="n">edge_linewidth</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">errorbar_size</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                <span class="n">markeredgewidth</span><span class="o">=</span><span class="n">edge_linewidth</span>
            <span class="p">)</span>

        <span class="c1"># Add reference line</span>
        <span class="k">if</span> <span class="n">refline_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

        <span class="c1"># Set labels, ticks, and grid</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust spines</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># Set title and layout</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Save or show the plot</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogisticRandomEffectModel.plot_residuals">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.plot_residuals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_residuals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">residual_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;deviance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pearson&quot;</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#1F78B4&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Fitted Probabilities&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots residuals versus fitted probabilities for the logistic GLMM.</span>

<span class="sd">        Parameters are as described previously. This method creates its own plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting residuals.&quot;</span><span class="p">)</span>

        <span class="n">residuals_to_plot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">residual_type</span> <span class="o">==</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span>
            <span class="n">residuals_to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span>
            <span class="n">default_ylabel</span> <span class="o">=</span> <span class="s2">&quot;Response Residuals (y - p_hat)&quot;</span>
            <span class="n">default_title</span> <span class="o">=</span> <span class="s2">&quot;Response Residuals vs. Fitted Probabilities&quot;</span>
        <span class="k">elif</span> <span class="n">residual_type</span> <span class="o">==</span> <span class="s2">&quot;pearson&quot;</span><span class="p">:</span>
            <span class="n">residuals_to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pearson_residuals_</span>
            <span class="n">default_ylabel</span> <span class="o">=</span> <span class="s2">&quot;Pearson Residuals&quot;</span>
            <span class="n">default_title</span> <span class="o">=</span> <span class="s2">&quot;Pearson Residuals vs. Fitted Probabilities&quot;</span>
        <span class="k">elif</span> <span class="n">residual_type</span> <span class="o">==</span> <span class="s2">&quot;deviance&quot;</span><span class="p">:</span>
            <span class="n">residuals_to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviance_residuals_</span>
            <span class="n">default_ylabel</span> <span class="o">=</span> <span class="s2">&quot;Deviance Residuals&quot;</span>
            <span class="n">default_title</span> <span class="o">=</span> <span class="s2">&quot;Deviance Residuals vs. Fitted Probabilities&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;residual_type must be &#39;response&#39;, &#39;pearson&#39;, or &#39;deviance&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">residuals_to_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">residual_type</span><span class="si">}</span><span class="s2">&#39; residuals are not available. Ensure they were calculated.&quot;</span><span class="p">)</span>

        <span class="n">plot_ylabel</span> <span class="o">=</span> <span class="n">ylabel</span> <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_ylabel</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="n">title</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_title</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span> <span class="c1"># Create figure/axes internally</span>

        <span class="n">fitted_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span>
        <span class="n">resid_vals</span> <span class="o">=</span> <span class="n">residuals_to_plot</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residuals_to_plot</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="k">else</span> <span class="n">residuals_to_plot</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">fitted_vals</span><span class="p">,</span> <span class="n">resid_vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">plot_ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;Note: Patterns expected due to binary outcome &amp; variance dependency&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        <span class="c1"># No return value</span>

<div class="viewcode-block" id="LogisticRandomEffectModel.plot_qq">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_random_effect.LogisticRandomEffectModel.plot_qq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_qq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Q-Q plot of the deviance residuals for logistic regression.</span>

<span class="sd">        Raises:</span>
<span class="sd">        -------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            This method is not implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;plot_qq is not implemented for LogisticFixedEffectModel. &quot;</span>
            <span class="s2">&quot;Q-Q plots are less meaningful in logistic regression&quot;</span>
            <span class="s2">&quot;Residuals from logistic regression are not expected to be normally distributed&quot;</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kevin He.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>