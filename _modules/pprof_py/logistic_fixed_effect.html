

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pprof_py.logistic_fixed_effect &mdash; pprof_py 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=e46d07af" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pprof_py
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base_model.html">Base Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_fixed_effect_model.html">Linear Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_random_effect_model.html">Linear Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_fixed_effect_model.html">Logistic Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_random_effect_model.html">Logistic Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../direct_vs_indirect_standardization.html">Direct vs. Indirect Standardization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fixed_vs_random_effects.html">Fixed Effects vs. Random Effects Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pprof_py</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pprof_py.logistic_fixed_effect</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pprof_py.logistic_fixed_effect</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">chi2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">root_scalar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fast_poibin</span><span class="w"> </span><span class="kn">import</span> <span class="n">PoiBin</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.base_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.algorithm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SerbinAlgorithm</span><span class="p">,</span> <span class="n">BanAlgorithm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigmoid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">TestMixin</span><span class="p">,</span> <span class="n">PlotMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_caterpillar</span>


<div class="viewcode-block" id="LogisticFixedEffectModel">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LogisticFixedEffectModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">TestMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logistic Regression Model with Fixed Effects.</span>

<span class="sd">    This class implements a logistic regression model with fixed effects for groups (e.g., providers),</span>
<span class="sd">    using custom optimization algorithms (&#39;Serbin&#39; or &#39;Ban&#39;). It supports advanced data preparation</span>
<span class="sd">    via the DataPrep class, estimates coefficients for covariates and group effects, and provides</span>
<span class="sd">    methods for fitting, prediction, and diagnostics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    use_dataprep : bool, default=True</span>
<span class="sd">        Whether to use the DataPrep class for data preparation.</span>
<span class="sd">    screen_providers : bool, default=True</span>
<span class="sd">        Whether to screen providers (groups) during data preparation.</span>
<span class="sd">    log_event_providers : bool, default=True</span>
<span class="sd">        Whether to log event providers during data preparation.</span>
<span class="sd">    cutoff : int, default=10</span>
<span class="sd">        Minimum group size for screening.</span>
<span class="sd">    threshold_cor : float, default=0.9</span>
<span class="sd">        Correlation threshold for multicollinearity checks.</span>
<span class="sd">    threshold_vif : int, default=10</span>
<span class="sd">        Variance Inflation Factor threshold for multicollinearity.</span>
<span class="sd">    algorithm : str, default=&#39;Serbin&#39;</span>
<span class="sd">        Optimization algorithm (&#39;Serbin&#39; or &#39;Ban&#39;).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    algorithm_type : str</span>
<span class="sd">        Optimization algorithm used.</span>
<span class="sd">    coefficients_ : dict</span>
<span class="sd">        Model coefficients: &#39;beta&#39; (covariates), &#39;gamma&#39; (group effects).</span>
<span class="sd">    variances_ : dict</span>
<span class="sd">        Variance-covariance matrices: &#39;beta&#39; (for covariates), &#39;gamma&#39; (for group effects).</span>
<span class="sd">    fitted_ : np.ndarray</span>
<span class="sd">        Fitted probabilities.</span>
<span class="sd">    aic_ : float</span>
<span class="sd">        Akaike Information Criterion.</span>
<span class="sd">    bic_ : float</span>
<span class="sd">        Bayesian Information Criterion.</span>
<span class="sd">    groups_ : np.ndarray</span>
<span class="sd">        Unique group identifiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LogisticFixedEffectModel.__init__">
<a class="viewcode-back" href="../../_autosummary_generated/pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">use_dataprep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">screen_providers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">log_event_providers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">threshold_cor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="n">threshold_vif</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Serbin&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the LogisticFixedEffectModel with data preparation options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        (See class docstring for parameter details)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store data preparation defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_dataprep</span> <span class="o">=</span> <span class="n">use_dataprep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataprep_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;screen_providers&#39;</span><span class="p">:</span> <span class="n">screen_providers</span><span class="p">,</span>
            <span class="s1">&#39;log_event_providers&#39;</span><span class="p">:</span> <span class="n">log_event_providers</span><span class="p">,</span>
            <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">,</span>
            <span class="s1">&#39;threshold_cor&#39;</span><span class="p">:</span> <span class="n">threshold_cor</span><span class="p">,</span>
            <span class="s1">&#39;threshold_vif&#39;</span><span class="p">:</span> <span class="n">threshold_vif</span><span class="p">,</span>
            <span class="s1">&#39;binary_response&#39;</span><span class="p">:</span> <span class="kc">True</span>  <span class="c1"># Enforce binary response for logistic models</span>
        <span class="p">}</span>
        
        <span class="c1"># Validate and set algorithm</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Serbin&#39;</span><span class="p">,</span> <span class="s1">&#39;Ban&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Algorithm must be &#39;Serbin&#39; or &#39;Ban&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span> <span class="o">=</span> <span class="n">algorithm</span>
        
        <span class="c1"># Initialize attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auc_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Store covariate names if provided</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_estimate_variances</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate variances of beta and gamma coefficients for inferential statistics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Variances of beta (covariance matrix) and gamma (diagonal variances).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has not been fitted (i.e., required attributes are None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the model has been fitted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before estimating variances.&quot;</span><span class="p">)</span>

        <span class="c1"># Use precomputed predicted probabilities</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>  <span class="c1"># Ensure numerical stability</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

        <span class="c1"># Number of groups</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span>

        <span class="c1"># Information for gamma: inverse of sum(q) per group</span>
        <span class="n">info_gamma_inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_groups</span><span class="p">)</span>

        <span class="c1"># Cross-information: sum(X * q) per group for each covariate</span>
        <span class="n">info_beta_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_groups</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">])</span>  <span class="c1"># Shape: (n_covariates, n_groups)</span>

        <span class="c1"># Information for beta: X.T @ (q * X)</span>
        <span class="n">info_beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">q</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Variance for beta</span>
        <span class="n">mat_tmp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">info_gamma_inv</span> <span class="o">*</span> <span class="n">info_beta_gamma</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Shape: (n_covariates, n_groups)</span>
        <span class="n">schur_complement</span> <span class="o">=</span> <span class="n">info_beta</span> <span class="o">-</span> <span class="n">info_beta_gamma</span> <span class="o">@</span> <span class="n">mat_tmp1</span>
        <span class="n">info_beta_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">schur_complement</span><span class="p">)</span>
        <span class="n">var_beta</span> <span class="o">=</span> <span class="n">info_beta_inv</span>

        <span class="c1"># Variance for gamma</span>
        <span class="n">quad_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">mat_tmp1</span> <span class="o">@</span> <span class="n">info_beta_inv</span><span class="p">)</span> <span class="o">*</span> <span class="n">mat_tmp1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shape: (n_groups,)</span>
        <span class="n">var_gamma</span> <span class="o">=</span> <span class="n">info_gamma_inv</span> <span class="o">+</span> <span class="n">quad_term</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="n">var_beta</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">var_gamma</span><span class="p">}</span>

<div class="viewcode-block" id="LogisticFixedEffectModel.fit">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">x_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">y_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_dataprep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">screen_providers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_event_providers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">threshold_cor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">threshold_vif</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">bound</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">backtrack</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LogisticFixedEffectModel&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the logistic fixed effect model with enhanced data preparation and variance estimation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : Union[np.ndarray, pd.DataFrame]</span>
<span class="sd">            Covariates or dataset.</span>
<span class="sd">        y : Optional[np.ndarray], default=None</span>
<span class="sd">            Binary response variable.</span>
<span class="sd">        groups : Optional[np.ndarray], default=None</span>
<span class="sd">            Group identifiers.</span>
<span class="sd">        x_vars : Optional[List[str]], default=None</span>
<span class="sd">            Covariate column names if X is a DataFrame.</span>
<span class="sd">        y_var : Optional[str], default=None</span>
<span class="sd">            Response column name if X is a DataFrame.</span>
<span class="sd">        group_var : Optional[str], default=None</span>
<span class="sd">            Group column name if X is a DataFrame.</span>
<span class="sd">        use_dataprep : Optional[bool], default=None</span>
<span class="sd">            Override default data preparation setting.</span>
<span class="sd">        screen_providers : Optional[bool], default=None</span>
<span class="sd">            Override provider screening.</span>
<span class="sd">        log_event_providers : Optional[bool], default=None</span>
<span class="sd">            Override logging of event providers.</span>
<span class="sd">        cutoff : Optional[int], default=None</span>
<span class="sd">            Override cutoff for group size.</span>
<span class="sd">        threshold_cor : Optional[float], default=None</span>
<span class="sd">            Override correlation threshold.</span>
<span class="sd">        threshold_vif : Optional[int], default=None</span>
<span class="sd">            Override VIF threshold.</span>
<span class="sd">        max_iter : int, default=10000</span>
<span class="sd">            Maximum optimization iterations.</span>
<span class="sd">        tol : float, default=1e-5</span>
<span class="sd">            Convergence tolerance.</span>
<span class="sd">        bound : float, default=10.0</span>
<span class="sd">            Bound for group effects.</span>
<span class="sd">        backtrack : bool, default=True</span>
<span class="sd">            Use backtracking line search.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LogisticFixedEffectModel</span>
<span class="sd">            Fitted model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use stored defaults unless overridden</span>
        <span class="n">use_dataprep</span> <span class="o">=</span> <span class="n">use_dataprep</span> <span class="k">if</span> <span class="n">use_dataprep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dataprep</span>
        <span class="n">dataprep_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataprep_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s1">&#39;screen_providers&#39;</span><span class="p">:</span> <span class="n">screen_providers</span><span class="p">,</span>
            <span class="s1">&#39;log_event_providers&#39;</span><span class="p">:</span> <span class="n">log_event_providers</span><span class="p">,</span>
            <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">,</span>
            <span class="s1">&#39;threshold_cor&#39;</span><span class="p">:</span> <span class="n">threshold_cor</span><span class="p">,</span>
            <span class="s1">&#39;threshold_vif&#39;</span><span class="p">:</span> <span class="n">threshold_vif</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataprep_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Store covariate names for later use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="o">=</span> <span class="n">x_vars</span> <span class="k">if</span> <span class="n">x_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Validate and convert inputs</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="n">y_var</span><span class="p">,</span> <span class="n">group_var</span><span class="p">,</span>
            <span class="n">use_dataprep</span><span class="o">=</span><span class="n">use_dataprep</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dataprep_params</span>
        <span class="p">)</span>

        <span class="c1"># Store data attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">)</span>

        <span class="c1"># Prepare data for algorithm</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">X</span><span class="p">))</span>
        <span class="n">y_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prov_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_prov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>
        <span class="n">gamma_prov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))),</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_prov</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Instantiate algorithm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span> <span class="o">==</span> <span class="s1">&#39;Serbin&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">SerbinAlgorithm</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">prov_index</span><span class="p">,</span> <span class="n">n_prov</span><span class="p">,</span> <span class="n">gamma_prov</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span>
                <span class="n">backtrack</span><span class="o">=</span><span class="n">backtrack</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">bound</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">BanAlgorithm</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">prov_index</span><span class="p">,</span> <span class="n">n_prov</span><span class="p">,</span> <span class="n">gamma_prov</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span>
                <span class="n">backtrack</span><span class="o">=</span><span class="n">backtrack</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">bound</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span>
            <span class="p">)</span>

        <span class="c1"># Fit the model</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]}</span>

        <span class="c1"># Compute fitted values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>
        <span class="n">gamma_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">n_prov</span><span class="p">)</span>
        <span class="n">linear_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">+</span> <span class="n">gamma_obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">linear_pred</span><span class="p">)</span>

        <span class="c1"># Compute aic and bic</span>
        <span class="n">neg2Loglkd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">gamma_obs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">linear_pred</span><span class="p">)))</span>
        <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_params</span> <span class="o">+</span> <span class="n">neg2Loglkd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="o">=</span> <span class="n">n_params</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="n">neg2Loglkd</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auc_</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">)</span>

        <span class="c1"># Compute variances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_variances</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="LogisticFixedEffectModel.predict">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict using the LogisticFixedEffect model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like or pd.DataFrame</span>
<span class="sd">            Design matrix (covariates) or complete dataset.</span>
<span class="sd">        groups : array-like or None</span>
<span class="sd">            Group identifiers or None if `group_var` is specified in a DataFrame.</span>
<span class="sd">        x_vars : list of str, optional</span>
<span class="sd">            Column names in X to be used as predictors, required if X is a DataFrame.</span>
<span class="sd">        group_var : str, optional</span>
<span class="sd">            Column name in X to be used as group identifiers, required if X is a DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Predicted probabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model is not fitted. Call &#39;fit&#39; before &#39;predict&#39;.&quot;</span><span class="p">)</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="p">)</span>
        <span class="n">group_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
        <span class="n">xbeta</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">beta</span>
        <span class="n">gamma_obs</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="n">group_indices</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xbeta</span> <span class="o">+</span> <span class="n">gamma_obs</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">predictions</span></div>


<div class="viewcode-block" id="LogisticFixedEffectModel.score">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the accuracy score for the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like or pd.DataFrame</span>
<span class="sd">            Design matrix (covariates) or complete dataset.</span>
<span class="sd">        y : array-like, shape (n_samples,), optional</span>
<span class="sd">            True target values (if X is array-like).</span>
<span class="sd">        groups : array-like, shape (n_samples,), optional</span>
<span class="sd">            Group identifiers (if X is array-like).</span>
<span class="sd">        x_vars : list of str, optional</span>
<span class="sd">            Column names for predictors (if X is a DataFrame).</span>
<span class="sd">        y_var : str, optional</span>
<span class="sd">            Column name for the target variable (if X is a DataFrame).</span>
<span class="sd">        group_var : str, optional</span>
<span class="sd">            Column name for group identifiers (if X is a DataFrame).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Accuracy of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model is not fitted. Call &#39;fit&#39; before &#39;score&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate and convert inputs</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="n">y_var</span><span class="p">,</span> <span class="n">group_var</span><span class="p">)</span>

        <span class="c1"># Generate predictions (assuming predict returns probabilities)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>

        <span class="c1"># Convert probabilities to class labels (adjust threshold if needed)</span>
        <span class="n">y_pred_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_pred</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Compute accuracy</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_pred_class</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="LogisticFixedEffectModel.get_params">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.get_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return model parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Model parameters including coefficients, variances, aic, and bic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">,</span>
            <span class="s2">&quot;variances&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">,</span>
            <span class="s2">&quot;aic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span><span class="p">,</span>
            <span class="s2">&quot;bic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span><span class="p">,</span>
            <span class="s2">&quot;auc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">auc_</span>
        <span class="p">}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_wald_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Wald test for a specific covariate coefficient.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the covariate to test.</span>
<span class="sd">        null : float, default=0</span>
<span class="sd">            Null hypothesis value for the coefficient.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Alternative hypothesis: &quot;two_sided&quot;, &quot;less&quot;, or &quot;greater&quot;.</span>
<span class="sd">        alpha : float, default=0.05</span>
<span class="sd">            Significance level for confidence intervals.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Results including test statistic, p-value, and confidence interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before performing tests.&quot;</span><span class="p">)</span>

        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">se_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">])</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">null</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_beta</span>

        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stat</span><span class="p">)))</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_beta</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_beta</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Alternative must be &#39;two_sided&#39;, &#39;less&#39;, or &#39;greater&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statistic&quot;</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">ci_lower</span><span class="p">,</span>
            <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">ci_upper</span><span class="p">,</span>
            <span class="s2">&quot;alternative&quot;</span><span class="p">:</span> <span class="n">alternative</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_lr_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Likelihood Ratio test for a specific covariate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the covariate to test.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Results including test statistic and p-value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before performing tests.&quot;</span><span class="p">)</span>

        <span class="c1"># Full model log-likelihood</span>
        <span class="n">gamma_obs_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>
        <span class="n">loglik_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">(</span><span class="n">gamma_obs_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>

        <span class="c1"># Fit reduced model excluding the covariate at index</span>
        <span class="n">reduced_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">reduced_model</span> <span class="o">=</span> <span class="n">LogisticFixedEffectModel</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span><span class="p">)</span>
        <span class="n">reduced_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">reduced_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span>
            <span class="n">bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">bound</span><span class="p">,</span>
            <span class="n">backtrack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">backtrack</span>
        <span class="p">)</span>

        <span class="c1"># Reduced model log-likelihood</span>
        <span class="n">gamma_obs_reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">reduced_model</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">reduced_model</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>
        <span class="n">loglik_reduced</span> <span class="o">=</span> <span class="n">reduced_model</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">_loglikelihood</span><span class="p">(</span><span class="n">gamma_obs_reduced</span><span class="p">,</span> <span class="n">reduced_model</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>

        <span class="c1"># Test statistic and p-value</span>
        <span class="n">test_stat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">loglik_full</span> <span class="o">-</span> <span class="n">loglik_reduced</span><span class="p">)</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">test_stat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statistic&quot;</span><span class="p">:</span> <span class="n">test_stat</span><span class="p">,</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_score_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a Score test for a specific covariate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the covariate to test.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Results including test statistic and p-value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before performing tests.&quot;</span><span class="p">)</span>

        <span class="c1"># Fit reduced model excluding the covariate at index</span>
        <span class="n">reduced_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">reduced_model</span> <span class="o">=</span> <span class="n">LogisticFixedEffectModel</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm_type</span><span class="p">)</span>
        <span class="n">reduced_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">reduced_X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span>
            <span class="n">bound</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">bound</span><span class="p">,</span>
            <span class="n">backtrack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">backtrack</span>
        <span class="p">)</span>

        <span class="c1"># Compute probabilities and weights under the reduced model</span>
        <span class="n">gamma_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">reduced_model</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">reduced_model</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">gamma_obs</span> <span class="o">+</span> <span class="n">reduced_X</span> <span class="o">@</span> <span class="n">reduced_model</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

        <span class="c1"># Score for the excluded covariate</span>
        <span class="n">score_excluded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">index</span><span class="p">])</span>

        <span class="c1"># Information components</span>
        <span class="n">info_excluded_excluded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># scalar</span>
        <span class="n">info_excluded_beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">reduced_X</span>   <span class="c1"># (1, p_reduced)</span>
        <span class="n">info_beta</span> <span class="o">=</span> <span class="n">reduced_X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">q</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">reduced_X</span><span class="p">)</span>          <span class="c1"># (p_reduced, p_reduced)</span>

        <span class="c1"># Inverse of the information matrix for beta</span>
        <span class="n">schur_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">info_beta</span><span class="p">)</span>  <span class="c1"># (p_reduced, p_reduced)</span>

        <span class="c1"># Variance of the score</span>
        <span class="n">info_full</span> <span class="o">=</span> <span class="n">info_excluded_excluded</span> <span class="o">-</span> <span class="n">info_excluded_beta</span> <span class="o">@</span> <span class="n">schur_inv</span> <span class="o">@</span> <span class="n">info_excluded_beta</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Test statistic and p-value</span>
        <span class="n">test_stat</span> <span class="o">=</span> <span class="n">score_excluded</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">info_full</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">test_stat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;statistic&quot;</span><span class="p">:</span> <span class="n">test_stat</span><span class="p">,</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

<div class="viewcode-block" id="LogisticFixedEffectModel.summary">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">covariates</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;wald&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides summary statistics for the covariate estimates in a fitted fixed effects model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        covariates : list of str or int, optional</span>
<span class="sd">            Covariate names or indices to include in the summary. If None, </span>
<span class="sd">            all are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        null : float, default=0</span>
<span class="sd">            Null hypothesis value for the coefficient. Used directly for </span>
<span class="sd">            the Wald test. For LR and Score tests, only null=0 is implemented.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Hypothesis type (&quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;) for the Wald test.</span>
<span class="sd">            LR and Score tests are implicitly two-sided for coefficient = 0.</span>
<span class="sd">        test_method : str, default=&quot;wald&quot;</span>
<span class="sd">            Testing approach: &quot;wald&quot;, &quot;lr&quot;, or &quot;score&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Summary statistics with columns:</span>
<span class="sd">            - estimate : coefficient estimate</span>
<span class="sd">            - std_error : standard error (from the variance-covariance matrix)</span>
<span class="sd">            - stat : test statistic (from wald_test, lr_test, or score_test)</span>
<span class="sd">            - p_value : p-value from wald_test, lr_test, or score_test</span>
<span class="sd">            - ci_lower, ci_upper : confidence interval bounds (Wald-based)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not fitted or if &#39;test&#39; is invalid or if </span>
<span class="sd">            &#39;covariates&#39; are mis-specified.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If &#39;null&#39; != 0 for LR/Score (only null=0 is implemented).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ----------------------------------------------------------------------</span>
        <span class="c1"># 1. Ensure the model is fitted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before calling &#39;summary&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Variances are not available. Ensure the model is fully fitted.&quot;</span><span class="p">)</span>

        <span class="c1"># ----------------------------------------------------------------------</span>
        <span class="c1"># 2. Check test validity</span>
        <span class="k">if</span> <span class="n">test_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;wald&quot;</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;test&#39; must be one of &#39;wald&#39;, &#39;lr&#39;, or &#39;score&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># For LR and Score, we only handle null=0</span>
        <span class="k">if</span> <span class="n">test_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">null</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">test_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> test currently only implemented for null=0.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># ----------------------------------------------------------------------</span>
        <span class="c1"># 3. Identify which covariate indices to summarize</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">n_cov</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Covariates can be int indices or string names</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span> <span class="k">for</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">covariates</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;covariates&#39; must be a list of names or indices.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cov</span><span class="p">)</span>

        <span class="c1"># Build the display names (if not provided, generate x0, x1, etc.)</span>
        <span class="n">cov_names</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span>
            <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># ----------------------------------------------------------------------</span>
        <span class="c1"># 4. Prepare containers for summary results</span>
        <span class="n">estimates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">std_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ci_lowers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ci_uppers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Wald-based intervals use alpha = 1 - level</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>

        <span class="c1"># We&#39;ll compute the standard error from the variance matrix</span>
        <span class="c1"># but for &quot;wald&quot; we rely on self._compute_wald_beta() for the official</span>
        <span class="c1"># statistic, p-value, and intervals. For &quot;lr&quot;/&quot;score&quot; we </span>
        <span class="c1"># use that method for stat/p-value, but still give a wald-based</span>
        <span class="c1"># interval for convenience.</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">cov_names</span><span class="p">):</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># Standard error from the diagonal of the covariance matrix</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;wald&quot;</span><span class="p">:</span>
                <span class="c1"># NOTE: wald_test expects alpha, not level</span>
                <span class="n">wald_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_wald_beta</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
                <span class="p">)</span>
                <span class="n">stat_val</span> <span class="o">=</span> <span class="n">wald_res</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">wald_res</span><span class="p">[</span><span class="s2">&quot;p_value&quot;</span><span class="p">]</span>
                <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">wald_res</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">]</span>
                <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">wald_res</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span>
                <span class="c1"># Use the lr_test method for test stat &amp; p-value</span>
                <span class="n">lr_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_lr_beta</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">stat_val</span> <span class="o">=</span> <span class="n">lr_res</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">lr_res</span><span class="p">[</span><span class="s2">&quot;p_value&quot;</span><span class="p">]</span>
                <span class="c1"># Construct Wald-based confidence interval for reference</span>
                <span class="c1"># two-sided intervals only</span>
                <span class="n">zcrit</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">-</span> <span class="n">zcrit</span> <span class="o">*</span> <span class="n">se</span>
                <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">+</span> <span class="n">zcrit</span> <span class="o">*</span> <span class="n">se</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># score</span>
                <span class="n">score_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_score_beta</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">stat_val</span> <span class="o">=</span> <span class="n">score_res</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">score_res</span><span class="p">[</span><span class="s2">&quot;p_value&quot;</span><span class="p">]</span>
                <span class="c1"># Construct Wald-based confidence interval</span>
                <span class="n">zcrit</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">-</span> <span class="n">zcrit</span> <span class="o">*</span> <span class="n">se</span>
                <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">estimate</span> <span class="o">+</span> <span class="n">zcrit</span> <span class="o">*</span> <span class="n">se</span>

            <span class="c1"># Accumulate results for the summary dataframe</span>
            <span class="n">estimates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">estimate</span><span class="p">)</span>
            <span class="n">std_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat_val</span><span class="p">)</span>
            <span class="c1"># Round or format p-values</span>
            <span class="n">p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.7g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ci_lowers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci_lower</span><span class="p">)</span>
            <span class="n">ci_uppers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ci_upper</span><span class="p">)</span>

        <span class="c1"># ----------------------------------------------------------------------</span>
        <span class="c1"># 5. Construct the final DataFrame</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="n">estimates</span><span class="p">,</span>
                <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">std_errors</span><span class="p">,</span>
                <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
                <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_values</span><span class="p">,</span>
                <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">ci_lowers</span><span class="p">,</span>
                <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">ci_uppers</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">index</span><span class="o">=</span><span class="n">cov_names</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">summary_df</span></div>


    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># STANDARDIZED MEASURES</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="LogisticFixedEffectModel.calculate_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.calculate_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_standardized_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdz</span><span class="o">=</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate direct/indirect standardized ratios and rates for a fixed-effects logistic model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider/group IDs for whom to calculate measures. If None,</span>
<span class="sd">            all providers are included.</span>
<span class="sd">        stdz : str or list of str, default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method(s). Must include at least one of {&quot;indirect&quot;, &quot;direct&quot;}.</span>
<span class="sd">        null : {&#39;median&#39;, &#39;mean&#39;} or float, default=&quot;median&quot;</span>
<span class="sd">            Defines the population norm if &quot;direct&quot; standardization is requested. </span>
<span class="sd">            - &#39;median&#39;: uses median(gamma)</span>
<span class="sd">            - &#39;mean&#39;: uses weighted mean(gamma, weights=group_sizes_)</span>
<span class="sd">            - float: uses a user-specified numeric reference level.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary with keys for each requested standardization type:</span>
<span class="sd">            - &#39;indirect&#39; -&gt; DataFrame with columns [&quot;group_id&quot;, &quot;indirect_ratio&quot;, </span>
<span class="sd">            &quot;indirect_rate&quot;, &quot;observed&quot;, &quot;expected&quot;].</span>
<span class="sd">            - &#39;direct&#39; -&gt; DataFrame with columns [&quot;group_id&quot;, &quot;direct_ratio&quot;, </span>
<span class="sd">            &quot;direct_rate&quot;, &quot;observed&quot;, &quot;expected&quot;].</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not deemed fitted or if arguments are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted with stored outcomes, coefficients, and fitted probabilities.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;stdz&#39; must include &#39;indirect&#39; and/or &#39;direct&#39;.&quot;</span><span class="p">)</span>

        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span>

        <span class="c1"># Determine gamma_null if needed</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;null&#39; argument for standardization baseline.&quot;</span><span class="p">)</span>

        <span class="n">selected_groups</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Indirect standardization</span>
        <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="n">expected_prob</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_null</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)))</span>
            <span class="n">expected_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">expected_prob</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">))</span>
            <span class="p">])</span>
            <span class="n">observed_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">))</span>
            <span class="p">])</span>
            <span class="n">indirect_ratio</span> <span class="o">=</span> <span class="n">observed_by_group</span> <span class="o">/</span> <span class="n">expected_by_group</span>
            <span class="n">population_rate</span> <span class="o">=</span> <span class="n">observed_by_group</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="mf">100.0</span>
            <span class="n">indirect_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">indirect_ratio</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>

            <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
                <span class="s2">&quot;indirect_ratio&quot;</span><span class="p">:</span> <span class="n">indirect_ratio</span><span class="p">,</span>
                <span class="s2">&quot;indirect_rate&quot;</span><span class="p">:</span> <span class="n">indirect_rate</span><span class="p">,</span>
                <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">observed_by_group</span><span class="p">,</span>
                <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_by_group</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indirect_df</span>

        <span class="c1"># Direct standardization</span>
        <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="n">obs_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span>
            <span class="n">population_rate</span> <span class="o">=</span> <span class="n">obs_total</span> <span class="o">/</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="mf">100.0</span>

            <span class="n">direct_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">g_val</span> <span class="ow">in</span> <span class="n">gamma</span><span class="p">:</span>  <span class="c1"># each provider&#39;s gamma</span>
                <span class="n">p_temp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">g_val</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)))</span>
                <span class="n">direct_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_temp</span><span class="p">))</span>

            <span class="n">direct_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">direct_preds</span><span class="p">)</span>
            <span class="n">ds_ratio</span> <span class="o">=</span> <span class="n">direct_preds</span> <span class="o">/</span> <span class="n">obs_total</span>
            <span class="n">ds_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ds_ratio</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>

            <span class="n">direct_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
                <span class="s2">&quot;direct_ratio&quot;</span><span class="p">:</span> <span class="n">ds_ratio</span><span class="p">,</span>
                <span class="s2">&quot;direct_rate&quot;</span><span class="p">:</span> <span class="n">ds_rate</span><span class="p">,</span>
                <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">),</span> <span class="n">obs_total</span><span class="p">),</span>
                <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">direct_preds</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">direct_df</span> <span class="o">=</span> <span class="n">direct_df</span><span class="p">[</span><span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_df</span>

        <span class="k">return</span> <span class="n">results</span></div>


    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># BASIC (T-BASED) CI BOUNDS FOR GAMMA</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ci_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">se</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute two-sided or one-sided confidence interval bounds for gamma using a t-distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gamma : np.ndarray</span>
<span class="sd">            Point estimates of provider effects.</span>
<span class="sd">        se : np.ndarray</span>
<span class="sd">            Standard errors for gamma.</span>
<span class="sd">        df : int</span>
<span class="sd">            Degrees of freedom for the t-distribution.</span>
<span class="sd">        level : float</span>
<span class="sd">            Confidence level (e.g., 0.95 for 95% CI).</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type: &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            Lower and upper bounds for the confidence intervals.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If &#39;alternative&#39; is not one of the allowed values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">level</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_search_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">bracket</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">max_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to find a root of &#39;func&#39; within an initial bracket, expanding if necessary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : callable</span>
<span class="sd">            Function for which to find the root.</span>
<span class="sd">        bracket : Tuple[float, float]</span>
<span class="sd">            Initial [left, right] bracket for the root.</span>
<span class="sd">        max_attempts : int, default=3</span>
<span class="sd">            Number of bracket expansions to attempt.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[float]</span>
<span class="sd">            The root if found, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">bracket</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_attempts</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">root_scalar</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">bracket</span><span class="o">=</span><span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bisect&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sol</span><span class="o">.</span><span class="n">root</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">expand_amt</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">left</span> <span class="o">-=</span> <span class="n">expand_amt</span>
            <span class="n">right</span> <span class="o">+=</span> <span class="n">expand_amt</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Root-finding failed after </span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2"> attempts with bracket </span><span class="si">{</span><span class="n">bracket</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_no_all_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a provider has no events or all events.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_idx : int</span>
<span class="sd">            Index of the provider group.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[bool, bool]</span>
<span class="sd">            (no_events, all_events) indicating if the provider has no events or all events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sum_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">group_idx</span><span class="p">])</span>
        <span class="n">gsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sum_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sum_y</span> <span class="o">==</span> <span class="n">gsize</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_score_ci_for_one_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gamma_guess</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute score-based confidence interval for a single provider&#39;s gamma.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_idx : int</span>
<span class="sd">            Provider group index.</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Significance level.</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type: &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.</span>
<span class="sd">        gamma_guess : float</span>
<span class="sd">            Initial guess for gamma.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[float, float]</span>
<span class="sd">            Lower and upper bounds of the confidence interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for no events or all events</span>
        <span class="n">no_events</span><span class="p">,</span> <span class="n">all_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_no_all_events</span><span class="p">(</span><span class="n">group_idx</span><span class="p">)</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">group_idx</span><span class="p">])</span>
        <span class="n">xbeta_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">group_idx</span><span class="p">]</span>

        <span class="n">qnorm_half</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">qnorm_1side</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">upper_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
            <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed</span> <span class="o">-</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">probs</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">score</span> <span class="o">+</span> <span class="p">(</span><span class="n">qnorm_half</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span> <span class="k">else</span> <span class="n">qnorm_1side</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">lower_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
            <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed</span> <span class="o">-</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">probs</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">score</span> <span class="o">-</span> <span class="p">(</span><span class="n">qnorm_half</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span> <span class="k">else</span> <span class="n">qnorm_1side</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">no_events</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">no_events_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
                <span class="n">probs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">qnorm_1side</span> <span class="o">-</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">probs</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">no_events_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">gamma_guess</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_events</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">all_events_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
                <span class="n">probs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
                <span class="k">return</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">probs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">probs</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">probs</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span> <span class="o">-</span> <span class="n">qnorm_1side</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">all_events_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">gamma_guess</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">lower_bound</span> <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">]:</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">upper_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span><span class="p">,</span> <span class="n">gamma_guess</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">]:</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">lower_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span> <span class="o">-</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">gamma_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_exact_ci_for_one_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gamma_guess</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute &#39;exact&#39; CI for a single provider&#39;s gamma using the fast_poibin package.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_idx : int</span>
<span class="sd">            Provider index in [0, M-1].</span>
<span class="sd">        alpha : float</span>
<span class="sd">            1 - confidence level.</span>
<span class="sd">        alternative : {&#39;two_sided&#39;,&#39;greater&#39;,&#39;less&#39;}</span>
<span class="sd">            Specifies the alternative hypothesis.</span>
<span class="sd">        gamma_guess : float</span>
<span class="sd">            An initial guess for gamma.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (float, float)</span>
<span class="sd">            (lower_bound, upper_bound) for this provider&#39;s gamma.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Uses the fast_poibin.PoiBin class for computing PMF and CDF.</span>
<span class="sd">        - For the &quot;mid-p&quot; approach when alternative == &quot;two_sided&quot;, we compute:</span>
<span class="sd">            lower tail: P(X &lt;= obs-1) + 0.5 * P(X=obs) - alpha/2</span>
<span class="sd">            upper tail: P(X &gt;= obs) + 0.5 * P(X=obs) - alpha/2</span>
<span class="sd">                      = (1 - P(X &lt;= obs)) + P(X=obs) + 0.5 * P(X=obs) - alpha/2</span>
<span class="sd">                      = 1 - P(X &lt;= obs-1) - 0.5 * P(X=obs) - alpha/2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for no events or all events</span>
        <span class="n">no_events</span><span class="p">,</span> <span class="n">all_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_no_all_events</span><span class="p">(</span><span class="n">group_idx</span><span class="p">)</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">group_idx</span><span class="p">]))</span>
        <span class="n">xbeta_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">group_idx</span><span class="p">]</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xbeta_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_trials</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Group </span><span class="si">{</span><span class="n">group_idx</span><span class="si">}</span><span class="s2"> has no observations. Returning (-inf, inf).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">no_events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alternative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">upper_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
                <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pvec</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pvec</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">PoiBin</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span>
                <span class="n">alpha_level</span> <span class="o">=</span> <span class="n">alpha</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span> <span class="k">else</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">alpha_level</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">upper_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">gamma_guess</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="k">if</span> <span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alternative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">lower_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
                <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pvec</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pvec</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">PoiBin</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span>
                <span class="n">alpha_level</span> <span class="o">=</span> <span class="n">alpha</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span> <span class="k">else</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span>
                <span class="n">pmf_n</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">[</span><span class="n">n_trials</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_trials</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">return</span> <span class="n">pmf_n</span> <span class="o">-</span> <span class="n">alpha_level</span> <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span> <span class="k">else</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pmf_n</span> <span class="o">-</span> <span class="n">alpha_level</span>

            <span class="n">lower_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">lower_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">gamma_guess</span> <span class="o">+</span> <span class="mf">10.0</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">lower_bound</span> <span class="k">if</span> <span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">upper_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pvec</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pvec</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="n">PoiBin</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">observed</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">observed</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: fast_poibin arrays too short for obs=</span><span class="si">{</span><span class="n">observed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">pmf_obs</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">[</span><span class="n">observed</span><span class="p">]</span>
            <span class="n">cdf_minus_1</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">observed</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">observed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cdf_minus_1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pmf_obs</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cdf_minus_1</span> <span class="o">-</span> <span class="n">alpha</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">lower_func</span><span class="p">(</span><span class="n">gamma</span><span class="p">):</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pvec</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pvec</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="n">PoiBin</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">observed</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">observed</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: fast_poibin arrays too short for obs=</span><span class="si">{</span><span class="n">observed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">pmf_obs</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">[</span><span class="n">observed</span><span class="p">]</span>
            <span class="n">cdf_obs</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">observed</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_obs</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pmf_obs</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
                <span class="n">cdf_minus_1</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">observed</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">observed</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_minus_1</span><span class="p">)</span> <span class="o">-</span> <span class="n">alpha</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">search_interval_half_width</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">]:</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">upper_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span><span class="p">,</span> <span class="n">gamma_guess</span> <span class="o">+</span> <span class="n">search_interval_half_width</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">]:</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_root</span><span class="p">(</span><span class="n">lower_func</span><span class="p">,</span> <span class="p">(</span><span class="n">gamma_guess</span> <span class="o">-</span> <span class="n">search_interval_half_width</span><span class="p">,</span> <span class="n">gamma_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">if</span> <span class="n">lower_bound</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Lower bound </span><span class="si">{</span><span class="n">lower_bound</span><span class="si">}</span><span class="s2"> &gt; Upper bound </span><span class="si">{</span><span class="n">upper_bound</span><span class="si">}</span><span class="s2"> for group </span><span class="si">{</span><span class="n">group_idx</span><span class="si">}</span><span class="s2">. Resetting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_ci_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate arguments for confidence interval calculations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        option : {&#39;gamma&#39;, &#39;SM&#39;}</span>
<span class="sd">            Whether to calculate intervals for provider effects or standardized measures.</span>
<span class="sd">        stdz : str or list</span>
<span class="sd">            Standardization method(s).</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError </span>
<span class="sd">            If arguments are inconsistent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;SM&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;option&#39; must be one of {&#39;gamma&#39;,&#39;SM&#39;}.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span> <span class="ow">and</span> <span class="n">alternative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;option=&#39;gamma&#39; requires &#39;alternative&#39; in {&#39;two_sided&#39;,&#39;greater&#39;,&#39;less&#39;}.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If option=&#39;SM&#39;, &#39;stdz&#39; must include at least one of {&#39;indirect&#39;,&#39;direct&#39;}.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_gamma_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute intervals for all providers&#39; gamma (option=&#39;gamma&#39;), </span>
<span class="sd">        delegating &#39;wald&#39; to _compute_ci_bounds, </span>
<span class="sd">        and &#39;score&#39;/&#39;exact&#39; to specialized logic.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame with columns [&quot;group_id&quot;,&quot;gamma&quot;,&quot;gamma_lower&quot;,&quot;gamma_upper&quot;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">se_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">n_obs</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">level</span>

        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">gamma_est</span> <span class="o">=</span> <span class="n">gamma_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;wald&quot;</span><span class="p">:</span>
                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">inf</span>
                <span class="k">if</span> <span class="n">alternative</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;two_sided&quot;</span><span class="p">,</span> <span class="s2">&quot;less&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">}:</span>
                    <span class="c1"># Reuse _compute_ci_bounds for just *one* provider if we wish</span>
                    <span class="n">g_lower</span><span class="p">,</span> <span class="n">g_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ci_bounds</span><span class="p">(</span>
                        <span class="n">gamma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gamma_est</span><span class="p">]),</span>
                        <span class="n">se</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">se_gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span>
                        <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                        <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span>
                    <span class="p">)</span>
                    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">g_lower</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g_upper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;alternative must be one of {&#39;two_sided&#39;,&#39;less&#39;,&#39;greater&#39;}&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span>
                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_ci_for_one_group</span><span class="p">(</span>
                    <span class="n">group_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span> <span class="n">gamma_guess</span><span class="o">=</span><span class="n">gamma_est</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;exact&quot;</span><span class="p">:</span>
                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exact_ci_for_one_group</span><span class="p">(</span>
                    <span class="n">group_idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span> <span class="n">gamma_guess</span><span class="o">=</span><span class="n">gamma_est</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test_method must be wald, score, exact&quot;</span><span class="p">)</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">gid</span><span class="p">,</span>
                <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma_est</span><span class="p">,</span>
                <span class="s2">&quot;gamma_lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
                <span class="s2">&quot;gamma_upper&quot;</span><span class="p">:</span> <span class="n">upper</span>
            <span class="p">})</span>

        <span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_sm_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">measure</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Factor out the logic for &quot;option=&#39;SM&#39;&quot; to a dedicated helper,</span>
<span class="sd">        returning intervals for indirect/direct ratio/rate. </span>
<span class="sd">        Based on your prior code or the approach from your R function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span>

        <span class="c1"># force measure to list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">measure</span> <span class="o">=</span> <span class="p">[</span><span class="n">measure</span><span class="p">]</span>
        <span class="n">want_ratio</span> <span class="o">=</span> <span class="s2">&quot;ratio&quot;</span> <span class="ow">in</span> <span class="n">measure</span>
        <span class="n">want_rate</span>  <span class="o">=</span> <span class="s2">&quot;rate&quot;</span>  <span class="ow">in</span> <span class="n">measure</span>

        <span class="c1"># get the raw indirect/direct values</span>
        <span class="n">sm_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_standardized_measures</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span>
        <span class="p">)</span>

        <span class="c1"># build gamma CI maps</span>
        <span class="n">df_gamma_ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gamma_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
            <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span>
        <span class="p">)</span>
        <span class="n">gamma_lower_map</span> <span class="o">=</span> <span class="n">df_gamma_ci</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">)[</span><span class="s2">&quot;gamma_lower&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">gamma_upper_map</span> <span class="o">=</span> <span class="n">df_gamma_ci</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">)[</span><span class="s2">&quot;gamma_upper&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">population_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># ---- INDIRECT ----</span>
        <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">sm_data</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">sm_data</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">)</span>

            <span class="c1"># always compute ratio CIs if either ratio OR rate was requested</span>
            <span class="k">if</span> <span class="n">want_ratio</span> <span class="ow">or</span> <span class="n">want_rate</span><span class="p">:</span>
                <span class="n">rl</span><span class="p">,</span> <span class="n">ru</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">:</span>
                        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">);</span> <span class="n">ru</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">);</span> <span class="k">continue</span>
                    <span class="n">gl</span> <span class="o">=</span> <span class="n">gamma_lower_map</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span> <span class="n">gu</span> <span class="o">=</span> <span class="n">gamma_upper_map</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span>
                    <span class="n">expv</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;expected&quot;</span><span class="p">]</span>
                    <span class="n">low_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_logistic_for_provider</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gl</span><span class="p">)</span>
                    <span class="n">up_sum</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_logistic_for_provider</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gu</span><span class="p">)</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low_sum</span><span class="o">/</span><span class="n">expv</span> <span class="k">if</span> <span class="n">expv</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">ru</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up_sum</span> <span class="o">/</span><span class="n">expv</span> <span class="k">if</span> <span class="n">expv</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;ci_ratio_lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;ci_ratio_upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ru</span>

            <span class="c1"># only export the ratio table if they asked for it</span>
            <span class="k">if</span> <span class="n">want_ratio</span><span class="p">:</span>
                <span class="n">df_ratio</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_ratio</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Indirect Standardized Ratio&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">})</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;indirect_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ratio</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># now compute rate, reusing ratio bounds</span>
            <span class="k">if</span> <span class="n">want_rate</span><span class="p">:</span>
                <span class="c1"># make a fresh copy so we don&#39;t clobber df_ratio</span>
                <span class="n">df_rate</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># ci_rate_lower = ci_ratio_lower * pop_rate</span>
                <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_rate_lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                    <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_ratio_lower&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
                <span class="p">)</span>
                <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_rate_upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                    <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_ratio_upper&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
                <span class="p">)</span>
                <span class="n">df_rate</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Indirect Standardized Rate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="s2">&quot;population_rate&quot;</span><span class="p">:</span> <span class="n">population_rate</span>
                <span class="p">})</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;indirect_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># ---- DIRECT ----</span>
        <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">sm_data</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">sm_data</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">want_ratio</span> <span class="ow">or</span> <span class="n">want_rate</span><span class="p">:</span>
                <span class="n">rl</span><span class="p">,</span> <span class="n">ru</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">:</span>
                        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">);</span> <span class="n">ru</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">);</span> <span class="k">continue</span>
                    <span class="n">gl</span> <span class="o">=</span> <span class="n">gamma_lower_map</span><span class="p">[</span><span class="n">gid</span><span class="p">];</span> <span class="n">gu</span> <span class="o">=</span> <span class="n">gamma_upper_map</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span>
                    <span class="n">obs</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span>
                    <span class="n">low_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_logistic_overall</span><span class="p">(</span><span class="n">gl</span><span class="p">)</span>
                    <span class="n">up_sum</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_logistic_overall</span><span class="p">(</span><span class="n">gu</span><span class="p">)</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">low_sum</span><span class="o">/</span><span class="n">obs</span> <span class="k">if</span> <span class="n">obs</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">ru</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">up_sum</span> <span class="o">/</span><span class="n">obs</span> <span class="k">if</span> <span class="n">obs</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;ci_ratio_lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;ci_ratio_upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ru</span>

            <span class="k">if</span> <span class="n">want_ratio</span><span class="p">:</span>
                <span class="n">df_ratio</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_ratio</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Direct Standardized Ratio&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">})</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;direct_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ratio</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">want_rate</span><span class="p">:</span>
                <span class="n">df_rate</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_rate_lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                    <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_ratio_lower&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
                <span class="p">)</span>
                <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_rate_upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                    <span class="n">df_rate</span><span class="p">[</span><span class="s2">&quot;ci_ratio_upper&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">population_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span>
                <span class="p">)</span>
                <span class="n">df_rate</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Direct Standardized Rate&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="s2">&quot;population_rate&quot;</span><span class="p">:</span> <span class="n">population_rate</span>
                <span class="p">})</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;direct_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># finally, turn group_id back into a column</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;group_id&quot;</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_sum_logistic_for_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gamma_val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sum logistic(gamma_val + xbeta_) for the observations belonging to provider gid.&quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="o">==</span> <span class="n">gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">group_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">group_idx</span><span class="p">)</span>
        <span class="n">xbeta_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_val</span> <span class="o">+</span> <span class="n">xbeta_group</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pvals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sum_logistic_overall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma_val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sum logistic(gamma_val + xbeta_) over the entire dataset (for direct approach).&quot;&quot;&quot;</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_val</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pvals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># PUBLIC METHOD TO COMPUTE CONFIDENCE INTERVALS</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="LogisticFixedEffectModel.calculate_confidence_intervals">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.calculate_confidence_intervals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_confidence_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SM&quot;</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">measure</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;ratio&quot;</span><span class="p">),</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exact&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute confidence intervals for either provider effects (option=&quot;gamma&quot;) or</span>
<span class="sd">        standardized measures (option=&quot;SM&quot;) in a logistic fixed-effects model.</span>

<span class="sd">        When option=&quot;gamma&quot;, the method calculates two-sided confidence intervals</span>
<span class="sd">        for each provider&#39;s fixed effect () using a specified test method </span>
<span class="sd">        (&quot;wald&quot;, &quot;score&quot;, or &quot;exact&quot;). The user must supply alternative=&quot;two_sided&quot; </span>
<span class="sd">        if option=&quot;gamma&quot;, and the method ignores any stdz or measure arguments.</span>

<span class="sd">        When option=&quot;SM&quot;, the method produces confidence intervals for indirect or direct</span>
<span class="sd">        standardized measures (ratio and/or rate) at the specified confidence level.</span>
<span class="sd">        It calculates provider-specific  intervals first, then transforms lower/upper</span>
<span class="sd">         bounds into standardized measure intervals. The user must supply stdz  </span>
<span class="sd">        {&quot;indirect&quot;,&quot;direct&quot;} and measure  {&quot;ratio&quot;,&quot;rate&quot;}.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of providers to include. If None, all providers are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level  alpha = 1 - level significance threshold.</span>
<span class="sd">        option : {&#39;gamma&#39;,&#39;SM&#39;}, default=&#39;SM&#39;</span>
<span class="sd">            Type of intervals to compute:</span>
<span class="sd">            - &#39;gamma&#39;: intervals for each provider effect ().</span>
<span class="sd">            - &#39;SM&#39;: intervals for standardized measures (indirect/direct ratio/rate).</span>
<span class="sd">        stdz : {&#39;indirect&#39;,&#39;direct&#39;} or list, default=&#39;indirect&#39;</span>
<span class="sd">            Standardization method(s) to use if option=&quot;SM&quot;. Ignored if option=&quot;gamma&quot;.</span>
<span class="sd">        null : {&#39;median&#39;,&#39;mean&#39;} or float, default=&#39;median&#39;</span>
<span class="sd">            Baseline norm for direct standardization. Ignored if option=&quot;gamma&quot;.</span>
<span class="sd">        measure : {&#39;rate&#39;,&#39;ratio&#39;} or list of these, default=(&#39;rate&#39;,&#39;ratio&#39;)</span>
<span class="sd">            Which standardized measures to produce intervals for if option=&quot;SM&quot;.</span>
<span class="sd">            Ignored if option=&quot;gamma&quot;.</span>
<span class="sd">        alternative : {&#39;two_sided&#39;,&#39;greater&#39;,&#39;less&#39;}, default=&#39;two_sided&#39;</span>
<span class="sd">            Hypothesis direction. Must be &quot;two_sided&quot; if option=&quot;gamma&quot;.</span>
<span class="sd">            If option=&quot;SM&quot;, relevant only for how  intervals are computed in &quot;score&quot; or &quot;exact&quot;.</span>
<span class="sd">        test_method : {&#39;wald&#39;,&#39;score&#39;,&#39;exact&#39;}, default=&#39;wald&#39;</span>
<span class="sd">            Method for computing  intervals. </span>
<span class="sd">            - &#39;wald&#39; uses a t-based approach (via self._compute_ci_bounds).</span>
<span class="sd">            - &#39;score&#39; uses partial derivative root-finding. </span>
<span class="sd">            - &#39;exact&#39; uses Poisson-binomial root-finding logic.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            If option=&quot;gamma&quot;: </span>
<span class="sd">                { &quot;gamma_ci&quot;: DataFrame with columns [group_id, gamma, gamma_lower, gamma_upper] }</span>
<span class="sd">            If option=&quot;SM&quot;: </span>
<span class="sd">                Possibly includes keys:</span>
<span class="sd">                - &quot;indirect_ratio&quot;</span>
<span class="sd">                - &quot;indirect_rate&quot;</span>
<span class="sd">                - &quot;direct_ratio&quot;</span>
<span class="sd">                - &quot;direct_rate&quot;</span>
<span class="sd">            depending on stdz and measure selected.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - By default, if option=&quot;gamma&quot;, the method enforces alternative=&quot;two_sided&quot;.</span>
<span class="sd">        - For option=&quot;SM&quot;, standardization intervals are derived from summing logistic(_lower + X)</span>
<span class="sd">        or logistic(_upper + X), dividing by &quot;expected,&quot; and (for rates) multiplying by the </span>
<span class="sd">        population event rate. </span>
<span class="sd">        - DataFrame .attrs usage:</span>
<span class="sd">        Storing metadata (e.g., &quot;confidence_level&quot;, &quot;description&quot;) in DataFrame.attrs is a</span>
<span class="sd">        convenient way to keep additional information attached without adding columns. This</span>
<span class="sd">        is optional. Some developers prefer returning a separate dictionary for metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted, with valid coefficients_ and variances_.&quot;</span><span class="p">)</span>

        <span class="c1"># Enforce that if option=&quot;gamma&quot;, user must supply two_sided, </span>
        <span class="c1"># and ignore stdz, measure, null</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="c1"># Force the intervals to be two-sided</span>
            <span class="k">if</span> <span class="n">alternative</span> <span class="o">!=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;For option=&#39;gamma&#39;, only two-sided intervals are supported.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># If the user provided stz or measure, that doesn&#39;t make sense here</span>
            <span class="k">if</span> <span class="n">stdz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="c1"># It&#39;s simpler just to ignore them or raise an error:</span>
                <span class="c1"># We&#39;ll raise an error so user doesn&#39;t get confused:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stdz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">stdz</span> <span class="o">!=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For option=&#39;gamma&#39;, stdz is not applicable.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">measure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For option=&#39;gamma&#39;, &#39;measure&#39; is not applicable.&quot;</span><span class="p">)</span>
            
            <span class="c1"># Subset or gather final group IDs</span>
            <span class="n">final_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">]</span>
            <span class="c1"># Compute gamma intervals</span>
            <span class="n">gamma_ci_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gamma_intervals</span><span class="p">(</span>
                <span class="n">group_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_groups</span><span class="p">),</span>
                <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
                <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;gamma_ci&quot;</span><span class="p">:</span> <span class="n">gamma_ci_df</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span><span class="p">:</span>
            <span class="c1"># For standardized measures, we rely on a helper approach</span>
            <span class="c1"># that handles indirect/direct ratio/rate intervals:</span>
            <span class="n">final_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_sm_intervals</span><span class="p">(</span>
                <span class="n">group_ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">final_groups</span><span class="p">),</span>
                <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                <span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span>
                <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
                <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span><span class="p">,</span>
                <span class="n">null</span><span class="o">=</span><span class="n">null</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;option must be either &#39;gamma&#39; or &#39;SM&#39;.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="LogisticFixedEffectModel.test">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">providers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;poibin_exact&quot;</span><span class="p">,</span>
        <span class="n">score_modified</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">n_bootstrap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conduct hypothesis tests on provider effects.</span>

<span class="sd">        Supported test methods:</span>
<span class="sd">        - &quot;poibin_exact&quot;  (exact test using Poisson-binomial DP approach)</span>
<span class="sd">        - &quot;bootstrap_exact&quot; (exact test via bootstrap resampling)</span>
<span class="sd">        - &quot;score&quot;         (score test; can be &quot;modified&quot; or standard)</span>
<span class="sd">        - &quot;wald&quot;          (wald test; disclaim for outlying providers)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        providers : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to test. If None, all providers are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level =&gt; alpha = 1 - level is significance.</span>
<span class="sd">        test_method : {&quot;poibin_exact&quot;,&quot;bootstrap_exact&quot;,&quot;score&quot;,&quot;wald&quot;}, default=&quot;poibin_exact&quot;</span>
<span class="sd">            Which testing approach to use.</span>
<span class="sd">        score_modified : bool, default=True</span>
<span class="sd">            If True, uses a simpler &quot;modified&quot; score approach that does not re-fit </span>
<span class="sd">            restricted models for each provider. If False, you would do the standard </span>
<span class="sd">            approach (placeholder or partial).</span>
<span class="sd">        null : {&quot;median&quot;} or float, default=&quot;median&quot;</span>
<span class="sd">            The null hypothesis value for gamma. If &quot;median&quot;, uses median(gamma_hat).</span>
<span class="sd">            If numeric, that numeric is used instead.</span>
<span class="sd">        n_bootstrap : int, default=10000</span>
<span class="sd">            Resample size for &quot;bootstrap_exact&quot; approach.</span>
<span class="sd">        alternative : {&quot;two_sided&quot;,&quot;greater&quot;,&quot;less&quot;}, default=&quot;two_sided&quot;</span>
<span class="sd">            Direction of test. &quot;two_sided&quot; is default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame with columns [&quot;flag&quot;, &quot;p_value&quot;, &quot;stat&quot;, &quot;std_error&quot;] (if applicable)</span>
<span class="sd">            indexed by provider ID. Also has an attribute &quot;provider_size&quot;.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not fitted or if arguments are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted with valid coefficients_ and variances_.&quot;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">se_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">n_obs</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;null&#39; must be &#39;median&#39; or a numeric value.&quot;</span><span class="p">)</span>

        <span class="n">full_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">providers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="n">providers</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">full_index</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">full_index</span>

        <span class="n">tested_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">size_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;wald&quot;</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_wald_gamma</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">gamma_null</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alternative</span><span class="p">,</span> <span class="n">gamma_vals</span><span class="p">,</span> <span class="n">se_gamma</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_score_gamma</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">gamma_null</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alternative</span><span class="p">,</span> <span class="n">score_modified</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;poibin_exact&quot;</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_poibin_gamma</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">gamma_null</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alternative</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;bootstrap_exact&quot;</span><span class="p">:</span>
            <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_bootstrap_gamma</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">gamma_null</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alternative</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test_method must be one of {&#39;poibin_exact&#39;,&#39;bootstrap_exact&#39;,&#39;score&#39;,&#39;wald&#39;}.&quot;</span><span class="p">)</span>

        <span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">pvals</span><span class="p">,</span>
            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
            <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">se</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">tested_groups</span><span class="p">)</span>
        <span class="n">df_res</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;provider_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">gid</span><span class="p">:</span> <span class="n">size_dict</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">tested_groups</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">df_res</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_wald_gamma</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">gamma_null</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">gamma_vals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">se_gamma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">df</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Wald test for gamma coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : np.ndarray</span>
<span class="sd">            Indices of tested groups.</span>
<span class="sd">        gamma_null : float</span>
<span class="sd">            Null hypothesis value.</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Significance level.</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type (&quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;).</span>
<span class="sd">        gamma_vals : np.ndarray</span>
<span class="sd">            Gamma coefficient values.</span>
<span class="sd">        se_gamma : np.ndarray</span>
<span class="sd">            Standard errors for gamma.</span>
<span class="sd">        df : int</span>
<span class="sd">            Degrees of freedom.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[List[int], List[float], List[float], List[float]]</span>
<span class="sd">            Flags, p-values, test statistics, and standard errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tested_gamma</span> <span class="o">=</span> <span class="n">gamma_vals</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">tested_se</span> <span class="o">=</span> <span class="n">se_gamma</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">wald_stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">tested_gamma</span> <span class="o">-</span> <span class="n">gamma_null</span><span class="p">)</span> <span class="o">/</span> <span class="n">tested_se</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">wald_stat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span> <span class="k">if</span> <span class="n">df</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">wald_stat</span><span class="p">)</span>

        <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wald_stat</span><span class="p">):</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">pr</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;,&#39;greater&#39;,&#39;less&#39;.&quot;</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
            <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tested_se</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_score_gamma</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">gamma_null</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">score_modified</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Score test for gamma coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : np.ndarray</span>
<span class="sd">            Indices of tested groups.</span>
<span class="sd">        gamma_null : float</span>
<span class="sd">            Null hypothesis value.</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Significance level.</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type (&quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;).</span>
<span class="sd">        score_modified : bool</span>
<span class="sd">            Use modified score approach if True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[List[int], List[float], List[float], List[float]]</span>
<span class="sd">            Flags, p-values, test statistics, and standard errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">score_modified</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Standard (unmodified) score test not implemented. Use score_modified=True.&quot;</span><span class="p">)</span>

        <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_null</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)))</span>
        <span class="n">pvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pvec</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g_ind</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">mask_g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">g_ind</span><span class="p">)</span>
            <span class="n">obs_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="n">mask_g</span><span class="p">])</span>
            <span class="n">sum_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvec</span><span class="p">[</span><span class="n">mask_g</span><span class="p">])</span>
            <span class="n">sum_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvec</span><span class="p">[</span><span class="n">mask_g</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pvec</span><span class="p">[</span><span class="n">mask_g</span><span class="p">]))</span>
            <span class="n">zscore</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_count</span> <span class="o">-</span> <span class="n">sum_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sum_var</span><span class="p">)</span> <span class="k">if</span> <span class="n">sum_var</span> <span class="o">&gt;=</span> <span class="mf">1e-14</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="n">p_one_side</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zscore</span><span class="p">))</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">p_one_side</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">p_one_side</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">zscore</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">p_one_side</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;,&#39;greater&#39;,&#39;less&#39;.&quot;</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
            <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_poibin_gamma</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">gamma_null</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Poisson-Binomial exact test for gamma coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : np.ndarray</span>
<span class="sd">            Indices of tested groups.</span>
<span class="sd">        gamma_null : float</span>
<span class="sd">            Null hypothesis value.</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Significance level.</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type (&quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[List[int], List[float], List[float], List[float]]</span>
<span class="sd">            Flags, p-values, test statistics, and standard errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g_ind</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">mask_g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">g_ind</span><span class="p">)</span>
            <span class="n">x_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">[</span><span class="n">mask_g</span><span class="p">]</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_null</span> <span class="o">+</span> <span class="n">x_mat</span><span class="p">)))</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pvec</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="n">mask_g</span><span class="p">]))</span>  <span class="c1"># Convert obs to integer for indexing</span>

            <span class="n">pb</span> <span class="o">=</span> <span class="n">PoiBin</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span>
            <span class="n">cdf_obs</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span> 
            <span class="n">pmf_obs</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">pmf</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span>          
            <span class="n">cdf_obs_minus_1</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">cdf</span><span class="p">[</span><span class="n">obs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>  <span class="c1"># Handle edge case</span>

            <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_obs</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pmf_obs</span>
                <span class="n">zscore</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_obs_minus_1</span> <span class="k">if</span> <span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
                <span class="n">zscore</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="n">cdf_obs</span>
                <span class="n">zscore</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
            <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_bootstrap_gamma</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">gamma_null</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">n_bootstrap</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Bootstrap exact test for gamma coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : np.ndarray</span>
<span class="sd">            Indices of tested groups.</span>
<span class="sd">        gamma_null : float</span>
<span class="sd">            Null hypothesis value.</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Significance level.</span>
<span class="sd">        alternative : str</span>
<span class="sd">            Hypothesis type (&quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;).</span>
<span class="sd">        n_bootstrap : int</span>
<span class="sd">            Number of bootstrap resamples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[List[int], List[float], List[float], List[float]]</span>
<span class="sd">            Flags, p-values, test statistics, and standard errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g_ind</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">mask_g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">g_ind</span><span class="p">)</span>
            <span class="n">x_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">[</span><span class="n">mask_g</span><span class="p">]</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_null</span> <span class="o">+</span> <span class="n">x_mat</span><span class="p">)))</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pvec</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="n">mask_g</span><span class="p">])</span>

            <span class="n">draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_bootstrap</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
            <span class="n">group_size</span> <span class="o">=</span> <span class="n">pvec</span><span class="o">.</span><span class="n">size</span>
            <span class="k">for</span> <span class="n">i_bs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstrap</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">group_size</span><span class="p">)</span>
                <span class="n">draws</span><span class="p">[</span><span class="n">i_bs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">pvec</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                <span class="n">bigger</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">draws</span> <span class="o">&gt;</span> <span class="n">obs</span><span class="p">)</span>
                <span class="n">equal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">draws</span> <span class="o">==</span> <span class="n">obs</span><span class="p">)</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bigger</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">equal</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_bootstrap</span>
                <span class="n">zscore</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">draws</span> <span class="o">&gt;=</span> <span class="n">obs</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_bootstrap</span>
                <span class="n">zscore</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
                <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">draws</span> <span class="o">&lt;=</span> <span class="n">obs</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_bootstrap</span>
                <span class="n">zscore</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="n">pr</span>
                <span class="n">f_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">pr</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;,&#39;greater&#39;,&#39;less&#39;.&quot;</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
            <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span>
            <span class="n">se</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">se</span>

<div class="viewcode-block" id="LogisticFixedEffectModel.plot_funnel">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.plot_funnel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_funnel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="c1"># &quot;score&quot; or &quot;poibin_exact&quot;</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Lower&quot;</span><span class="p">,</span> <span class="s2">&quot;Expected&quot;</span><span class="p">,</span> <span class="s2">&quot;Higher&quot;</span><span class="p">],</span>
        <span class="n">point_colors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#E69F00&quot;</span><span class="p">,</span> <span class="s2">&quot;#56B4E9&quot;</span><span class="p">,</span> <span class="s2">&quot;#009E73&quot;</span><span class="p">],</span>
        <span class="n">point_shapes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">],</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">target_linestyle</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cl_line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">cl_line_styles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#A6CEE3&quot;</span><span class="p">,</span>
        <span class="n">fill_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Funnel Plot (Indirect Standardization)&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Precision&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Indirectly Standardized Ratio (O/E)&quot;</span><span class="p">,</span>
        <span class="n">legend_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;best&#39;</span> <span class="c1"># Location for legend</span>
     <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a funnel plot comparing provider performance (Indirect Ratio O/E).</span>

<span class="sd">        Control limits and point flagging are based on the specified test method</span>
<span class="sd">        (&#39;score&#39; or &#39;poibin_exact&#39;). Precision is calculated as Expected^2 / Variance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        test_method : str, default=&quot;score&quot;</span>
<span class="sd">            Method for flagging and control limits: &quot;score&quot; or &quot;poibin_exact&quot;.</span>
<span class="sd">            &quot;poibin_exact&quot; requires the &#39;poibin&#39; library.</span>
<span class="sd">        null : str or float, default=&quot;median&quot;</span>
<span class="sd">            Baseline for provider effects (gamma) used in null hypothesis calculations.</span>
<span class="sd">            Can be &quot;median&quot; or a specific float value.</span>
<span class="sd">        target : float, default=1.0</span>
<span class="sd">            Reference performance value (target line on the plot).</span>
<span class="sd">        alpha : float or List[float], default=0.05</span>
<span class="sd">            Significance level(s) for control limits (e.g., 0.05 for 95% limits).</span>
<span class="sd">            If a list is provided, multiple limit boundaries will be drawn.</span>
<span class="sd">        labels : List[str], default=[&quot;Lower&quot;, &quot;Expected&quot;, &quot;Higher&quot;]</span>
<span class="sd">            Labels for provider performance categories based on flags (-1, 0, 1).</span>
<span class="sd">        point_colors : List[str]</span>
<span class="sd">            Colors for provider points based on performance flag. Cycles through list.</span>
<span class="sd">        point_shapes : List[str]</span>
<span class="sd">            Marker shapes for provider points based on performance flag. Cycles through list.</span>
<span class="sd">        point_size : float, default=2.0</span>
<span class="sd">            Scaling factor for marker size (base size is typically ~20-50).</span>
<span class="sd">        point_alpha : float, default=0.8</span>
<span class="sd">            Marker transparency (0 to 1).</span>
<span class="sd">        line_size : float, default=0.8</span>
<span class="sd">            Thickness for target and control limit lines.</span>
<span class="sd">        target_linestyle : str, default=&#39;--&#39;</span>
<span class="sd">            Line style for the target reference line (matplotlib style).</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        cl_line_colors : str or List[str], optional</span>
<span class="sd">            Color(s) for the control limit lines. If a list, cycles through alphas. Defaults to &quot;grey&quot;.</span>
<span class="sd">        cl_line_styles : str or List[str], optional</span>
<span class="sd">            Line style(s) for control limits. If None, defaults based on number of alphas.</span>
<span class="sd">            E.g., [&#39;-&#39;, &#39;--&#39;, &#39;:&#39;] for 3 alpha levels.</span>
<span class="sd">        fill_color : str, default=&quot;#A6CEE3&quot;</span>
<span class="sd">            Fill color for the area between the outermost control limits (smallest alpha).</span>
<span class="sd">        fill_alpha : float, default=0.25</span>
<span class="sd">            Transparency of the control limit fill area (0 to 1).</span>
<span class="sd">        edge_color : str or None, default=None</span>
<span class="sd">            Edge color for scatter points. Set to None for no edges.</span>
<span class="sd">        edge_linewidth : float, default=0.5</span>
<span class="sd">             Line width for scatter point edges.</span>
<span class="sd">        add_grid : bool, default=True</span>
<span class="sd">             Whether to add a background grid to the plot.</span>
<span class="sd">        grid_style : str, default=&#39;:&#39;</span>
<span class="sd">             Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default=0.6</span>
<span class="sd">             Transparency for the grid lines.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">             Whether to remove the top and right axis lines (spines) for a cleaner look.</span>
<span class="sd">        figure_size : Tuple[float, float], default=(8, 6)</span>
<span class="sd">            Figure size in inches (width, height).</span>
<span class="sd">        plot_title : str, default=&quot;Funnel Plot (Indirect Standardization)&quot;</span>
<span class="sd">            Title for the plot.</span>
<span class="sd">        xlab : str, default=&quot;Precision (Expected^2 / Variance)&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylab : str, default=&quot;Indirectly Standardized Ratio (O/E)&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">                 legend_location : str, default=&#39;best&#39;</span>
<span class="sd">             Location string for the legend (e.g., &#39;best&#39;, &#39;upper right&#39;, &#39;lower left&#39;,</span>
<span class="sd">             &#39;center left&#39;, &#39;upper center&#39;, &#39;center&#39;, or tuple (x,y)).</span>

<span class="sd">        Raises:</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If model is not fitted, arguments are invalid, or required attributes missing.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># --- Input Validation ---</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted with coefficients, groups, and group sizes.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model requires &#39;outcome_&#39;, &#39;xbeta_&#39;, and &#39;group_indices_&#39; attributes for funnel plot calculations.&quot;</span><span class="p">)</span>
        <span class="n">allowed_tests</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="s2">&quot;poibin_exact&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_tests</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument &#39;test_method&#39; must be one of </span><span class="si">{</span><span class="n">allowed_tests</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;labels&#39; must be a list of three strings.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_colors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_colors</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;point_colors&#39; must be a non-empty list.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_shapes</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_shapes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;point_shapes&#39; must be a non-empty list.&quot;</span><span class="p">)</span>

        <span class="n">a_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">alpha</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;alpha&#39; must be between 0 and 1.&quot;</span><span class="p">)</span>
        <span class="n">alpha_test</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span> <span class="c1"># Use the smallest alpha for flagging</span>

        <span class="c1"># --- Data Preparation ---</span>
        <span class="c1"># 1. Get Standardized Measures &amp; Set Index</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_standardized_measures</span><span class="p">(</span><span class="n">stdz</span><span class="o">=</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sm_results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">):</span>
                 <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length mismatch: std measures (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">) vs groups (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;indirect_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;observed&quot;</span><span class="p">,</span> <span class="s2">&quot;expected&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">):</span> 
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required columns: </span><span class="si">{</span><span class="n">required_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed data prep (std measures). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Calculate Probabilities under Null</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> 
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span> 
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;null&#39; must be &#39;median&#39; or a numeric value.&quot;</span><span class="p">)</span>

        <span class="n">pvec_null_all</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gamma_null</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)))</span>
        <span class="n">pvec_null_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pvec_null_all</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">probs_by_group_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">pvec_null_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">))]</span>

        <span class="c1"># 3. Calculate Variance and Precision</span>
        <span class="n">group_vars_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">probs_by_group_idx</span><span class="p">])</span>
        <span class="n">group_vars_null_clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">group_vars_null</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
        <span class="n">expected_counts_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">probs_by_group_idx</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;expected_null&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_counts_null</span><span class="p">;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;variance_null&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_vars_null</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;variance_null&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;expected_null&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">group_vars_null_clipped</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">max_finite_precision</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]),</span> <span class="s1">&#39;precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">max_finite_precision</span><span class="p">):</span> 
            <span class="n">max_finite_precision</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">max_finite_precision</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 4. Get Flags</span>
        <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha_test</span><span class="p">,</span> <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># --- Calculate Control Limits ---</span>
        <span class="n">limits_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span>
                <span class="n">z_val</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="n">se_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">])</span>
                <span class="n">se_ratio</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">se_ratio</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">control_lower</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">z_val</span> <span class="o">*</span> <span class="n">se_ratio</span><span class="p">;</span> <span class="n">control_upper</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="n">z_val</span> <span class="o">*</span> <span class="n">se_ratio</span>
                <span class="n">limits_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="s2">&quot;control_lower&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">control_lower</span><span class="p">),</span> <span class="s2">&quot;control_upper&quot;</span><span class="p">:</span> <span class="n">control_upper</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">},</span> 
                    <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">limits_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limits_df</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">test_method</span> <span class="o">==</span> <span class="s2">&quot;poibin_exact&quot;</span><span class="p">:</span>
                <span class="n">cl_lower_ratio</span><span class="p">,</span> <span class="n">cl_upper_ratio</span><span class="p">,</span> <span class="n">group_precision_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                     <span class="n">probs_g</span> <span class="o">=</span> <span class="n">probs_by_group_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                     <span class="n">expected_g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g_id</span><span class="p">,</span> <span class="s1">&#39;expected_null&#39;</span><span class="p">]</span>
                     <span class="n">precision_g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">g_id</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">]</span>

                     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs_g</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">expected_g</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                         <span class="n">cl_lower_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                         <span class="n">cl_upper_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">expected_g</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                         <span class="n">group_precision_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_g</span><span class="p">)</span>
                         <span class="k">continue</span>
                     <span class="n">pb</span> <span class="o">=</span> <span class="n">PoiBin</span><span class="p">(</span><span class="n">probs_g</span><span class="p">)</span>
                     <span class="n">o_lower</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                     <span class="n">o_upper</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                     <span class="n">limit_lower</span> <span class="o">=</span> <span class="n">o_lower</span> <span class="o">/</span> <span class="n">expected_g</span>
                     <span class="n">limit_upper</span> <span class="o">=</span> <span class="n">o_upper</span> <span class="o">/</span> <span class="n">expected_g</span>
                     <span class="n">cl_lower_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_lower</span><span class="p">)</span> 
                     <span class="n">cl_upper_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_upper</span><span class="p">)</span>
                     <span class="n">group_precision_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision_g</span><span class="p">)</span>
                <span class="n">limits_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">group_precision_list</span><span class="p">,</span> <span class="s2">&quot;control_lower&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cl_lower_ratio</span><span class="p">),</span> <span class="s2">&quot;control_upper&quot;</span><span class="p">:</span> <span class="n">cl_upper_ratio</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">},</span> 
                    <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">limits_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limits_df</span><span class="p">)</span>
        <span class="n">limits_all_alphas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">limits_list</span><span class="p">)</span>

        <span class="c1"># --- Plotting ---</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>

        <span class="c1"># Plot control limits</span>
        <span class="n">limits_all_alphas</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">)</span>
        <span class="n">outer_alpha</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="c1"># Define line styles and colors (ensure enough styles/colors for alphas)</span>
        <span class="k">if</span> <span class="n">cl_line_styles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">default_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
            <span class="n">num_alphas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
            <span class="n">cl_line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_styles</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_styles</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_alphas</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_line_styles</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">cl_line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_line_styles</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cl_line_colors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_line_colors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">cl_line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_line_colors</span> <span class="ow">or</span> <span class="s1">&#39;grey&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="n">sorted_alphas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
        <span class="n">style_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_alphas</span><span class="p">,</span> <span class="n">cl_line_styles</span><span class="p">))</span>
        <span class="n">color_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_alphas</span><span class="p">,</span> <span class="n">cl_line_colors</span><span class="p">))</span>

        <span class="c1"># Store handles and labels for legend creation later</span>
        <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Plot fill for outermost limit - ADD LEGEND ENTRY</span>
        <span class="n">outer_limits</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">outer_alpha</span><span class="p">]</span>
        <span class="n">label_outer_ci</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">outer_alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span>
        <span class="n">fill_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                                      <span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> 
                                      <span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">],</span>
                                      <span class="n">color</span><span class="o">=</span><span class="n">fill_color</span><span class="p">,</span> 
                                      <span class="n">alpha</span><span class="o">=</span><span class="n">fill_alpha</span><span class="p">,</span> 
                                      <span class="n">label</span><span class="o">=</span><span class="n">label_outer_ci</span><span class="p">)</span> <span class="c1"># Label for fill</span>
        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_handle</span><span class="p">)</span>
        <span class="n">legend_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_outer_ci</span><span class="p">)</span>

        <span class="c1"># Plot lines for all limits</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sorted_alphas</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">]</span>
            <span class="n">line_label</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">outer_alpha</span><span class="p">:</span> <span class="c1"># Only label inner CI lines</span>
                 <span class="n">line_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span>

            <span class="c1"># Plot lines, store handle only if labeled</span>
            <span class="n">line_lower</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                                  <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span>
                                  <span class="n">linestyle</span><span class="o">=</span><span class="n">style_map</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> 
                                  <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> 
                                  <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">,</span> 
                                  <span class="n">label</span><span class="o">=</span><span class="n">line_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">],</span> <span class="c1"># Upper line doesn&#39;t need label</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="n">style_map</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line_label</span><span class="p">:</span> <span class="c1"># If we added a label, store the handle</span>
                 <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_lower</span><span class="p">)</span>
                 <span class="n">legend_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_label</span><span class="p">)</span>

        <span class="c1"># Plot target line - NO LABEL</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">target_linestyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span> <span class="c1"># No label</span>

        <span class="c1"># Plot provider points - ADD LEGEND ENTRIES</span>
        <span class="n">present_flags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">flag_map</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span> <span class="c1"># Map flag to index in labels/colors/shapes</span>

        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">present_flags</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flag</span><span class="p">]</span>
            <span class="n">label_idx</span> <span class="o">=</span> <span class="n">flag_map</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
            <span class="n">point_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">label_idx</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="c1"># Plot points and store the handle for the legend</span>
            <span class="n">scatter_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                                        <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;indirect_ratio&quot;</span><span class="p">],</span>
                                        <span class="n">marker</span><span class="o">=</span><span class="n">point_shapes</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_shapes</span><span class="p">)],</span>
                                        <span class="n">color</span><span class="o">=</span><span class="n">point_colors</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_colors</span><span class="p">)],</span>
                                        <span class="n">s</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                                        <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                                        <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                        <span class="n">label</span><span class="o">=</span><span class="n">point_label</span><span class="p">)</span> <span class="c1"># Use label here</span>
            <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter_handle</span><span class="p">)</span>
            <span class="n">legend_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_label</span><span class="p">)</span>


        <span class="c1"># --- Final Touches &amp; Prettier Plot ---</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>

        <span class="c1"># Set Axis Limits</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_y_points</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;indirect_ratio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_y_cl</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">max_y_points</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">max_y_points</span><span class="p">)</span> <span class="k">else</span> <span class="n">target</span><span class="p">,</span> <span class="n">max_y_cl</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">max_y_cl</span><span class="p">)</span> <span class="k">else</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="p">(</span><span class="n">max_x</span> <span class="o">*</span> <span class="mf">1.05</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">max_x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Add Grid</span>
        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span> <span class="c1"># Lighter grid color</span>

        <span class="c1"># Remove Spines</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># Create Legend using collected handles and labels (automatically handles duplicates)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> 
                  <span class="n">labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span>
                  <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> 
                  <span class="n">loc</span><span class="o">=</span><span class="n">legend_location</span><span class="p">)</span> <span class="c1"># Add a title to legend</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="LogisticFixedEffectModel.plot_provider_effects">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.plot_provider_effects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_provider_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;wald&#39;</span><span class="p">,</span>
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot provider-specific effects (gamma) with confidence intervals in a caterpillar plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to plot. If None, all providers are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        test_method : str, default=&#39;wald&#39;</span>
<span class="sd">            Method for computing intervals: &#39;wald&#39;, &#39;score&#39;, or &#39;exact&#39;.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Whether to color-code providers based on flags from the test method.</span>
<span class="sd">        null : str or float, default=&#39;median&#39;</span>
<span class="sd">            Null hypothesis for gamma in the test method.</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to plot_caterpillar (e.g., title, point_color).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first.&quot;</span><span class="p">)</span>

        <span class="c1"># 1) Compute gammaCIs</span>
        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">option</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span>
            <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;gamma_ci&#39;</span><span class="p">]</span>

        <span class="c1"># 2) Merge in flags based on the same `null`</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                <span class="n">providers</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span><span class="p">,</span>
                <span class="n">null</span><span class="o">=</span><span class="n">null</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">)</span>

        <span class="c1"># 3) Figure out what null really is</span>
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span>   <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`null` must be &#39;median&#39;, &#39;mean&#39;, or a numeric value&quot;</span><span class="p">)</span>

        <span class="c1"># 4) Orientation &amp; axislabels</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="s1">&#39;horizontal&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;vertical&#39; or &#39;horizontal&#39;&quot;</span><span class="p">)</span>

        <span class="n">est_label</span> <span class="o">=</span> <span class="s2">&quot;Gamma Estimate&quot;</span>
        <span class="n">grp_label</span> <span class="o">=</span> <span class="s2">&quot;Provider&quot;</span>

        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">xlab</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="n">est_label</span><span class="p">)</span>
            <span class="n">ylab</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xlab</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">)</span>
            <span class="n">ylab</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="n">est_label</span><span class="p">)</span>

        <span class="c1"># 5) Use gamma_null as the default refline</span>
        <span class="n">refline_value</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="n">gamma_null</span><span class="p">)</span>

        <span class="c1"># 6) Fire off the caterpillar</span>
        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">estimate_col</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span>
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="s1">&#39;gamma_lower&#39;</span><span class="p">,</span>
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="s1">&#39;gamma_upper&#39;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span>
            <span class="n">flag_col</span><span class="o">=</span><span class="s1">&#39;flag&#39;</span> <span class="k">if</span> <span class="n">use_flags</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
            <span class="n">refline_value</span><span class="o">=</span><span class="n">refline_value</span><span class="p">,</span>
            <span class="n">xlab</span><span class="o">=</span><span class="n">xlab</span><span class="p">,</span>
            <span class="n">ylab</span><span class="o">=</span><span class="n">ylab</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider Effects (Gamma)&#39;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>

        
<div class="viewcode-block" id="LogisticFixedEffectModel.plot_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.plot_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_standardized_measures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;indirect&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span>
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot standardized measures (e.g., indirect ratio or rate) with confidence intervals in a caterpillar plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to plot. If None, all providers are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        stdz : str, default=&#39;indirect&#39;</span>
<span class="sd">            Standardization method: &#39;indirect&#39; or &#39;direct&#39;.</span>
<span class="sd">        measure : str, default=&#39;ratio&#39;</span>
<span class="sd">            Measure to plot: &#39;rate&#39; or &#39;ratio&#39;.</span>
<span class="sd">        test_method : str, default=&#39;score&#39;</span>
<span class="sd">            Method for computing intervals: &#39;wald&#39;, &#39;score&#39;, or &#39;exact&#39;.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Whether to color-code providers based on flags from the test method.</span>
<span class="sd">        null : str or float, default=&#39;median&#39;</span>
<span class="sd">            Null hypothesis for gamma in the test method.</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to plot_caterpillar (e.g., title, point_color).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first.&quot;</span><span class="p">)</span>

        <span class="c1"># Compute SMCIs</span>
        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">option</span><span class="o">=</span><span class="s1">&#39;SM&#39;</span><span class="p">,</span>
            <span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span>
            <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span>
            <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span><span class="p">,</span>
            <span class="n">null</span><span class="o">=</span><span class="n">null</span>
        <span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ci_results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid combination: stdz=&#39;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">&#39;, measure=&#39;</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Determine default refline:</span>
        <span class="c1">#  - ratios  1</span>
        <span class="c1">#  - rates   population_rate (stored in df.attrs by _compute_sm_intervals)</span>
        <span class="n">refline_value</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">refline_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                <span class="n">refline_value</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;rate&#39;</span><span class="p">:</span>
                <span class="n">refline_value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;population_rate&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Merge in flags if desired</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                <span class="n">providers</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span>
                <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                <span class="n">test_method</span><span class="o">=</span><span class="n">test_method</span><span class="p">,</span>
                <span class="n">null</span><span class="o">=</span><span class="n">null</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span>
                        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span>
                        <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Orientation</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="s1">&#39;horizontal&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;vertical&#39; or &#39;horizontal&#39;&quot;</span><span class="p">)</span>


        <span class="c1"># Axislabels</span>
        <span class="n">est_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">measure</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">grp_label</span> <span class="o">=</span> <span class="s2">&quot;Provider&quot;</span>

        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="n">est_label</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xlabel&#39;</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ylabel&#39;</span><span class="p">,</span> <span class="n">est_label</span><span class="p">)</span>

        <span class="c1"># Plot</span>
        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">estimate_col</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ci_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s2">_lower&quot;</span><span class="p">,</span>
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ci_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s2">_upper&quot;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span>
            <span class="n">flag_col</span><span class="o">=</span><span class="s1">&#39;flag&#39;</span> <span class="k">if</span> <span class="n">use_flags</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
            <span class="n">refline_value</span><span class="o">=</span><span class="n">refline_value</span><span class="p">,</span>
            <span class="n">xlab</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
            <span class="n">ylab</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
            <span class="n">plot_title</span><span class="o">=</span><span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                <span class="s1">&#39;title&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Standardized </span><span class="si">{</span><span class="n">measure</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LogisticFixedEffectModel.plot_coefficient_forest">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.plot_coefficient_forest">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_coefficient_forest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
        <span class="n">refline_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#34495E&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">error_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#95A5A6&quot;</span><span class="p">,</span>
        <span class="n">capsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">errorbar_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">errorbar_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Forest Plot of Covariate Coefficients&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Coefficient Estimate&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Covariate&quot;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a forest plot of covariate coefficients with 95% confidence intervals.</span>

<span class="sd">        Plots each covariate&#39;s coefficient estimate and its confidence interval</span>
<span class="sd">        in a vertical or horizontal layout, with a reference line at a specified value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orientation : {&#39;vertical&#39;,&#39;horizontal&#39;}, default &#39;vertical&#39;</span>
<span class="sd">            &#39;vertical&#39;: covariate names on the y-axis, estimates on the x-axis.</span>
<span class="sd">            &#39;horizontal&#39;: covariate names on the x-axis, estimates on the y-axis.</span>
<span class="sd">        refline_value : float or None, default 0.0</span>
<span class="sd">            Draws a reference line at this value (vertical or horizontal). None disables it.</span>
<span class="sd">        point_color : str, default &quot;#34495E&quot;</span>
<span class="sd">            Color of the coefficient marker.</span>
<span class="sd">        point_alpha : float, default 0.8</span>
<span class="sd">            Opacity of the coefficient marker.</span>
<span class="sd">        edge_color : str or None, default None</span>
<span class="sd">            Edge color of the marker. None for no edge.</span>
<span class="sd">        edge_linewidth : float, default 0</span>
<span class="sd">            Width of the marker edge.</span>
<span class="sd">        point_size : float, default 0.5</span>
<span class="sd">            Scale factor for marker size.</span>
<span class="sd">        error_color : str, default &quot;#95A5A6&quot;</span>
<span class="sd">            Color of the error bars.</span>
<span class="sd">        capsize : float, default 5</span>
<span class="sd">            Cap size for error bars.</span>
<span class="sd">        errorbar_size : float, default 0.5</span>
<span class="sd">            Thickness of the error bar lines.</span>
<span class="sd">        errorbar_alpha : float, default 0.5</span>
<span class="sd">            Opacity of the error bars.</span>
<span class="sd">        line_color : str, default &quot;red&quot;</span>
<span class="sd">            Color of the reference line.</span>
<span class="sd">        line_style : str, default &quot;--&quot;</span>
<span class="sd">            Line style of the reference line.</span>
<span class="sd">        line_size : float, default 0.8</span>
<span class="sd">            Thickness of the reference line.</span>
<span class="sd">        font_size : float, default 12</span>
<span class="sd">            Font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default 10</span>
<span class="sd">            Font size for tick labels.</span>
<span class="sd">        add_grid : bool, default True</span>
<span class="sd">            Whether to draw a light grid.</span>
<span class="sd">        grid_style : str, default &quot;:&quot;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default 0.6</span>
<span class="sd">            Opacity of the grid.</span>
<span class="sd">        remove_top_right_spines : bool, default True</span>
<span class="sd">            Hide the top and right spines.</span>
<span class="sd">        figure_size : tuple, default (10, 6)</span>
<span class="sd">            Size of the figure in inches.</span>
<span class="sd">        plot_title : str, default &quot;Forest Plot of Covariate Coefficients&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        xlab : str, default &quot;Coefficient Estimate&quot;</span>
<span class="sd">            Label for the x-axis (or y-axis if horizontal).</span>
<span class="sd">        ylab : str, default &quot;Covariate&quot;</span>
<span class="sd">            Label for the y-axis (or x-axis if horizontal).</span>
<span class="sd">        save_path : str or None, default None</span>
<span class="sd">            File path to save the figure. If None, the plot is shown.</span>
<span class="sd">        dpi : int, default 300</span>
<span class="sd">            Resolution (dots per inch) for saving.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not fitted or if an invalid orientation is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preconditions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting coefficients.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;vertical&#39; or &#39;horizontal&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Compute estimates and 95% CIs</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">se_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]))</span>
        <span class="n">df_denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
        <span class="n">crit</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df_denom</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit</span> <span class="o">*</span> <span class="n">se_beta</span>

        <span class="n">coef_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;covariate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
                <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
                <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">upper</span>
            <span class="p">})</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;estimate&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Positions</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_df</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Prepare coordinates and errors</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">],</span> <span class="n">positions</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">positions</span><span class="p">,</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="c1"># Plot setup</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>

        <span class="c1"># Draw errorbars and points</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span>
            <span class="p">)</span>

        <span class="c1"># Reference line</span>
        <span class="k">if</span> <span class="n">refline_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

        <span class="c1"># Labels, ticks, grid</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>

        <span class="c1"># Spines</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># Title &amp; layout</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Save or show</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


       
<div class="viewcode-block" id="LogisticFixedEffectModel.plot_residuals">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.plot_residuals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot residuals versus fitted probabilities for logistic regression.</span>

<span class="sd">        Raises:</span>
<span class="sd">        -------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            This method is not implemented as residuals are not computed by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;plot_residuals is not implemented for LogisticFixedEffectModel. &quot;</span>
            <span class="s2">&quot;Residual diagnostics are less standard in logistic regression and &quot;</span>
            <span class="s2">&quot;residuals are not computed by default in this model.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LogisticFixedEffectModel.plot_qq">
<a class="viewcode-back" href="../../api.html#pprof_py.logistic_fixed_effect.LogisticFixedEffectModel.plot_qq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_qq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Q-Q plot of the deviance residuals for logistic regression.</span>

<span class="sd">        Raises:</span>
<span class="sd">        -------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            This method is not implemented as residuals are not computed by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;plot_qq is not implemented for LogisticFixedEffectModel. &quot;</span>
            <span class="s2">&quot;Q-Q plots are less meaningful in logistic regression and &quot;</span>
            <span class="s2">&quot;residuals are not computed by default in this model.&quot;</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kevin He.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>