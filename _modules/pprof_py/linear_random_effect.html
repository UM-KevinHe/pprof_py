

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pprof_py.linear_random_effect &mdash; pprof_py 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=e46d07af" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pprof_py
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base_model.html">Base Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_fixed_effect_model.html">Linear Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_random_effect_model.html">Linear Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_fixed_effect_model.html">Logistic Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_random_effect_model.html">Logistic Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../direct_vs_indirect_standardization.html">Direct vs. Indirect Standardization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fixed_vs_random_effects.html">Fixed Effects vs. Random Effects Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pprof_py</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pprof_py.linear_random_effect</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pprof_py.linear_random_effect</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.base_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">,</span> <span class="n">TestMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_caterpillar</span>



<div class="viewcode-block" id="LinearRandomEffectModel">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LinearRandomEffectModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">,</span> <span class="n">TestMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Linear Random Effect Model.</span>

<span class="sd">    The Linear Random Effect Model is a linear regression model that incorporates</span>
<span class="sd">    random effects using a mixed-effects framework (via statsmodels&#39; MixedLM).</span>
<span class="sd">    It estimates both fixed effects and random effects. The model can be fitted</span>
<span class="sd">    using either a formula-based interface (with a DataFrame of variables) or by</span>
<span class="sd">    providing separate design matrices and vectors. This class provides methods</span>
<span class="sd">    for model fitting, prediction, generating summary statistics, confidence</span>
<span class="sd">    intervals, hypothesis tests, and various diagnostic plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : array-like or pd.DataFrame, optional</span>
<span class="sd">        Design matrix (or complete dataset) containing covariates. If a DataFrame is provided,</span>
<span class="sd">        then &#39;x_vars&#39; and &#39;group_var&#39; must be specified.</span>
<span class="sd">    y : array-like or pd.Series, optional</span>
<span class="sd">        Response variable (if not provided via y_var when X is a DataFrame).</span>
<span class="sd">    groups : array-like or pd.Series, optional</span>
<span class="sd">        Group identifiers for random effects (if not provided via group_var when X is a DataFrame).</span>
<span class="sd">    x_vars : list of str, optional</span>
<span class="sd">        Column names in X to be used as predictors (required if X is a DataFrame).</span>
<span class="sd">    y_var : str, optional</span>
<span class="sd">        Column name in X to be used as the response variable.</span>
<span class="sd">    group_var : str, optional</span>
<span class="sd">        Column name in X to be used as group identifiers.</span>
<span class="sd">    formula : str, optional</span>
<span class="sd">        A formula specifying the model. Used when both formula and data are provided.</span>
<span class="sd">    data : pd.DataFrame, optional</span>
<span class="sd">        DataFrame containing the variables used in the formula.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional keyword arguments to be passed to statsmodels&#39; MixedLM.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : statsmodels.regression.mixed_linear_model.MixedLM or None</span>
<span class="sd">        The mixed-effects model instance.</span>
<span class="sd">    result : MixedLMResults or None</span>
<span class="sd">        The fitted model results.</span>
<span class="sd">    coefficients_ : dict</span>
<span class="sd">        Dictionary containing model coefficients:</span>
<span class="sd">            - fixed_effect: Fixed effects estimates.</span>
<span class="sd">            - random_effect: Random effects estimates (converted to a pandas Series).</span>
<span class="sd">    variances_ : dict</span>
<span class="sd">        Dictionary containing variance matrices:</span>
<span class="sd">            - fe_var_cov: Variance-covariance matrix of fixed effects.</span>
<span class="sd">            - re_var: Variance (or covariance matrix) of random effects.</span>
<span class="sd">    fitted_ : np.ndarray or pd.Series</span>
<span class="sd">        Fitted values from the model.</span>
<span class="sd">    residuals_ : np.ndarray or pd.Series</span>
<span class="sd">        Residuals from the model.</span>
<span class="sd">    sigma_ : float</span>
<span class="sd">        Estimated standard deviation of the residuals.</span>
<span class="sd">    aic_ : float</span>
<span class="sd">        Akaike Information Criterion for the model.</span>
<span class="sd">    bic_ : float</span>
<span class="sd">        Bayesian Information Criterion for the model.</span>
<span class="sd">    groups_ : np.ndarray</span>
<span class="sd">        Unique group identifiers.</span>
<span class="sd">    group_indices_ : np.ndarray</span>
<span class="sd">        Array mapping each observation to a group index.</span>
<span class="sd">    group_sizes_ : np.ndarray</span>
<span class="sd">        Number of observations per group.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; data = pd.DataFrame({</span>
<span class="sd">    ...     &#39;y&#39;: [1, 2, 3, 4, 5, 6],</span>
<span class="sd">    ...     &#39;x1&#39;: [1, 0, 1, 0, 1, 0],</span>
<span class="sd">    ...     &#39;x2&#39;: [0, 1, 0, 1, 0, 1],</span>
<span class="sd">    ...     &#39;group&#39;: [1, 1, 2, 2, 3, 3]</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; model = LinearRandomEffectModel()</span>
<span class="sd">    &gt;&gt;&gt; # Using a DataFrame input:</span>
<span class="sd">    &gt;&gt;&gt; model.fit(data, x_vars=[&#39;x1&#39;, &#39;x2&#39;], y_var=&#39;y&#39;, group_var=&#39;group&#39;)</span>
<span class="sd">    &gt;&gt;&gt; # model fitting complete.</span>
<span class="sd">    &gt;&gt;&gt; predictions = model.predict(data[[&#39;x1&#39;, &#39;x2&#39;]])</span>
<span class="sd">    &gt;&gt;&gt; print(predictions)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LinearRandomEffectModel.__init__">
<a class="viewcode-back" href="../../_autosummary_generated/pprof_py.linear_random_effect.LinearRandomEffectModel.html#pprof_py.linear_random_effect.LinearRandomEffectModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the LinearRandomEffectModel.</span>
<span class="sd">        Prepares placeholders for the model and its results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sm</span><span class="o">.</span><span class="n">regression</span><span class="o">.</span><span class="n">mixed_linear_model</span><span class="o">.</span><span class="n">MixedLMResults</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.fit">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">y_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">use_reml</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LinearRandomEffectModel&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the random effect linear model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : Optional[pd.DataFrame]</span>
<span class="sd">            Design matrix (or complete dataset) containing covariates.</span>
<span class="sd">            If a DataFrame is provided, then &#39;x_vars&#39; and &#39;group_var&#39; must be specified.</span>
<span class="sd">        y : Optional[pd.Series]</span>
<span class="sd">            Response variable (if not provided via y_var in a DataFrame).</span>
<span class="sd">        groups : Optional[pd.Series]</span>
<span class="sd">            Group identifiers for random effects (if not provided via group_var in a DataFrame).</span>
<span class="sd">        x_vars : Optional[list]</span>
<span class="sd">            Column names in X to be used as predictors (required if X is a DataFrame).</span>
<span class="sd">        y_var : Optional[str]</span>
<span class="sd">            Column name in X to be used as the response variable.</span>
<span class="sd">        group_var : Optional[str]</span>
<span class="sd">            Column name in X to be used as group identifiers.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments for statsmodels&#39; MixedLM.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : LinearRandomEffectModel</span>
<span class="sd">            The fitted model instance.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If neither a DataFrame (with x_vars and group_var) nor separate X, y, and groups are provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate and convert inputs.</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="n">y_var</span><span class="p">,</span> <span class="n">group_var</span><span class="p">)</span>
        
        <span class="c1"># Convert X to a DataFrame (if it isn&#39;t one already) and ensure the needed columns are there.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Ensure that the response and group columns are present.</span>
        <span class="n">df</span><span class="p">[</span><span class="n">y_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">df</span><span class="p">[</span><span class="n">group_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups</span>

        <span class="c1"># # (Optional) sort by group to mimic R&#39;s ordering.</span>
        <span class="c1"># df = df.sort_values(by=group_var)</span>
        
        <span class="c1"># Build a formula string.</span>
        <span class="c1"># This automatically adds an intercept unless you remove it (e.g., &quot;y ~ 0 + x1 + x2 + ...&quot;).</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y_var</span><span class="si">}</span><span class="s2"> ~ &quot;</span> <span class="o">+</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x_vars</span><span class="p">)</span>
        
        <span class="c1"># Fit the mixed effects model using the formula interface.</span>
        <span class="c1"># Note: The groups argument here must be the actual group labels (not the column name),</span>
        <span class="c1"># so we pass the appropriate column from the DataFrame.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">MixedLM</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">group_var</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">reml</span><span class="o">=</span><span class="n">use_reml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_results</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
        
        <span class="c1"># Calculate the fixed-effect linear predictor.</span>
        <span class="c1"># This uses the fixed effects coefficients and the design matrix for fixed effects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model fitting complete.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_store_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the results from the fitted model in class attributes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - y: pd.Series</span>
<span class="sd">            The response variable used in fitting the model.</span>
<span class="sd">        - groups: pd.Series</span>
<span class="sd">            The group identifiers used in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert random effects (a dict) to a Series (assume random intercept model).</span>
        <span class="n">re_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">))</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">random_effects</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fixed_effect&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fe_params</span><span class="p">,</span>
            <span class="s2">&quot;random_effect&quot;</span><span class="p">:</span> <span class="n">re_series</span>
        <span class="p">}</span>

        <span class="n">fixed_effect_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fe_params</span><span class="o">.</span><span class="n">index</span>
        <span class="n">fe_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fixed_effect_names</span><span class="p">,</span> <span class="n">fixed_effect_names</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fe_var_cov&quot;</span><span class="p">:</span> <span class="n">fe_cov</span><span class="p">,</span>
            <span class="s2">&quot;re_var&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">cov_re</span>  <span class="c1"># For a random intercept model, a 1x1 matrix.</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fittedvalues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="c1"># REML residual std dev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">aic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">bic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">)</span>

<div class="viewcode-block" id="LinearRandomEffectModel.predict">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">x_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict outcomes for new data using the fitted model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - X: pd.DataFrame</span>
<span class="sd">            DataFrame containing new data for prediction. Variables must match those in the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - predictions: np.ndarray</span>
<span class="sd">            Array of predicted values based on the fitted model.</span>
<span class="sd">        - x_vars : Optional[list]</span>
<span class="sd">            Column names in X to be used as predictors (required if X is a DataFrame).</span>
<span class="sd">        Raises:</span>
<span class="sd">        - ValueError: If the model has not been fitted prior to prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X cannot be None for prediction.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Assume the same covariate names as during training.</span>
                <span class="n">x_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">x_vars</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ensure_2d</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="k">return</span> <span class="n">predictions</span></div>

    
        
<div class="viewcode-block" id="LinearRandomEffectModel.summary">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">covariates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide summary statistics for the fixed effects in the model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - covariates: Optional[Union[list, np.ndarray]]</span>
<span class="sd">            Subset of covariates for which summary statistics are provided. Defaults to all.</span>
<span class="sd">        - level: float, default=0.95</span>
<span class="sd">            Confidence level for the intervals.</span>
<span class="sd">        - null: float, default=0</span>
<span class="sd">            Null hypothesis value for the parameter estimates.</span>
<span class="sd">        - alternative: str, default=&quot;two_sided&quot;</span>
<span class="sd">            The alternative hypothesis (&quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;).</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - summary_df: pd.DataFrame</span>
<span class="sd">            A DataFrame with columns:</span>
<span class="sd">              - estimate</span>
<span class="sd">              - std_error</span>
<span class="sd">              - stat</span>
<span class="sd">              - p_value</span>
<span class="sd">              - ci_lower</span>
<span class="sd">              - ci_upper</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model must be fitted before summarizing.&quot;</span><span class="p">)</span>
        
        <span class="n">fe_estimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span>
        <span class="n">se_fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;fe_var_cov&quot;</span><span class="p">]))</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">fe_estimates</span> <span class="o">-</span> <span class="n">null</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_fe</span>
        
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fe_estimates</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="n">m</span>  <span class="c1"># consistent with fixed_effect model</span>
        
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">))</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">fe_estimates</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_fe</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">fe_estimates</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_fe</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">fe_estimates</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_fe</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">level</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">fe_estimates</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se_fe</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;argument &#39;alternative&#39; should be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>
        
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="n">fe_estimates</span><span class="p">,</span>
            <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">se_fe</span><span class="p">,</span>
            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">ci_lower</span><span class="p">,</span>
            <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">ci_upper</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">fe_estimates</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;argument &#39;covariates&#39; should be a list or array of covariate names or indices.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary_df</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.calculate_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.calculate_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_standardized_measures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span> 
        <span class="n">null</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate direct/indirect standardized differences for the random effect model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : Optional[Union[list, np.ndarray]]</span>
<span class="sd">            Specifies a subset of providers (groups) for which the measures are calculated.</span>
<span class="sd">            Defaults to all providers.</span>
<span class="sd">        stdz : Union[str, list], default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method(s); can be &quot;indirect&quot;, &quot;direct&quot;, or both.</span>
<span class="sd">        null : Union[str, float], default=&quot;median&quot;</span>
<span class="sd">            Baseline norm used for standardization; can be &quot;median&quot;, &quot;mean&quot;, or a specific numeric value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary containing DataFrames of standardized differences and observed/expected outcomes</span>
<span class="sd">            grouped by method. The keys will be &quot;indirect&quot; and/or &quot;direct&quot; based on the selected methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before calculating standardized differences.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">method</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;stdz&#39; must include &#39;indirect&#39; and/or &#39;direct&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Extract model components</span>
        <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
        <span class="n">group_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span>
        <span class="n">group_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span>
        <span class="n">group_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>
        <span class="n">totalower_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">)</span>

        <span class="c1"># Determine the null value for random effects</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">re_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">re_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">random_effects</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">group_sizes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">re_null</span> <span class="o">=</span> <span class="n">null</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;null&#39; argument provided. Must be &#39;median&#39;, &#39;mean&#39;, or a numeric value.&quot;</span><span class="p">)</span>

        <span class="c1"># If group_ids are specified, select those groups; otherwise, use all groups</span>
        <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_names</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">)</span>
            <span class="n">selected_groups</span> <span class="o">=</span> <span class="n">group_names</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_groups</span> <span class="o">=</span> <span class="n">group_names</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Indirect Standardization</span>
        <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="c1"># Compute expected outcomes by group by excluding random effects</span>
            <span class="n">expected_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">[</span><span class="n">group_indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_names</span><span class="p">))</span>
            <span class="p">])</span>
            <span class="c1"># Compute observed outcomes using the full fitted values including random effects</span>
            <span class="n">observed_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">[</span><span class="n">group_indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_names</span><span class="p">))</span>
            <span class="p">])</span>
            <span class="c1"># Indirect standardized difference</span>
            <span class="n">indirect_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_by_group</span> <span class="o">-</span> <span class="n">expected_by_group</span><span class="p">)</span> <span class="o">/</span> <span class="n">group_sizes</span>

            <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">group_names</span><span class="p">,</span>
                <span class="s2">&quot;indirect_difference&quot;</span><span class="p">:</span> <span class="n">indirect_diff</span><span class="p">,</span>
                <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">observed_by_group</span><span class="p">,</span>
                <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_by_group</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="n">indirect_df</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indirect_df</span>

        <span class="c1"># Direct Standardization</span>
        <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="c1"># Overall observed is the total sum of the fitted values</span>
            <span class="n">totalower_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># Calculate direct expected outcomes using group-specific random effects</span>
            <span class="n">expected_direct_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">+</span> <span class="n">re_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">re_val</span> <span class="ow">in</span> <span class="n">random_effects</span>
            <span class="p">])</span>
            <span class="c1"># Direct standardized difference</span>
            <span class="n">direct_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_direct_by_group</span> <span class="o">-</span> <span class="n">totalower_observed</span><span class="p">)</span> <span class="o">/</span> <span class="n">totalower_samples</span>

            <span class="n">direct_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="n">group_names</span><span class="p">,</span>
                <span class="s2">&quot;direct_difference&quot;</span><span class="p">:</span> <span class="n">direct_diff</span><span class="p">,</span>
                <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_names</span><span class="p">),</span> <span class="n">totalower_observed</span><span class="p">),</span>
                <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_direct_by_group</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">direct_df</span> <span class="o">=</span> <span class="n">direct_df</span><span class="p">[</span><span class="n">direct_df</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_df</span>

        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ci_bounds</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">re_coef</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">se</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute lower and upper bounds for confidence intervals given estimates,</span>
<span class="sd">        their standard errors, and the desired alternative using the normal approximation.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        re_coef : np.ndarray</span>
<span class="sd">            The point estimates.</span>
<span class="sd">        se : np.ndarray</span>
<span class="sd">            Standard errors corresponding to re_coef.</span>
<span class="sd">        level : float</span>
<span class="sd">            Confidence level (e.g., 0.95).</span>
<span class="sd">        alternative : str</span>
<span class="sd">            One of &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (lower, upper) as np.ndarray of the same shape as re_coef.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">re_coef</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">re_coef</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">re_coef</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fullower_like</span><span class="p">(</span><span class="n">re_coef</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fullower_like</span><span class="p">(</span><span class="n">re_coef</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">re_coef</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>
    
<div class="viewcode-block" id="LinearRandomEffectModel.calculate_confidence_intervals">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.calculate_confidence_intervals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_confidence_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SM&quot;</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate confidence intervals for provider (random) effects or standardized measures.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : Optional[Union[list, np.ndarray]]</span>
<span class="sd">            Subset of providers for which confidence intervals are calculated. Defaults to all providers.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level.</span>
<span class="sd">        option : str, default=&quot;SM&quot;</span>
<span class="sd">            Specifies whether to provide confidence intervals for &quot;alpha&quot; (provider effects) or &quot;SM&quot; (standardized measures).</span>
<span class="sd">        stdz : Union[str, list], default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method(s) if option is &quot;SM&quot;; must include &quot;indirect&quot; and/or &quot;direct&quot;.</span>
<span class="sd">        null : Union[str, float], default=&quot;median&quot;</span>
<span class="sd">            Baseline norm for calculating standardized measures.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            One of &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;.</span>
<span class="sd">            Note: The &quot;alpha&quot; option only supports two-sided intervals.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Contains confidence intervals for specified options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before calculating confidence intervals.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;SM&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;option&#39; must be &#39;alpha&#39; or &#39;SM&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;stdz&#39; must include &#39;indirect&#39; and/or &#39;direct&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">and</span> <span class="n">alternative</span> <span class="o">!=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provider effect &#39;alpha&#39; only supports two-sided confidence intervals.&quot;</span><span class="p">)</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
        <span class="n">var_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;re_var&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Extract the scalar value</span>

        <span class="c1"># Compute the residual variance.</span>
        <span class="n">sigma_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># self.group_sizes_ is an array with the number of observations for each provider.</span>
        <span class="n">n_prov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>

        <span class="c1"># Compute the shrinkage factor for each provider.</span>
        <span class="n">shrinkage_factor</span> <span class="o">=</span> <span class="n">var_alpha</span> <span class="o">/</span> <span class="p">(</span><span class="n">var_alpha</span> <span class="o">+</span> <span class="n">sigma_sq</span> <span class="o">/</span> <span class="n">n_prov</span><span class="p">)</span>

        <span class="c1"># Now compute the standard error for each provider effect.</span>
        <span class="n">se_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">shrinkage_factor</span> <span class="o">*</span> <span class="n">sigma_sq</span> <span class="o">/</span> <span class="n">n_prov</span><span class="p">)</span>

        <span class="n">lower_alpha</span><span class="p">,</span> <span class="n">upper_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ci_bounds</span><span class="p">(</span>
                    <span class="n">random_effects</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">se_alpha</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">alternative</span>
        <span class="p">)</span>

        <span class="c1"># Confidence Intervals for Provider (random) Effects (&quot;alpha&quot;)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span>
            <span class="n">alpha_ci</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">random_effects</span><span class="p">,</span>
                <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower_alpha</span><span class="p">,</span>
                <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper_alpha</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">alpha_ci</span> <span class="o">=</span> <span class="n">alpha_ci</span><span class="p">[</span><span class="n">alpha_ci</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;alpha_ci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_ci</span>

        <span class="c1"># Confidence Intervals for Standardized Measures (SM)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span><span class="p">:</span>
            <span class="n">sm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_standardized_measures</span><span class="p">(</span><span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
                <span class="n">lower_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">lower_alpha</span><span class="p">,</span> <span class="n">n_prov</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">upper_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">upper_alpha</span><span class="p">,</span> <span class="n">n_prov</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

                <span class="n">lower_prov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">lower_obs</span><span class="p">)</span>
                <span class="n">upper_prov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">upper_obs</span><span class="p">)</span>

                <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">sm_results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">expected_indirect</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;expected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_prov</span> <span class="o">-</span> <span class="n">expected_indirect</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_prov</span>
                <span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_prov</span> <span class="o">-</span> <span class="n">expected_indirect</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_prov</span>
                
                <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;indirect_ci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indirect_df</span>

            <span class="c1"># Direct standardization: </span>
            <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
                <span class="c1"># Instead of simply subtracting a baseline (re_null) from lower/upper bounds,</span>
                <span class="c1"># we aggregate the fixed-effect predictions with the bounds.</span>
                <span class="c1"># In the R code:</span>
                <span class="c1">#   Exp.direct(gamma) = sum(linear_pred) + n_total * gamma</span>
                <span class="c1">#   lower_direct = (Exp.direct(lower_gamma) - Obs_direct) / n_total</span>
                <span class="c1"># Here, we define:</span>
                <span class="n">n_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># total number of observations</span>
                <span class="n">constant_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)</span>  <span class="c1"># sum of fixed-effect predictions</span>

                <span class="c1"># Compute aggregated bounds:</span>
                <span class="n">lower_prov</span> <span class="o">=</span> <span class="n">constant_sum</span> <span class="o">+</span> <span class="n">n_total</span> <span class="o">*</span> <span class="n">lower_alpha</span>
                <span class="n">upper_prov</span> <span class="o">=</span> <span class="n">constant_sum</span> <span class="o">+</span> <span class="n">n_total</span> <span class="o">*</span> <span class="n">upper_alpha</span>

                <span class="c1"># Retrieve the observed overall effect from the SM output:</span>
                <span class="n">obs_direct</span> <span class="o">=</span> <span class="n">sm_results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">][</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> 

                <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
                    <span class="n">lower_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_prov</span> <span class="o">-</span> <span class="n">obs_direct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_total</span>
                    <span class="n">upper_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_prov</span> <span class="o">-</span> <span class="n">obs_direct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_total</span>
                <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
                    <span class="n">lower_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_prov</span> <span class="o">-</span> <span class="n">obs_direct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_total</span>
                    <span class="n">upper_direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fullower_like</span><span class="p">(</span><span class="n">lower_direct</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
                    <span class="n">lower_direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fullower_like</span><span class="p">(</span><span class="n">lower_prov</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                    <span class="n">upper_direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_prov</span> <span class="o">-</span> <span class="n">obs_direct</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_total</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>

                <span class="n">direct_df</span> <span class="o">=</span> <span class="n">sm_results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_direct</span>
                <span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_direct</span>
                <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">direct_df</span> <span class="o">=</span> <span class="n">direct_df</span><span class="p">[</span><span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;direct_ci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_df</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.test">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conduct hypothesis tests on provider (random) effects to identify outliers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : Optional[Union[list, np.ndarray]]</span>
<span class="sd">            A subset of provider IDs for which tests are conducted.</span>
<span class="sd">            If None, tests are conducted for all provider IDs.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for the hypothesis tests.</span>
<span class="sd">        null : float, default=0</span>
<span class="sd">            Null hypothesis value for provider effects.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Alternative hypothesis: Must be one of &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame with columns &quot;flag&quot;, &quot;p_value&quot;, &quot;stat&quot;, and &quot;std_error&quot; for each provider.</span>
<span class="sd">            - &quot;flag&quot;: Indicates whether a provider is an outlier with respect to the null hypothesis. </span>
<span class="sd">            Values are 1 (outlier above), -1 (outlier below), or 0 (not an outlier).</span>
<span class="sd">            - &quot;p_value&quot;: P-value of the hypothesis test for each provider.</span>
<span class="sd">            - &quot;stat&quot;: Test statistic (Z-score) calculated for each provider.</span>
<span class="sd">            - &quot;std_error&quot;: Standard error of the estimated provider effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before testing.&quot;</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
        <span class="n">var_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;re_var&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">sigma_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">n_prov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>  <span class="c1"># array with sample sizes per provider</span>

        <span class="c1"># Calculate the shrinkage (or reliability) factor for each provider</span>
        <span class="n">shrinkage_factor</span> <span class="o">=</span> <span class="n">var_alpha</span> <span class="o">/</span> <span class="p">(</span><span class="n">var_alpha</span> <span class="o">+</span> <span class="n">sigma_sq</span> <span class="o">/</span> <span class="n">n_prov</span><span class="p">)</span>
        <span class="n">se_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">shrinkage_factor</span> <span class="o">*</span> <span class="n">sigma_sq</span> <span class="o">/</span> <span class="n">n_prov</span><span class="p">)</span>
        <span class="c1"># Compute test statistic (Z-score)</span>
        <span class="n">Z_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">random_effects</span> <span class="o">-</span> <span class="n">null</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_alpha</span>

        <span class="c1"># use the upper-tail probability to mimic R&#39;s pnorm(..., lower.tail=F)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">Z_score</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; should be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">Z_score</span><span class="p">,</span>
            <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">se_alpha</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">random_effects</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group_ids</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;group_ids&#39; should be a list or array of provider IDs.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

     
<div class="viewcode-block" id="LinearRandomEffectModel.plot_funnel">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.plot_funnel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_funnel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Lower&quot;</span><span class="p">,</span> <span class="s2">&quot;Expected&quot;</span><span class="p">,</span> <span class="s2">&quot;Higher&quot;</span><span class="p">],</span>
        <span class="n">point_colors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#E69F00&quot;</span><span class="p">,</span> <span class="s2">&quot;#56B4E9&quot;</span><span class="p">,</span> <span class="s2">&quot;#009E73&quot;</span><span class="p">],</span>
        <span class="n">point_shapes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">],</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">target_linestyle</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cl_line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">cl_line_styles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#A6CEE3&quot;</span><span class="p">,</span>
        <span class="n">fill_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Funnel Plot of Standardized Differences&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Precision (Group Size)&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Standardized Difference&quot;</span><span class="p">,</span>
        <span class="n">legend_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;best&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a funnel plot for standardized differences in random effect models.</span>

<span class="sd">        This plot visualizes the standardized differences (e.g., alpha_i - alpha_null) against</span>
<span class="sd">        group size (as a proxy for precision). Control limits are based on the overall model&#39;s</span>
<span class="sd">        residual standard deviation (sigma).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        stdz : str, default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method. For random effects, this can be &quot;indirect&quot; or &quot;direct&quot;.</span>
<span class="sd">        null : str or float, default=&quot;median&quot;</span>
<span class="sd">            Baseline for provider effects (alpha) used in calculating the difference</span>
<span class="sd">            and for flagging. Can be &quot;median&quot;, &quot;mean&quot;, or a specific float value.</span>
<span class="sd">        target : float, default=0.0</span>
<span class="sd">            Reference value for the difference (target line on the plot).</span>
<span class="sd">        alpha : float or List[float], default=0.05</span>
<span class="sd">            Significance level(s) for control limits.</span>
<span class="sd">        labels : List[str], default=[&quot;Lower&quot;, &quot;Expected&quot;, &quot;Higher&quot;]</span>
<span class="sd">            Labels for provider performance categories based on flags (-1, 0, 1).</span>
<span class="sd">        point_colors : List[str]</span>
<span class="sd">            Colors for provider points based on performance flag.</span>
<span class="sd">        point_shapes : List[str]</span>
<span class="sd">            Marker shapes for provider points based on performance flag.</span>
<span class="sd">        point_size : float, default=2.0</span>
<span class="sd">            Scaling factor for marker size.</span>
<span class="sd">        point_alpha : float, default=0.8</span>
<span class="sd">            Marker transparency.</span>
<span class="sd">        line_size : float, default=0.8</span>
<span class="sd">            Thickness for target and control limit lines.</span>
<span class="sd">        target_linestyle : str, default=&#39;--&#39;</span>
<span class="sd">            Line style for the target reference line.</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        cl_line_colors : str or List[str], optional</span>
<span class="sd">            Color(s) for the control limit lines. Defaults to &quot;grey&quot;.</span>
<span class="sd">        cl_line_styles : str or List[str], optional</span>
<span class="sd">            Line style(s) for control limits. Defaults based on number of alphas.</span>
<span class="sd">        fill_color : str, default=&quot;#A6CEE3&quot;</span>
<span class="sd">            Fill color for the area between the outermost control limits.</span>
<span class="sd">        fill_alpha : float, default=0.25</span>
<span class="sd">            Transparency of the control limit fill area.</span>
<span class="sd">        edge_color : str or None, default=&quot;grey&quot;</span>
<span class="sd">            Edge color for scatter points.</span>
<span class="sd">        edge_linewidth : float, default=0.5</span>
<span class="sd">            Line width for scatter point edges.</span>
<span class="sd">        add_grid : bool, default=True</span>
<span class="sd">            Whether to add a background grid.</span>
<span class="sd">        grid_style : str, default=&#39;:&#39;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default=0.6</span>
<span class="sd">            Transparency for the grid lines.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">            Whether to remove the top and right axis lines.</span>
<span class="sd">        figure_size : Tuple[float, float], default=(8, 6)</span>
<span class="sd">            Figure size in inches.</span>
<span class="sd">        plot_title : str, default=&quot;Funnel Plot of Standardized Differences&quot;</span>
<span class="sd">            Title for the plot.</span>
<span class="sd">        xlab : str, default=&quot;Precision (Group Size)&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylab : str, default=&quot;Standardized Difference&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">        legend_location : str, default=&#39;best&#39;</span>
<span class="sd">            Location string for the legend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted and sigma estimated before plotting funnel plot.&quot;</span><span class="p">)</span>

        <span class="c1"># Ttransform any &quot;median&quot;/&quot;mean&quot; null into a numeric value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Grab the random effects as you do elsewhere</span>
            <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass a string to &#39;null&#39;, it must be &#39;median&#39; or &#39;mean&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it&#39;s already numeric, just ensure float</span>
            <span class="n">null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>

        <span class="n">a_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">alpha</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">alpha_test</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="n">sm_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_standardized_measures</span><span class="p">(</span><span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdz</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sm_info</span> <span class="ow">or</span> <span class="n">sm_info</span><span class="p">[</span><span class="n">stdz</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No standardized measure data found for &#39;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">&#39;. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sm_info</span><span class="p">[</span><span class="n">stdz</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;group_id&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">precision_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">precision_map</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha_test</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two_sided&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">limits_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a_val</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">:</span>
            <span class="n">z_val</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a_val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">se_for_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">])</span>
            <span class="n">se_for_limits</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">se_for_limits</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">control_lower</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">z_val</span> <span class="o">*</span> <span class="n">se_for_limits</span>
            <span class="n">control_upper</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="n">z_val</span> <span class="o">*</span> <span class="n">se_for_limits</span>
            <span class="n">limits_df_a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                <span class="s2">&quot;control_lower&quot;</span><span class="p">:</span> <span class="n">control_lower</span><span class="p">,</span>
                <span class="s2">&quot;control_upper&quot;</span><span class="p">:</span> <span class="n">control_upper</span><span class="p">,</span> 
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">a_val</span>
            <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">limits_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limits_df_a</span><span class="p">)</span>
        <span class="n">limits_all_alphas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">limits_list</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>
        <span class="n">limits_all_alphas</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">)</span>
        <span class="n">outer_alpha</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cl_line_styles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">default_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
            <span class="n">cl_line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_styles</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_styles</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_line_styles</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">cl_line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_line_styles</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cl_line_colors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_line_colors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">cl_line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_line_colors</span> <span class="ow">or</span> <span class="s1">&#39;grey&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
        
        <span class="n">sorted_alphas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
        <span class="n">style_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_alphas</span><span class="p">,</span> <span class="n">cl_line_styles</span><span class="p">));</span> <span class="n">color_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_alphas</span><span class="p">,</span> <span class="n">cl_line_colors</span><span class="p">))</span>
        <span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">outer_limits</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">outer_alpha</span><span class="p">]</span>
        <span class="n">label_outer_ci</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">outer_alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span>
        <span class="n">fill_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> <span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">fill_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">fill_alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_outer_ci</span><span class="p">)</span>
        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_handle</span><span class="p">);</span> <span class="n">legend_labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_outer_ci</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a_val</span> <span class="ow">in</span> <span class="n">sorted_alphas</span><span class="p">:</span>
            <span class="n">subset_lim</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">a_val</span><span class="p">]</span>
            <span class="n">line_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">a_val</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span> <span class="k">if</span> <span class="n">a_val</span> <span class="o">!=</span> <span class="n">outer_alpha</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">line_lower</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">style_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">line_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">style_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_label</span><span class="p">:</span> <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_lower</span><span class="p">);</span> <span class="n">legend_labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_label</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">target_linestyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

        <span class="n">present_flags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">flag_map</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">flag_val</span> <span class="ow">in</span> <span class="n">present_flags</span><span class="p">:</span>
            <span class="n">subset_pts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flag_val</span><span class="p">]</span>
            <span class="n">label_idx</span> <span class="o">=</span> <span class="n">flag_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_val</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_pts</span><span class="p">)</span>
            <span class="n">point_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">label_idx</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">scatter_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subset_pts</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                                        <span class="n">subset_pts</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_difference&quot;</span><span class="p">],</span>
                                        <span class="n">marker</span><span class="o">=</span><span class="n">point_shapes</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_shapes</span><span class="p">)],</span> 
                                        <span class="n">color</span><span class="o">=</span><span class="n">point_colors</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_colors</span><span class="p">)],</span>
                                        <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span> 
                                        <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span> 
                                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span> 
                                        <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> 
                                        <span class="n">label</span><span class="o">=</span><span class="n">point_label</span><span class="p">)</span>
            <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter_handle</span><span class="p">);</span> 
            <span class="n">legend_labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_label</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        
        <span class="n">all_y_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_difference&quot;</span><span class="p">],</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_y_values</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">min_y_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_y_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">max_y_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_y_values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y_val</span> <span class="o">-</span> <span class="n">min_y_val</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_y_val</span> <span class="o">-</span> <span class="n">min_y_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mf">0.1</span> <span class="c1"># Ensure padding is positive</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_y_val</span> <span class="o">-</span> <span class="n">padding</span><span class="p">,</span> <span class="n">max_y_val</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>
        
        <span class="n">max_x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="p">(</span><span class="n">max_x</span> <span class="o">*</span> <span class="mf">1.05</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">max_x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        
        <span class="n">unique_handles_labels</span> <span class="o">=</span> <span class="p">{};</span> 
        <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_handles_labels</span><span class="p">:</span> 
                <span class="n">unique_handles_labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">unique_handles_labels</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> 
                <span class="n">labels</span><span class="o">=</span><span class="n">unique_handles_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> 
                <span class="n">loc</span><span class="o">=</span><span class="n">legend_location</span><span class="p">,</span> 
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Flag&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


        
<div class="viewcode-block" id="LinearRandomEffectModel.plot_provider_effects">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.plot_provider_effects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_provider_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots provider random effects (alpha) using the plot_caterpillar helper function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to plot. If None, all providers are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Whether to color-code providers based on flags from the test method.</span>
<span class="sd">        null : str or float, default=0</span>
<span class="sd">            Null hypothesis for alpha used for flagging. Can be &#39;median&#39;, &#39;mean&#39;, or a float.</span>
<span class="sd">        test_method : str, optional</span>
<span class="sd">            Test method used specifically for generating flags (&#39;wald&#39; is the only one for LinearRE&#39;s .test()).</span>
<span class="sd">            If None, defaults to &#39;wald&#39;.</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to plot_caterpillar (e.g., plot_title, orientation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first.&quot;</span><span class="p">)</span>

        <span class="c1"># Ttransform any &quot;median&quot;/&quot;mean&quot; null into a numeric value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Grab the random effects as you do elsewhere</span>
            <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass a string to &#39;null&#39;, it must be &#39;median&#39; or &#39;mean&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it&#39;s already numeric, just ensure float</span>
            <span class="n">null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>

        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;alpha_ci&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ci_results</span> <span class="ow">or</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;alpha_ci&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No alpha CI data. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;alpha_ci&#39;</span><span class="p">]</span>  <span class="c1"># Has &#39;group_id&#39;, &#39;alpha&#39;, &#39;lower&#39;, &#39;upper&#39;</span>

        <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">flag_col_name</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span>
            <span class="n">current_test_method</span> <span class="o">=</span> <span class="n">test_method</span> <span class="k">if</span> <span class="n">test_method</span> <span class="k">else</span> <span class="s1">&#39;wald&#39;</span>
            <span class="k">if</span> <span class="n">current_test_method</span> <span class="o">!=</span> <span class="s1">&#39;wald&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LinearRandomEffectModel.test uses a t-test (Wald-like). test_method &#39;</span><span class="si">{</span><span class="n">current_test_method</span><span class="si">}</span><span class="s2">&#39; for flagging will use this underlying test.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                    <span class="n">group_ids</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                    <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span>
                    <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
                <span class="p">)</span>

                <span class="c1"># Merge flags using left_on=&#39;group_id&#39; and right_index=True since test_df is indexed by provider IDs</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate flags. Plotting without flags. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">alpha_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">alpha_null_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">alpha_vals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">alpha_null_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">alpha_vals</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_null_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Alpha Estimate (Random Effect)&#39;</span><span class="p">)</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider&#39;</span><span class="p">)</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="s1">&#39;Alpha Estimate (Random Effect)&#39;</span><span class="p">)</span>

        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;plot_title&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider Effects (Alpha)&#39;</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="n">alpha_null_val</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span>
            <span class="n">estimate_col</span><span class="o">=</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span>
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span>
            <span class="n">flag_col</span><span class="o">=</span><span class="n">flag_col_name</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.plot_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.plot_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_standardized_measures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
        <span class="n">stdz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;indirect&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span>
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots standardized differences using plot_caterpillar.</span>
<span class="sd">        For LinearRandomEffectModel, standardized measures are differences (alpha_i - alpha_null).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to plot.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        stdz : str, default=&#39;indirect&#39;</span>
<span class="sd">            Standardization method (&#39;indirect&#39; or &#39;direct&#39;). Both result in alpha_i - alpha_null.</span>
<span class="sd">        measure : str, default=&#39;difference&#39;</span>
<span class="sd">            The measure to plot. For linear models, this is always &#39;difference&#39;.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Whether to color-code providers based on flags from the alpha test method.</span>
<span class="sd">        null : str or float, default=&#39;median&#39;</span>
<span class="sd">            Null hypothesis for alpha used for flagging and calculating the difference.</span>
<span class="sd">        test_method : str, optional</span>
<span class="sd">            Test method used specifically for generating flags. Defaults to &#39;wald&#39; (t-test).</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to plot_caterpillar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted.&quot;</span><span class="p">)</span>

        <span class="c1"># Ttransform any &quot;median&quot;/&quot;mean&quot; null into a numeric value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Grab the random effects as you do elsewhere</span>
            <span class="n">random_effects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">random_effects</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If you pass a string to &#39;null&#39;, it must be &#39;median&#39; or &#39;mean&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it&#39;s already numeric, just ensure float</span>
            <span class="n">null</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">measure</span> <span class="o">!=</span> <span class="s1">&#39;difference&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;For LinearRandomEffectModel, standardized &#39;measure&#39; is &#39;difference&#39;.&quot;</span><span class="p">)</span>

        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span> 
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
            <span class="n">option</span><span class="o">=</span><span class="s1">&#39;SM&#39;</span><span class="p">,</span> 
            <span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> 
            <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> 
            <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
        <span class="p">)</span>
        <span class="n">ci_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_ci&quot;</span>
        <span class="k">if</span> <span class="n">ci_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ci_results</span> <span class="ow">or</span> <span class="n">ci_results</span><span class="p">[</span><span class="n">ci_key</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No SM CI data for &#39;</span><span class="si">{</span><span class="n">ci_key</span><span class="si">}</span><span class="s2">&#39;. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="n">ci_key</span><span class="p">]</span>  <span class="c1"># This df should have &#39;group_id&#39;, &#39;{stdz}_difference&#39;, &#39;lower&#39;, &#39;upper&#39;</span>
        <span class="n">estimate_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_difference&quot;</span>

        <span class="k">if</span> <span class="n">estimate_col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;lower&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;upper&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required columns (&#39;</span><span class="si">{</span><span class="n">estimate_col_name</span><span class="si">}</span><span class="s2">&#39;, &#39;lower&#39;, &#39;upper&#39;) not found in SM CI results. Available: </span><span class="si">{</span><span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">flag_col_name</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span>
            <span class="n">current_test_method</span> <span class="o">=</span> <span class="n">test_method</span> <span class="k">if</span> <span class="n">test_method</span> <span class="k">else</span> <span class="s1">&#39;wald&#39;</span>
            <span class="k">if</span> <span class="n">current_test_method</span> <span class="o">!=</span> <span class="s1">&#39;wald&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LinearRandomEffectModel.test uses a t-test (Wald-like). test_method &#39;</span><span class="si">{</span><span class="n">current_test_method</span><span class="si">}</span><span class="s2">&#39; for flagging will use this.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                    <span class="n">group_ids</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
                    <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> 
                    <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
                <span class="p">)</span>

                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate flags. Plotting without flags. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">default_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Standardized Difference&quot;</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">default_xlab</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Difference Estimate&quot;</span>
            <span class="n">default_ylab</span> <span class="o">=</span> <span class="s2">&quot;Provider&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_xlab</span> <span class="o">=</span> <span class="s2">&quot;Provider&quot;</span>
            <span class="n">default_ylab</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Difference Estimate&quot;</span>
        <span class="n">default_refline</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;plot_title&#39;</span><span class="p">,</span> <span class="n">default_title</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="n">default_xlab</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="n">default_ylab</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="n">default_refline</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span> 
            <span class="n">estimate_col</span><span class="o">=</span><span class="n">estimate_col_name</span><span class="p">,</span>
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> 
            <span class="n">flag_col</span><span class="o">=</span><span class="n">flag_col_name</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.plot_coefficient_forest">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.plot_coefficient_forest">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_coefficient_forest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
        <span class="n">refline_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#34495E&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">error_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#95A5A6&quot;</span><span class="p">,</span>
        <span class="n">capsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">errorbar_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">errorbar_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Forest Plot of Covariate Coefficients&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Coefficient Estimate&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Covariate&quot;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a forest plot of covariate coefficients with 95% confidence intervals.</span>

<span class="sd">        Plots each covariate&#39;s coefficient estimate and its confidence interval</span>
<span class="sd">        in a vertical or horizontal layout, with a reference line at a specified value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orientation : {&#39;vertical&#39;,&#39;horizontal&#39;}, default &#39;vertical&#39;</span>
<span class="sd">            &#39;vertical&#39;: covariate names on the y-axis, estimates on the x-axis.</span>
<span class="sd">            &#39;horizontal&#39;: covariate names on the x-axis, estimates on the y-axis.</span>
<span class="sd">        refline_value : float or None, default 0.0</span>
<span class="sd">            Draws a reference line at this value (vertical or horizontal). None disables it.</span>
<span class="sd">        point_color : str, default &quot;#34495E&quot;</span>
<span class="sd">            Color of the coefficient marker.</span>
<span class="sd">        point_alpha : float, default 0.8</span>
<span class="sd">            Opacity of the coefficient marker.</span>
<span class="sd">        edge_color : str or None, default None</span>
<span class="sd">            Edge color of the marker. None for no edge.</span>
<span class="sd">        edge_linewidth : float, default 0</span>
<span class="sd">            Width of the marker edge.</span>
<span class="sd">        point_size : float, default 0.5</span>
<span class="sd">            Scale factor for marker size.</span>
<span class="sd">        error_color : str, default &quot;#95A5A6&quot;</span>
<span class="sd">            Color of the error bars.</span>
<span class="sd">        capsize : float, default 5</span>
<span class="sd">            Cap size for error bars.</span>
<span class="sd">        errorbar_size : float, default 0.5</span>
<span class="sd">            Thickness of the error bar lines.</span>
<span class="sd">        errorbar_alpha : float, default 0.5</span>
<span class="sd">            Opacity of the error bars.</span>
<span class="sd">        line_color : str, default &quot;red&quot;</span>
<span class="sd">            Color of the reference line.</span>
<span class="sd">        line_style : str, default &quot;--&quot;</span>
<span class="sd">            Line style of the reference line.</span>
<span class="sd">        line_size : float, default 0.8</span>
<span class="sd">            Thickness of the reference line.</span>
<span class="sd">        font_size : float, default 12</span>
<span class="sd">            Font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default 10</span>
<span class="sd">            Font size for tick labels.</span>
<span class="sd">        add_grid : bool, default True</span>
<span class="sd">            Whether to draw a light grid.</span>
<span class="sd">        grid_style : str, default &quot;:&quot;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default 0.6</span>
<span class="sd">            Opacity of the grid.</span>
<span class="sd">        remove_top_right_spines : bool, default True</span>
<span class="sd">            Hide the top and right spines.</span>
<span class="sd">        figure_size : tuple, default (10, 6)</span>
<span class="sd">            Size of the figure in inches.</span>
<span class="sd">        plot_title : str, default &quot;Forest Plot of Covariate Coefficients&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        xlab : str, default &quot;Coefficient Estimate&quot;</span>
<span class="sd">            Label for the x-axis (or y-axis if horizontal).</span>
<span class="sd">        ylab : str, default &quot;Covariate&quot;</span>
<span class="sd">            Label for the y-axis (or x-axis if horizontal).</span>
<span class="sd">        save_path : str or None, default None</span>
<span class="sd">            File path to save the figure. If None, the plot is shown.</span>
<span class="sd">        dpi : int, default 300</span>
<span class="sd">            Resolution (dots per inch) for saving.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not fitted or if an invalid orientation is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting coefficients.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;vertical&#39; or &#39;horizontal&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Compute estimates and 95% CIs</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">se_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;fe_var_cov&quot;</span><span class="p">]))</span>
        <span class="n">df_denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;random_effect&quot;</span><span class="p">])</span>
        <span class="n">crit</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df_denom</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit</span> <span class="o">*</span> <span class="n">se_beta</span>

        <span class="n">coef_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;covariate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">fe_params</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
                <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
                <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">upper</span>
            <span class="p">})</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;estimate&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Positions</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_df</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Prepare coordinates and errors</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">],</span> <span class="n">positions</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">positions</span><span class="p">,</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="c1"># Plot setup</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>

        <span class="c1"># Draw errorbars and points</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span>
            <span class="p">)</span>

        <span class="c1"># Reference line</span>
        <span class="k">if</span> <span class="n">refline_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

        <span class="c1"># Labels, ticks, grid</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>

        <span class="c1"># Spines</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># Title &amp; layout</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Save or show</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.plot_residuals">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.plot_residuals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_residuals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#1F78B4&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Fitted Values&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Residuals&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Residuals vs. Fitted Values&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots residuals versus fitted values.</span>

<span class="sd">        This diagnostic plot helps assess model assumptions such as linearity</span>
<span class="sd">        and homoscedasticity (constant variance of errors). Ideally, the points</span>
<span class="sd">        should show no discernible pattern and be randomly scattered around the</span>
<span class="sd">        horizontal line at zero.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figsize : tuple, default=(8, 5)</span>
<span class="sd">            Size of the figure to create.</span>
<span class="sd">        point_color : str, default=&quot;#1F78B4&quot;</span>
<span class="sd">            Color for the residual points.</span>
<span class="sd">        point_alpha : float, default=0.6</span>
<span class="sd">            Transparency level for the points.</span>
<span class="sd">        edge_color : str or None, default=&quot;grey&quot;</span>
<span class="sd">            Edge color for the points. None means no edge.</span>
<span class="sd">        edge_linewidth : float, default=0.5</span>
<span class="sd">            Width of the point edges if `edge_color` is specified.</span>
<span class="sd">        point_size : float, default=30</span>
<span class="sd">            Size of the scatter plot markers.</span>
<span class="sd">        line_color : str, default=&quot;red&quot;</span>
<span class="sd">            Color of the horizontal reference line at zero.</span>
<span class="sd">        line_style : str, default=&quot;--&quot;</span>
<span class="sd">            Line style for the reference line.</span>
<span class="sd">        line_width : float, default=1.5</span>
<span class="sd">            Width of the reference line.</span>
<span class="sd">        xlabel : str, default=&quot;Fitted Values&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylabel : str, default=&quot;Residuals&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">        title : str, default=&quot;Residuals vs. Fitted Values&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        add_grid : bool, default=True</span>
<span class="sd">            Whether to add a background grid.</span>
<span class="sd">        grid_style : str, default=&#39;:&#39;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default=0.6</span>
<span class="sd">            Transparency for the grid lines.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">            Whether to remove the top and right plot spines.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has not been fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting residuals.&quot;</span><span class="p">)</span>

        <span class="c1"># Create a new figure and axes for the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">point_size</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="LinearRandomEffectModel.plot_qq">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_random_effect.LinearRandomEffectModel.plot_qq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_qq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Normal Q-Q Plot of Residuals&quot;</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Theoretical Normal Quantiles&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Ordered Residuals&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#1F78B4&quot;</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Q-Q plot of residuals against a Normal distribution.</span>

<span class="sd">        This plot helps assess the assumption of normally distributed errors,</span>
<span class="sd">        which is important for the validity of t-tests and confidence intervals</span>
<span class="sd">        in linear models. Points falling approximately along the diagonal line</span>
<span class="sd">        suggest normality.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figsize : tuple, default=(7, 6)</span>
<span class="sd">            Size of the figure to create.</span>
<span class="sd">        title : str, default=&quot;Normal Q-Q Plot of Residuals&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        xlabel : str, default=&quot;Theoretical Normal Quantiles&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylabel : str, default=&quot;Ordered Residuals&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        point_color : str, default=&quot;#1F78B4&quot;</span>
<span class="sd">            Color for the points representing residuals.</span>
<span class="sd">        line_color : str, default=&quot;red&quot;</span>
<span class="sd">            Color for the diagonal reference line.</span>
<span class="sd">        add_grid : bool, default=False</span>
<span class="sd">            Whether to add a background grid.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">            Whether to remove the top and right plot spines.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has not been fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting QQ plot.&quot;</span><span class="p">)</span>

        <span class="c1"># Create a new figure and axes for the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Ensure residuals are 1D array</span>
        <span class="n">residuals_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Create the Q-Q plot using scipy.stats.probplot</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">osm</span><span class="p">,</span> <span class="n">osr</span><span class="p">),</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_sq</span><span class="p">)</span> <span class="o">=</span> <span class="n">probplot</span><span class="p">(</span><span class="n">residuals_flat</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Plot the ordered residuals against theoretical quantiles</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">osm</span><span class="p">,</span> <span class="n">osr</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="c1"># Plot the fitted line</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">osm</span><span class="p">,</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">osm</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate Q-Q plot data, possibly due to issues with residuals: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Plot empty axes as placeholder if data generation fails</span>
            <span class="k">pass</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kevin He.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>