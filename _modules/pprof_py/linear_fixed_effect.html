

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pprof_py.linear_fixed_effect &mdash; pprof_py 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=e46d07af" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pprof_py
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../base_model.html">Base Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_fixed_effect_model.html">Linear Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linear_random_effect_model.html">Linear Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_fixed_effect_model.html">Logistic Fixed Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logistic_random_effect_model.html">Logistic Random Effect Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../direct_vs_indirect_standardization.html">Direct vs. Indirect Standardization Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fixed_vs_random_effects.html">Fixed Effects vs. Random Effects Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pprof_py</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pprof_py.linear_fixed_effect</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pprof_py.linear_fixed_effect</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">probplot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">block_diag</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.base_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">,</span> <span class="n">TestMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_caterpillar</span>


<div class="viewcode-block" id="LinearFixedEffectModel">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LinearFixedEffectModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">SummaryMixin</span><span class="p">,</span> <span class="n">PlotMixin</span><span class="p">,</span> <span class="n">TestMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Linear Fixed Effect model.</span>

<span class="sd">    The Linear Fixed Effect model is a linear regression model that includes fixed effects.</span>
<span class="sd">    The model is fitted using the weighted least squares method.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    - gamma_var_option: str, default=&quot;complete&quot;</span>
<span class="sd">        Option for variance calculation. Must be &quot;complete&quot; or &quot;simplified&quot;.</span>

<span class="sd">    Examples:</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; from pprof_test.linear_fixed_effect import LinearFixedEffectModel</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; data = pd.DataFrame({</span>
<span class="sd">    ...     &#39;y&#39;: [1, 2, 3, 4, 5, 6],</span>
<span class="sd">    ...     &#39;x1&#39;: [1, 0, 1, 0, 1, 0],</span>
<span class="sd">    ...     &#39;x2&#39;: [0, 1, 0, 1, 0, 1],</span>
<span class="sd">    ...     &#39;group&#39;: [1, 1, 2, 2, 3, 3]</span>
<span class="sd">    ... })</span>
<span class="sd">    &gt;&gt;&gt; model = LinearFixedEffectModel()</span>
<span class="sd">    &gt;&gt;&gt; model.fit(data, x_vars=[&#39;x1&#39;, &#39;x2&#39;], y_var=&#39;y&#39;, group_var=&#39;group&#39;)</span>
<span class="sd">    &gt;&gt;&gt; predictions = model.predict(data[[&#39;x1&#39;, &#39;x2&#39;]], groups=data[&#39;group&#39;])</span>
<span class="sd">    &gt;&gt;&gt; print(predictions)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LinearFixedEffectModel.__init__">
<a class="viewcode-back" href="../../_autosummary_generated/pprof_py.linear_fixed_effect.LinearFixedEffectModel.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma_var_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;complete&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gamma_var_option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;simplified&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;gamma_var_option&#39; must be &#39;complete&#39; or &#39;simplified&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_var_option</span> <span class="o">=</span> <span class="n">gamma_var_option</span></div>


    
    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_groups</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">group_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess groups to construct the block diagonal matrix and compute group means.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - X: np.ndarray, shape (n_samples, n_features)</span>
<span class="sd">            Design matrix.</span>
<span class="sd">        - y: np.ndarray, shape (n_samples,)</span>
<span class="sd">            Response variable.</span>
<span class="sd">        - group_indices: np.ndarray, shape (n_samples,)</span>
<span class="sd">            Group indices for each sample.</span>
<span class="sd">        - n_groups: int</span>
<span class="sd">            Number of groups.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - Q: np.ndarray</span>
<span class="sd">            Block diagonal matrix for demeaning group effects.</span>
<span class="sd">        - y_means: np.ndarray, shape (n_groups,)</span>
<span class="sd">            Mean of the response variable for each group.</span>
<span class="sd">        - X_means: np.ndarray, shape (n_groups, n_features)</span>
<span class="sd">            Mean of predictors for each group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">group_indices</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_block_diag_matrix</span><span class="p">(</span><span class="n">group_sizes</span><span class="p">)</span>
        <span class="c1"># Compute group means for y and X:</span>
        <span class="n">y_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">group_indices</span> <span class="o">==</span> <span class="n">g</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">)])</span>
        <span class="n">X_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">group_indices</span> <span class="o">==</span> <span class="n">g</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">y_means</span><span class="p">,</span> <span class="n">X_means</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_residuals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">xbeta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">group_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate predictions and residuals.</span>

<span class="sd">        This function computes the predicted values by adding the group-level fixed effects to</span>
<span class="sd">        the linear predictor (xbeta) and computes the residuals by subtracting the predictions</span>
<span class="sd">        from the observed response values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xbeta : np.ndarray, shape (n_samples,)</span>
<span class="sd">            The linear predictor values (X @ beta) for each sample.</span>
<span class="sd">        gamma : np.ndarray, shape (n_groups, 1)</span>
<span class="sd">            Fixed effects for each group.</span>
<span class="sd">        y : np.ndarray, shape (n_samples,)</span>
<span class="sd">            Observed response variable.</span>
<span class="sd">        group_indices : np.ndarray, shape (n_samples,)</span>
<span class="sd">            Group indices for each sample, indicating which group each sample belongs to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            predictions : np.ndarray, shape (n_samples,)</span>
<span class="sd">                The predicted response values.</span>
<span class="sd">            residuals : np.ndarray, shape (n_samples,)</span>
<span class="sd">                The residuals of the model, calculated as the difference between observed and predicted values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gamma_obs</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="n">group_indices</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">xbeta</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">+</span> <span class="n">gamma_obs</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">predictions</span>
        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">residuals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_model_statistics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">residuals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute model statistics including AIC and BIC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - residuals: np.ndarray, shape (n_samples,)</span>
<span class="sd">            Residuals from the model.</span>
<span class="sd">        - n_samples: int</span>
<span class="sd">            Total number of samples.</span>
<span class="sd">        - n_groups: int</span>
<span class="sd">            Number of groups.</span>
<span class="sd">        - n_features: int</span>
<span class="sd">            Number of predictors.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - aic: float</span>
<span class="sd">            Akaike Information Criterion.</span>
<span class="sd">        - bic: float</span>
<span class="sd">            Bayesian Information Criterion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residual_sum_squares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">n_samples</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">n_samples</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">residual_sum_squares</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">residual_sum_squares</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">residual_sum_squares</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">aic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log_likelihood</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_groups</span> <span class="o">+</span> <span class="n">n_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log_likelihood</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_groups</span> <span class="o">+</span> <span class="n">n_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aic</span><span class="p">,</span> <span class="n">bic</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_construct_block_diag_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_sizes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a block diagonal matrix for demeaning group effects.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - group_sizes: np.ndarray, shape (n_groups,)</span>
<span class="sd">            Number of samples in each group.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - Q: np.ndarray</span>
<span class="sd">            Block diagonal matrix for demeaning group effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Q_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">group_sizes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">Q_blocks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_weighted_least_squares</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform weighted least squares to estimate coefficients.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - Q: np.ndarray, shape (n_samples, n_samples)</span>
<span class="sd">            Block diagonal matrix for demeaning group effects.</span>
<span class="sd">        - X: np.ndarray, shape (n_samples, n_features)</span>
<span class="sd">            Design matrix.</span>
<span class="sd">        - y: np.ndarray, shape (n_samples,)</span>
<span class="sd">            Response variable.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - beta: np.ndarray, shape (n_features, 1)</span>
<span class="sd">            Estimated regression coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QX</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">@</span> <span class="n">X</span>
        <span class="n">Qy</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">@</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">QX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">QX</span><span class="p">,</span> <span class="n">QX</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Qy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">beta</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_estimate_sigma</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">residuals</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_features</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate the standard deviation of residuals (sigma).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - residuals: np.ndarray, shape (n_samples,)</span>
<span class="sd">            Residuals from the model.</span>
<span class="sd">        - n_samples: int</span>
<span class="sd">            Total number of samples.</span>
<span class="sd">        - n_groups: int</span>
<span class="sd">            Number of groups.</span>
<span class="sd">        - n_features: int</span>
<span class="sd">            Number of predictors.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - sigma: float</span>
<span class="sd">            Estimated standard deviation of residuals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residual_sum_squares</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sigma_hat_sq</span> <span class="o">=</span> <span class="n">residual_sum_squares</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_groups</span> <span class="o">-</span> <span class="n">n_features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_hat_sq</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_estimate_variances</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">X_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">group_sizes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate variances of beta and gamma coefficients for inferential statistics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Q : np.ndarray</span>
<span class="sd">            Block diagonal matrix for demeaning group effects.</span>
<span class="sd">        X : np.ndarray</span>
<span class="sd">            Design matrix.</span>
<span class="sd">        X_means : np.ndarray</span>
<span class="sd">            Group-level means of predictors.</span>
<span class="sd">        beta : np.ndarray</span>
<span class="sd">            Estimated regression coefficients.</span>
<span class="sd">        group_sizes : np.ndarray</span>
<span class="sd">            Number of samples in each group.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Variances of beta and gamma coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma_hat_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1"># Variance of beta:</span>
        <span class="n">var_beta</span> <span class="o">=</span> <span class="n">sigma_hat_sq</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">((</span><span class="n">Q</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">Q</span> <span class="o">@</span> <span class="n">X</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_var_option</span> <span class="o">==</span> <span class="s2">&quot;complete&quot;</span><span class="p">:</span>
            <span class="c1"># Remove the sigma factor from var_beta before forming the quadratic term:</span>
            <span class="n">inv_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">((</span><span class="n">Q</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">Q</span> <span class="o">@</span> <span class="n">X</span><span class="p">))</span>  <span class="c1"># This equals var_beta/sigma_hat_sq.</span>
            <span class="c1"># Compute diag(Z_bar %*% inv_term %*% t(Z_bar))</span>
            <span class="n">quad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">X_means</span> <span class="o">@</span> <span class="n">inv_term</span><span class="p">)</span> <span class="o">*</span> <span class="n">X_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># vector of length n_groups</span>
            <span class="n">var_gamma</span> <span class="o">=</span> <span class="n">sigma_hat_sq</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">group_sizes</span> <span class="o">+</span> <span class="n">quad</span><span class="p">)</span>
            <span class="n">var_gamma</span> <span class="o">=</span> <span class="n">var_gamma</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># &quot;simplified&quot;</span>
            <span class="n">var_gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma_hat_sq</span> <span class="o">/</span> <span class="n">group_sizes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="n">var_beta</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">var_gamma</span><span class="p">}</span>
        
<div class="viewcode-block" id="LinearFixedEffectModel.fit">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LinearFixedEffectModel&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the LinearFixedEffect model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - X: array-like, shape (n_samples, n_features) or pd.DataFrame</span>
<span class="sd">            Design matrix (covariates) or complete dataset.</span>
<span class="sd">        - y: array-like, shape (n_samples,) or None</span>
<span class="sd">            Response variable or None if X is a DataFrame.</span>
<span class="sd">        - groups: array-like, shape (n_samples,) or None</span>
<span class="sd">            Group identifiers for fixed effects or None if X is a DataFrame.</span>
<span class="sd">        - x_vars: list of str, optional</span>
<span class="sd">            Column names in X to be used as predictors.</span>
<span class="sd">        - y_var: str, optional</span>
<span class="sd">            Column name in X to be used as the response variable.</span>
<span class="sd">        - group_var: str, optional</span>
<span class="sd">            Column name in X to be used as group identifiers.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - self: LinearFixedEffectModel</span>
<span class="sd">            The fitted model instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="n">y_var</span><span class="p">,</span> <span class="n">group_var</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="o">=</span> <span class="n">y</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">)</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span>
        <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Group preprocessing: Block diagonal matrix, group means</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">y_means</span><span class="p">,</span> <span class="n">X_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_groups</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">)</span>

        <span class="c1"># Weighted least squares</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_weighted_least_squares</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">beta</span>  <span class="c1"># Storing the linear predictor</span>

        <span class="c1"># Calculate fixed effects</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">y_means</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">X_means</span> <span class="o">@</span> <span class="n">beta</span>

        <span class="c1"># Store results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_residuals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_sigma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>

        <span class="c1"># Compute variances and statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_variances</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">X_means</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_model_statistics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.predict">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict using the LinearFixedEffect model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like or pd.DataFrame</span>
<span class="sd">            Design matrix (covariates) or complete dataset.</span>
<span class="sd">        groups : array-like or None</span>
<span class="sd">            Group identifiers or None if `group_var` is specified in a DataFrame.</span>
<span class="sd">        x_vars : list of str, optional</span>
<span class="sd">            Column names in X to be used as predictors, required if X is a DataFrame.</span>
<span class="sd">        group_var : str, optional</span>
<span class="sd">            Column name in X to be used as group identifiers, required if X is a DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Predicted values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model is not fitted. Call &#39;fit&#39; before &#39;predict&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Validate and convert inputs</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_convert_inputs</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group_var</span><span class="p">)</span>

        <span class="c1"># Align groups with fitted model&#39;s groups, need to fix this one</span>
        <span class="n">group_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>

        <span class="c1"># Retrieve regression coefficients</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>

        <span class="c1"># Calculate predictions</span>
        <span class="n">xbeta</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">beta</span>
        <span class="n">gamma_obs</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="n">group_indices</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">xbeta</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">+</span> <span class="n">gamma_obs</span>
        
        <span class="k">return</span> <span class="n">predictions</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.score">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the R^2 score for the model.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        - X: array-like, shape (n_samples, n_features)</span>
<span class="sd">            Design matrix (covariates).</span>
<span class="sd">        - y: array-like, shape (n_samples,)</span>
<span class="sd">            True target values.</span>
<span class="sd">        - groups: array-like, shape (n_samples,)</span>
<span class="sd">            Group identifiers for the fixed effects.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - r2: float</span>
<span class="sd">            R^2 score of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
        <span class="n">ss_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ss_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_residual</span> <span class="o">/</span> <span class="n">ss_total</span><span class="p">)</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.get_params">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.get_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return model parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        - params: dict, Model parameters including coefficients, variances, sigma, AIC, and BIC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;coefficients&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">,</span>
            <span class="s2">&quot;variances&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">,</span>
            <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span><span class="p">,</span>
            <span class="s2">&quot;aic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aic_</span><span class="p">,</span>
            <span class="s2">&quot;bic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bic_</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.summary">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">covariates</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides summary statistics for the covariate estimates in a fitted fixed effects model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        covariates : list of str or int, optional</span>
<span class="sd">            A subset of covariates for which summary statistics are returned.</span>
<span class="sd">            Can be specified as a list of covariate names or indices.</span>
<span class="sd">            By default, summary statistics for all covariates are returned.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            The confidence level for the hypothesis test.</span>
<span class="sd">        null : float, default=0</span>
<span class="sd">            The null hypothesis value for the covariate coefficients.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Specifies the alternative hypothesis; must be &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame with columns &quot;estimate&quot;, &quot;std_error&quot;, &quot;stat&quot;, &quot;p_value&quot;,</span>
<span class="sd">            &quot;ci_lower&quot;, and &quot;ci_upper&quot; for each covariate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before calling &#39;summary&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Extract covariate estimates and compute standard errors.</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">se_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]))</span>
        
        <span class="c1"># Get degrees of freedom: total observations minus (number of predictors + number of groups)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="n">m</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>

        <span class="c1"># Compute test statistics.</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">null</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_beta</span>

        <span class="c1"># Compute p-values and confidence intervals based on the specified alternative.</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">df</span><span class="p">))</span>
            <span class="n">crit_val</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit_val</span> <span class="o">*</span> <span class="n">se_beta</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit_val</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">crit_val</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit_val</span> <span class="o">*</span> <span class="n">se_beta</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">crit_val</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit_val</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Format p-values for readability.</span>
        <span class="n">p_val_formatted</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.7g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">p_val</span><span class="p">]</span>

        <span class="c1"># Use self.covariate_names_ (or assign default names if not available)</span>
        <span class="n">cov_names</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;covariate_names_&quot;</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;X</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">)])</span>

        <span class="c1"># Build the summary DataFrame using lower-case column names.</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
            <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">se_beta</span><span class="p">,</span>
            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_val_formatted</span><span class="p">,</span>
            <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">ci_lower</span><span class="p">,</span>
            <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">ci_upper</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">cov_names</span><span class="p">)</span>

        <span class="c1"># If a subset of covariates is requested, filter the rows accordingly.</span>
        <span class="k">if</span> <span class="n">covariates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">):</span>
                <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">covariates</span><span class="p">):</span>
                <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;covariates&#39; must be a list of names or indices.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary_df</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.calculate_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.calculate_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_standardized_measures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stdz</span><span class="o">=</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="s2">&quot;median&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate direct/indirect standardized differences for a fixed effects linear model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : Optional[list or np.ndarray]</span>
<span class="sd">            The specific groups or provider identifiers for which the differences should be calculated.</span>
<span class="sd">            If None, calculates for all groups.</span>
<span class="sd">        stdz : Union[str, list], default=&quot;indirect&quot;</span>
<span class="sd">            Methods for standardization; can be &quot;indirect&quot;, &quot;direct&quot;, or both.</span>
<span class="sd">        null : Union[str, float], default=&quot;median&quot;</span>
<span class="sd">            Baseline norm used for standardization; can be &quot;median&quot;, &quot;mean&quot;, or a specific numeric value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary containing DataFrames of standardized differences and observed/expected outcomes</span>
<span class="sd">            grouped by method. The keys will be &quot;indirect&quot; and/or &quot;direct&quot; based on the selected methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before calculating standardized differences.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Original outcomes were not stored during fitting.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">method</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;stdz&#39; must include &#39;indirect&#39; and/or &#39;direct&#39;.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Extract model components</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># shape (m,)</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">)</span>
        <span class="n">group_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>
        
        <span class="c1"># Determine the null value for gamma</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">group_sizes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">null</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;null&#39; argument provided. Must be &#39;median&#39;, &#39;mean&#39;, or a numeric value.&quot;</span><span class="p">)</span>
        
        <span class="c1"># If group_ids are specified, select those groups; otherwise, use all groups.</span>
        <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">)</span>
            <span class="n">selected_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Indirect Standardization</span>
        <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="c1"># For each observation, expected outcome = gamma_null + linear predictor.</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">gamma_null</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1"># Sum expected and observed by group.</span>
            <span class="n">expected_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">expected</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">))</span>
            <span class="p">])</span>
            <span class="n">observed_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outcome_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">))</span>
            <span class="p">])</span>
            <span class="c1"># Standardized difference is the (Obs - Exp) divided by the group size.</span>
            <span class="n">indirect_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_by_group</span> <span class="o">-</span> <span class="n">expected_by_group</span><span class="p">)</span> <span class="o">/</span> <span class="n">group_sizes</span>
            
            <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
                <span class="s2">&quot;indirect_difference&quot;</span><span class="p">:</span> <span class="n">indirect_diff</span><span class="p">,</span>
                <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">observed_by_group</span><span class="p">,</span>
                <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">expected_by_group</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="n">indirect_df</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indirect_df</span>
        
        <span class="c1"># Direct Standardization</span>
        <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
            <span class="c1"># Overall observed is the sum over all observations of (gamma_null + xbeta).</span>
            <span class="n">obs_direct_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">gamma_null</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="c1"># For each group, compute expected sum using the group-specific gamma.</span>
            <span class="n">exp_direct_by_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma_val</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="p">)</span> <span class="k">for</span> <span class="n">gamma_val</span> <span class="ow">in</span> <span class="n">gamma</span>
            <span class="p">])</span>
            <span class="c1"># Standardized difference is (expected_by_group - overall observed) divided by total sample size.</span>
            <span class="n">direct_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp_direct_by_group</span> <span class="o">-</span> <span class="n">obs_direct_total</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_samples</span>
            
            <span class="n">direct_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
                <span class="s2">&quot;direct_difference&quot;</span><span class="p">:</span> <span class="n">direct_diff</span><span class="p">,</span>
                <span class="s2">&quot;observed&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">),</span> <span class="n">obs_direct_total</span><span class="p">),</span>
                <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">exp_direct_by_group</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">direct_df</span> <span class="o">=</span> <span class="n">direct_df</span><span class="p">[</span><span class="n">direct_df</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">selected_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_df</span>
            
        <span class="k">return</span> <span class="n">results</span></div>

    
    <span class="c1"># --- Confidence Intervals ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ci_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">se</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute lower and upper bounds for confidence intervals given estimates,</span>
<span class="sd">        their standard errors, degrees of freedom, and the desired alternative.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gamma : np.ndarray</span>
<span class="sd">            The point estimates.</span>
<span class="sd">        se : np.ndarray</span>
<span class="sd">            Standard errors corresponding to gamma.</span>
<span class="sd">        df : int</span>
<span class="sd">            Degrees of freedom.</span>
<span class="sd">        level : float</span>
<span class="sd">            Confidence level (e.g., 0.95).</span>
<span class="sd">        alternative : str</span>
<span class="sd">            One of &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (lower, upper) as np.ndarray of the same shape as gamma.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">crit_value</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">+</span> <span class="n">crit_value</span> <span class="o">*</span> <span class="n">se</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; must be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>

<div class="viewcode-block" id="LinearFixedEffectModel.calculate_confidence_intervals">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.calculate_confidence_intervals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_confidence_intervals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SM&quot;</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate confidence intervals for provider effects (gamma) or standardized measures (SM).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : Optional[list or np.ndarray]</span>
<span class="sd">            Subset of group identifiers for which confidence intervals are calculated.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level.</span>
<span class="sd">        option : str, default=&quot;SM&quot;</span>
<span class="sd">            Either &quot;gamma&quot; for provider effects or &quot;SM&quot; for standardized measures.</span>
<span class="sd">        stdz : Union[str, list], default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method(s) if option is &quot;SM&quot;; must include &quot;indirect&quot; and/or &quot;direct&quot;.</span>
<span class="sd">        null : Union[str, float], default=&quot;median&quot;</span>
<span class="sd">            Baseline norm for calculating standardized measures.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            One of &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;. (Note: gamma option only supports two_sided.)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing DataFrames with confidence intervals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before calculating confidence intervals.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stdz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">stdz</span> <span class="o">=</span> <span class="p">[</span><span class="n">stdz</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;SM&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;option&#39; must be &#39;gamma&#39; or &#39;SM&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">stdz</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">,</span> <span class="s2">&quot;direct&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;stdz&#39; must include &#39;indirect&#39; and/or &#39;direct&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span> <span class="ow">and</span> <span class="n">alternative</span> <span class="o">!=</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provider effect &#39;gamma&#39; only supports two-sided confidence intervals.&quot;</span><span class="p">)</span>

        <span class="c1"># Degrees of freedom: total observations minus (number of groups + number of predictors)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="n">p</span>

        <span class="c1"># Compute standard errors for gamma using the flattened variances</span>
        <span class="n">se_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="c1"># Use the helper to compute CI bounds for gamma</span>
        <span class="n">lower_gamma</span><span class="p">,</span> <span class="n">upper_gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ci_bounds</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">se_gamma</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">alternative</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">gamma_ci</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;group_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span>
                <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
                <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower_gamma</span><span class="p">,</span>
                <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper_gamma</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gamma_ci</span> <span class="o">=</span> <span class="n">gamma_ci</span><span class="p">[</span><span class="n">gamma_ci</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;gamma_ci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma_ci</span>
        
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s2">&quot;SM&quot;</span><span class="p">:</span>
            <span class="c1"># First get the standardized measures</span>
            <span class="n">sm_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_standardized_measures</span><span class="p">(</span><span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">)</span>
            
            <span class="c1"># For indirect SM, we need to aggregate CI bounds from gamma over observations.</span>
            <span class="c1"># Replicate group-level lower/upper bounds for each observation.</span>
            <span class="n">lower_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">lower_gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">upper_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">upper_gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbeta_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1"># Sum over each group using np.bincount</span>
            <span class="n">lower_prov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">lower_obs</span><span class="p">)</span>
            <span class="n">upper_prov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices_</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">upper_obs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s2">&quot;indirect&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
                <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">sm_results</span><span class="p">[</span><span class="s2">&quot;indirect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">expected_indirect</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;expected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="c1"># Standardized difference: (observed - expected) normalized by group size.</span>
                <span class="n">lower_indirect</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_prov</span> <span class="o">-</span> <span class="n">expected_indirect</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>
                <span class="n">upper_indirect</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_prov</span> <span class="o">-</span> <span class="n">expected_indirect</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span>
                <span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_indirect</span>
                <span class="n">indirect_df</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_indirect</span>
                <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Filter by group IDs</span>
                    <span class="n">indirect_df</span> <span class="o">=</span> <span class="n">indirect_df</span><span class="p">[</span><span class="n">indirect_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">char_list</span><span class="p">[</span><span class="s2">&quot;ID.char&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;indirect_ci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indirect_df</span>
            
            <span class="k">if</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">in</span> <span class="n">stdz</span><span class="p">:</span>
                <span class="c1"># In direct standardization, the standardized difference equals gamma - gamma_null.</span>
                <span class="c1"># So the CI for the direct measure is simply:</span>
                <span class="c1"># lower_direct = lower_gamma - gamma_null</span>
                <span class="c1"># upper_direct = upper_gamma - gamma_null</span>
                <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
                    <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                    <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">null</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;null&#39; argument provided.&quot;</span><span class="p">)</span>
                <span class="n">direct_df</span> <span class="o">=</span> <span class="n">sm_results</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">lower_direct</span> <span class="o">=</span> <span class="n">lower_gamma</span> <span class="o">-</span> <span class="n">gamma_null</span>
                <span class="n">upper_direct</span> <span class="o">=</span> <span class="n">upper_gamma</span> <span class="o">-</span> <span class="n">gamma_null</span>
                <span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_direct</span>
                <span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_direct</span>
                <span class="k">if</span> <span class="n">group_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Filter direct CIs by group_ids; assume that the direct_df has a column named &quot;group_id&quot;</span>
                    <span class="n">direct_df</span> <span class="o">=</span> <span class="n">direct_df</span><span class="p">[</span><span class="n">direct_df</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;direct_ci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direct_df</span>
            
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.test">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">providers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">alternative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;two_sided&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conduct hypothesis tests on provider effects and identify outlying providers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        providers : Optional[Union[list, np.ndarray]]</span>
<span class="sd">            A subset of provider IDs for which tests are conducted. If None, tests are conducted for all providers.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for the hypothesis tests.</span>
<span class="sd">        null : Union[str, float], default=&quot;median&quot;</span>
<span class="sd">            Null hypothesis value for provider effects; options are &quot;median&quot;, &quot;mean&quot;, or a numeric value.</span>
<span class="sd">        alternative : str, default=&quot;two_sided&quot;</span>
<span class="sd">            Alternative hypothesis: &quot;two_sided&quot;, &quot;greater&quot;, or &quot;less&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame with columns &quot;flag&quot;, &quot;p_value&quot;, &quot;stat&quot;, and &quot;std_error&quot; for each provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must be fitted before testing.&quot;</span><span class="p">)</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">level</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>   <span class="c1"># shape (m,)</span>
        <span class="n">se_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">n_prov</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">total_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">total_samples</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="n">n_prov</span>

        <span class="c1"># Compute gamma_null using the actual group sizes (self.group_sizes_) if needed</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Group sizes are not available for computing a weighted mean.&quot;</span><span class="p">)</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">gamma_null</span> <span class="o">=</span> <span class="n">null</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;null&#39; must be &#39;median&#39;, &#39;mean&#39;, or a numeric value.&quot;</span><span class="p">)</span>

        <span class="c1"># Compute test statistics.</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="n">gamma_null</span><span class="p">)</span> <span class="o">/</span> <span class="n">se_gamma</span>

        <span class="c1"># Use the survival function so that a high test statistic yields a small probability,</span>
        <span class="c1"># consistent with R&#39;s pt(..., lower.tail = F)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>  <span class="c1"># equivalent to 1 - t.cdf(stat, df=df)</span>

        <span class="c1"># Determine flags and p-values based on the alternative hypothesis.</span>
        <span class="k">if</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;two_sided&quot;</span><span class="p">:</span>
            <span class="c1"># Flag: 1 if probability &lt; alpha/2, -1 if probability &gt; 1 - alpha/2, else 0.</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;greater&quot;</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">prob</span>
        <span class="k">elif</span> <span class="n">alternative</span> <span class="o">==</span> <span class="s2">&quot;less&quot;</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;alternative&#39; should be &#39;two_sided&#39;, &#39;greater&#39;, or &#39;less&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Build the result DataFrame, using self.groups_ as the index.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
            <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p_value</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
            <span class="s2">&quot;std_error&quot;</span><span class="p">:</span> <span class="n">se_gamma</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span>

        <span class="c1"># Filter results if a subset of providers is specified.</span>
        <span class="k">if</span> <span class="n">providers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">providers</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument &#39;providers&#39; should be a list or ndarray matching provider IDs.&quot;</span><span class="p">)</span>

        <span class="c1"># Optionally, attach the provider sizes as an attribute.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;provider_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

    

<div class="viewcode-block" id="LinearFixedEffectModel.plot_funnel">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.plot_funnel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_funnel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stdz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Lower&quot;</span><span class="p">,</span> <span class="s2">&quot;Expected&quot;</span><span class="p">,</span> <span class="s2">&quot;Higher&quot;</span><span class="p">],</span>
        <span class="n">point_colors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#E69F00&quot;</span><span class="p">,</span> <span class="s2">&quot;#56B4E9&quot;</span><span class="p">,</span> <span class="s2">&quot;#009E73&quot;</span><span class="p">],</span>
        <span class="n">point_shapes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">],</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">target_linestyle</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cl_line_colors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">cl_line_styles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#A6CEE3&quot;</span><span class="p">,</span>
        <span class="n">fill_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Funnel Plot of Standardized Differences&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Precision (Group Size)&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Standardized Difference&quot;</span><span class="p">,</span>
        <span class="n">legend_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;best&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a funnel plot for standardized differences.</span>

<span class="sd">        For LinearFixedEffectModel, this plots the indirect standardized difference</span>
<span class="sd">        (gamma_i - gamma_null) against group size (as a proxy for precision).</span>
<span class="sd">        Control limits are based on the overall model&#39;s residual standard deviation (sigma).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        stdz : str, default=&quot;indirect&quot;</span>
<span class="sd">            Standardization method. Currently, only &quot;indirect&quot; is meaningfully</span>
<span class="sd">            supported as both indirect and direct differences simplify to gamma_i - gamma_null.</span>
<span class="sd">        null : str or float, default=&quot;median&quot;</span>
<span class="sd">            Baseline for provider effects (gamma) used in calculating the difference</span>
<span class="sd">            and for flagging. Can be &quot;median&quot;, &quot;mean&quot;, or a specific float value.</span>
<span class="sd">        target : float, default=0.0</span>
<span class="sd">            Reference value for the difference (target line on the plot).</span>
<span class="sd">        alpha : float or List[float], default=0.05</span>
<span class="sd">            Significance level(s) for control limits.</span>
<span class="sd">        labels : List[str], default=[&quot;Lower&quot;, &quot;Expected&quot;, &quot;Higher&quot;]</span>
<span class="sd">            Labels for provider performance categories based on flags (-1, 0, 1).</span>
<span class="sd">        point_colors : List[str]</span>
<span class="sd">            Colors for provider points based on performance flag.</span>
<span class="sd">        point_shapes : List[str]</span>
<span class="sd">            Marker shapes for provider points based on performance flag.</span>
<span class="sd">        point_size : float, default=2.0</span>
<span class="sd">            Scaling factor for marker size.</span>
<span class="sd">        point_alpha : float, default=0.8</span>
<span class="sd">            Marker transparency.</span>
<span class="sd">        line_size : float, default=0.8</span>
<span class="sd">            Thickness for target and control limit lines.</span>
<span class="sd">        target_linestyle : str, default=&#39;--&#39;</span>
<span class="sd">            Line style for the target reference line.</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        cl_line_colors : str or List[str], optional</span>
<span class="sd">            Color(s) for the control limit lines. Defaults to &quot;grey&quot;.</span>
<span class="sd">        cl_line_styles : str or List[str], optional</span>
<span class="sd">            Line style(s) for control limits. Defaults based on number of alphas.</span>
<span class="sd">        fill_color : str, default=&quot;#A6CEE3&quot;</span>
<span class="sd">            Fill color for the area between the outermost control limits.</span>
<span class="sd">        fill_alpha : float, default=0.25</span>
<span class="sd">            Transparency of the control limit fill area.</span>
<span class="sd">        edge_color : str or None, default=&quot;grey&quot;</span>
<span class="sd">            Edge color for scatter points.</span>
<span class="sd">        edge_linewidth : float, default=0.5</span>
<span class="sd">            Line width for scatter point edges.</span>
<span class="sd">        add_grid : bool, default=True</span>
<span class="sd">            Whether to add a background grid.</span>
<span class="sd">        grid_style : str, default=&#39;:&#39;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default=0.6</span>
<span class="sd">            Transparency for the grid lines.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">            Whether to remove the top and right axis lines.</span>
<span class="sd">        figure_size : Tuple[float, float], default=(8, 6)</span>
<span class="sd">            Figure size in inches.</span>
<span class="sd">        plot_title : str, default=&quot;Funnel Plot of Standardized Differences&quot;</span>
<span class="sd">            Title for the plot.</span>
<span class="sd">        xlab : str, default=&quot;Precision (Group Size)&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylab : str, default=&quot;Standardized Difference&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">        legend_location : str, default=&#39;best&#39;</span>
<span class="sd">            Location string for the legend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted and sigma estimated before plotting funnel plot.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdz</span> <span class="o">!=</span> <span class="s2">&quot;indirect&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Funnel plot for LinearFixedEffectModel is primarily designed for &#39;indirect&#39; standardized differences.&quot;</span><span class="p">)</span>

        <span class="n">a_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">alpha</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">alpha_test</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="n">sm_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_standardized_measures</span><span class="p">(</span><span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdz</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sm_info</span> <span class="ow">or</span> <span class="n">sm_info</span><span class="p">[</span><span class="n">stdz</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No standardized measure data found for &#39;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">&#39;. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sm_info</span><span class="p">[</span><span class="n">stdz</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;group_id&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">precision_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groups_</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">precision_map</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha_test</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two_sided&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">limits_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a_val</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">:</span>
            <span class="n">z_val</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a_val</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">se_for_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">])</span>
            <span class="n">se_for_limits</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">se_for_limits</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">control_lower</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">z_val</span> <span class="o">*</span> <span class="n">se_for_limits</span>
            <span class="n">control_upper</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="n">z_val</span> <span class="o">*</span> <span class="n">se_for_limits</span>
            <span class="n">limits_df_a</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                <span class="s2">&quot;control_lower&quot;</span><span class="p">:</span> <span class="n">control_lower</span><span class="p">,</span>
                <span class="s2">&quot;control_upper&quot;</span><span class="p">:</span> <span class="n">control_upper</span><span class="p">,</span> 
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">a_val</span>
            <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">limits_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limits_df_a</span><span class="p">)</span>
        <span class="n">limits_all_alphas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">limits_list</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>
        <span class="n">limits_all_alphas</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">)</span>
        <span class="n">outer_alpha</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cl_line_styles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">default_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
            <span class="n">cl_line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">default_styles</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_styles</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_line_styles</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">cl_line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_line_styles</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cl_line_colors</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl_line_colors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
            <span class="n">cl_line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cl_line_colors</span> <span class="ow">or</span> <span class="s1">&#39;grey&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
        
        <span class="n">sorted_alphas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">a_list</span><span class="p">)</span>
        <span class="n">style_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_alphas</span><span class="p">,</span> <span class="n">cl_line_styles</span><span class="p">));</span> <span class="n">color_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_alphas</span><span class="p">,</span> <span class="n">cl_line_colors</span><span class="p">))</span>
        <span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">outer_limits</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">outer_alpha</span><span class="p">]</span>
        <span class="n">label_outer_ci</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">outer_alpha</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span>
        <span class="n">fill_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> <span class="n">outer_limits</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">fill_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">fill_alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_outer_ci</span><span class="p">)</span>
        <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_handle</span><span class="p">);</span> <span class="n">legend_labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_outer_ci</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a_val</span> <span class="ow">in</span> <span class="n">sorted_alphas</span><span class="p">:</span>
            <span class="n">subset_lim</span> <span class="o">=</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">a_val</span><span class="p">]</span>
            <span class="n">line_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">a_val</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span> <span class="k">if</span> <span class="n">a_val</span> <span class="o">!=</span> <span class="n">outer_alpha</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">line_lower</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">style_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">line_label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">subset_lim</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">style_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">a_val</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_label</span><span class="p">:</span> <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_lower</span><span class="p">);</span> <span class="n">legend_labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_label</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">target_linestyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

        <span class="n">present_flags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">flag_map</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">flag_val</span> <span class="ow">in</span> <span class="n">present_flags</span><span class="p">:</span>
            <span class="n">subset_pts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">flag_val</span><span class="p">]</span>
            <span class="n">label_idx</span> <span class="o">=</span> <span class="n">flag_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flag_val</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_pts</span><span class="p">)</span>
            <span class="n">point_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">label_idx</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">scatter_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subset_pts</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> 
                                        <span class="n">subset_pts</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_difference&quot;</span><span class="p">],</span>
                                        <span class="n">marker</span><span class="o">=</span><span class="n">point_shapes</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_shapes</span><span class="p">)],</span> 
                                        <span class="n">color</span><span class="o">=</span><span class="n">point_colors</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_colors</span><span class="p">)],</span>
                                        <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span> 
                                        <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span> 
                                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span> 
                                        <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> 
                                        <span class="n">label</span><span class="o">=</span><span class="n">point_label</span><span class="p">)</span>
            <span class="n">legend_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter_handle</span><span class="p">);</span> 
            <span class="n">legend_labels_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_label</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        
        <span class="n">all_y_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_difference&quot;</span><span class="p">],</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;control_lower&quot;</span><span class="p">],</span> <span class="n">limits_all_alphas</span><span class="p">[</span><span class="s2">&quot;control_upper&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_y_values</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">min_y_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">all_y_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">max_y_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">all_y_values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y_val</span> <span class="o">-</span> <span class="n">min_y_val</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_y_val</span> <span class="o">-</span> <span class="n">min_y_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mf">0.1</span> <span class="c1"># Ensure padding is positive</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_y_val</span> <span class="o">-</span> <span class="n">padding</span><span class="p">,</span> <span class="n">max_y_val</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span>
        
        <span class="n">max_x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="p">(</span><span class="n">max_x</span> <span class="o">*</span> <span class="mf">1.05</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">max_x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">max_x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        
        <span class="n">unique_handles_labels</span> <span class="o">=</span> <span class="p">{};</span> 
        <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">legend_labels_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_handles_labels</span><span class="p">:</span> 
                <span class="n">unique_handles_labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">unique_handles_labels</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> 
                  <span class="n">labels</span><span class="o">=</span><span class="n">unique_handles_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> 
                  <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> 
                  <span class="n">loc</span><span class="o">=</span><span class="n">legend_location</span><span class="p">,</span> 
                  <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Flag&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.plot_provider_effects">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.plot_provider_effects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_provider_effects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Added for consistency with LogisticFE</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots provider fixed effects (gamma) using the plot_caterpillar helper function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to plot. If None, all providers are included.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Whether to color-code providers based on flags from the test method.</span>
<span class="sd">        null : str or float, default=&#39;median&#39;</span>
<span class="sd">            Null hypothesis for gamma used for flagging. Can be &#39;median&#39;, &#39;mean&#39;, or a float.</span>
<span class="sd">        test_method : str, optional</span>
<span class="sd">             Test method used specifically for generating flags (&#39;wald&#39; is the only one for LinearFE&#39;s .test()).</span>
<span class="sd">             If None, defaults to &#39;wald&#39;.</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to plot_caterpillar (e.g., plot_title, orientation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first.&quot;</span><span class="p">)</span>

        <span class="c1"># Get gamma CIs (always two-sided for plotting)</span>
        <span class="c1"># For LinearFixedEffectModel, test_method in calculate_CIs is implicitly Wald-like (t-dist)</span>
        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span> 
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
            <span class="n">option</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> 
            <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;gamma_ci&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ci_results</span> <span class="ow">or</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;gamma_ci&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No gamma CI data. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="s1">&#39;gamma_ci&#39;</span><span class="p">]</span> <span class="c1"># Has &#39;group_id&#39;, &#39;gamma&#39;, &#39;lower&#39;, &#39;upper&#39;</span>

        <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">flag_col_name</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span>
            <span class="c1"># LinearFEModel&#39;s test method is t-test based (Wald-like)</span>
            <span class="n">current_test_method</span> <span class="o">=</span> <span class="n">test_method</span> <span class="k">if</span> <span class="n">test_method</span> <span class="k">else</span> <span class="s1">&#39;wald&#39;</span> <span class="c1"># Default for LinearFE</span>
            <span class="k">if</span> <span class="n">current_test_method</span> <span class="o">!=</span> <span class="s1">&#39;wald&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LinearFixedEffectModel.test uses a t-test (Wald-like). test_method &#39;</span><span class="si">{</span><span class="n">current_test_method</span><span class="si">}</span><span class="s2">&#39; for flagging will use this underlying test.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                    <span class="n">providers</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
                    <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> 
                    <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
                <span class="p">)</span>
                <span class="c1"># Merge flags using left_on=&#39;group_id&#39; and right_index=True since test_df is indexed by provider IDs</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate flags. Plotting without flags. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">gamma_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">gamma_null_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">null</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">gamma_null_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">gamma_vals</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sizes_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">gamma_null_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>

        <span class="c1"># Default orientation is vertical (groups on Y, estimates on X)</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Gamma Estimate (Fixed Effect)&#39;</span><span class="p">)</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># horizontal</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider&#39;</span><span class="p">)</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="s1">&#39;Gamma Estimate (Fixed Effect)&#39;</span><span class="p">)</span>

        <span class="c1"># Use &#39;plot_title&#39; instead of &#39;title&#39; to match plot_caterpillar&#39;s parameter</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;plot_title&#39;</span><span class="p">,</span> <span class="s1">&#39;Provider Effects (Gamma)&#39;</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="n">gamma_null_val</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span> 
            <span class="n">estimate_col</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> 
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> 
            <span class="n">flag_col</span><span class="o">=</span><span class="n">flag_col_name</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.plot_standardized_measures">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.plot_standardized_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_standardized_measures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
        <span class="n">stdz</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;indirect&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span>
        <span class="n">use_flags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
        <span class="n">test_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots standardized differences using plot_caterpillar.</span>
<span class="sd">        For LinearFixedEffectModel, standardized measures are differences (gamma_i - gamma_null).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_ids : list or np.ndarray, optional</span>
<span class="sd">            Subset of provider IDs to plot.</span>
<span class="sd">        level : float, default=0.95</span>
<span class="sd">            Confidence level for intervals.</span>
<span class="sd">        stdz : str, default=&#39;indirect&#39;</span>
<span class="sd">            Standardization method (&#39;indirect&#39; or &#39;direct&#39;). Both result in gamma_i - gamma_null.</span>
<span class="sd">        measure : str, default=&#39;difference&#39;</span>
<span class="sd">            The measure to plot. For linear models, this is always &#39;difference&#39;.</span>
<span class="sd">        use_flags : bool, default=True</span>
<span class="sd">            Whether to color-code providers based on flags from the gamma test method.</span>
<span class="sd">        null : str or float, default=&#39;median&#39;</span>
<span class="sd">            Null hypothesis for gamma used for flagging and calculating the difference.</span>
<span class="sd">        test_method : str, optional</span>
<span class="sd">             Test method used specifically for generating flags. Defaults to &#39;wald&#39; (t-test).</span>
<span class="sd">        **plot_kwargs</span>
<span class="sd">            Additional arguments passed to plot_caterpillar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">measure</span> <span class="o">!=</span> <span class="s1">&#39;difference&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;For LinearFixedEffectModel, standardized &#39;measure&#39; is &#39;difference&#39;.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get SM CIs (which are for the difference: gamma_i - gamma_null)</span>
        <span class="n">ci_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_confidence_intervals</span><span class="p">(</span>
            <span class="n">group_ids</span><span class="o">=</span><span class="n">group_ids</span><span class="p">,</span> 
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
            <span class="n">option</span><span class="o">=</span><span class="s1">&#39;SM&#39;</span><span class="p">,</span> 
            <span class="n">stdz</span><span class="o">=</span><span class="n">stdz</span><span class="p">,</span> 
            <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> 
            <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span>
        <span class="p">)</span>
        <span class="n">ci_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_ci&quot;</span>
        <span class="k">if</span> <span class="n">ci_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ci_results</span> <span class="ow">or</span> <span class="n">ci_results</span><span class="p">[</span><span class="n">ci_key</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No SM CI data for &#39;</span><span class="si">{</span><span class="n">ci_key</span><span class="si">}</span><span class="s2">&#39;. Cannot plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">ci_results</span><span class="p">[</span><span class="n">ci_key</span><span class="p">]</span> <span class="c1"># This df should have &#39;group_id&#39;, &#39;{stdz}_difference&#39;, &#39;lower&#39;, &#39;upper&#39;</span>
        <span class="n">estimate_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="si">}</span><span class="s2">_difference&quot;</span>
                
        <span class="k">if</span> <span class="n">estimate_col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;lower&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;upper&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required columns (&#39;</span><span class="si">{</span><span class="n">estimate_col_name</span><span class="si">}</span><span class="s2">&#39;, &#39;lower&#39;, &#39;upper&#39;) not found in SM CI results. Available: </span><span class="si">{</span><span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_flags</span><span class="p">:</span>
            <span class="n">flag_col_name</span> <span class="o">=</span> <span class="s1">&#39;flag&#39;</span>
            <span class="n">current_test_method</span> <span class="o">=</span> <span class="n">test_method</span> <span class="k">if</span> <span class="n">test_method</span> <span class="k">else</span> <span class="s1">&#39;wald&#39;</span>
            <span class="k">if</span> <span class="n">current_test_method</span> <span class="o">!=</span> <span class="s1">&#39;wald&#39;</span><span class="p">:</span>
                 <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LinearFixedEffectModel.test uses a t-test (Wald-like). test_method &#39;</span><span class="si">{</span><span class="n">current_test_method</span><span class="si">}</span><span class="s2">&#39; for flagging will use this.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">providers</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
                                    <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span> 
                                    <span class="n">null</span><span class="o">=</span><span class="n">null</span><span class="p">,</span> 
                                    <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two_sided&#39;</span><span class="p">)</span>
                <span class="c1"># Merge using left_on=&#39;group_id&#39; and right_index=True</span>
                <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test_df</span><span class="p">[[</span><span class="s1">&#39;flag&#39;</span><span class="p">]],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="n">flag_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate flags. Plotting without flags. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">flag_col_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">default_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Standardized Difference&quot;</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s1">&#39;vertical&#39;</span><span class="p">:</span>
            <span class="n">default_xlab</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Difference Estimate&quot;</span>
            <span class="n">default_ylab</span> <span class="o">=</span> <span class="s2">&quot;Provider&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_xlab</span> <span class="o">=</span> <span class="s2">&quot;Provider&quot;</span>
            <span class="n">default_ylab</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stdz</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Difference Estimate&quot;</span>
        <span class="n">default_refline</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;plot_title&#39;</span><span class="p">,</span> <span class="n">default_title</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;xlab&#39;</span><span class="p">,</span> <span class="n">default_xlab</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ylab&#39;</span><span class="p">,</span> <span class="n">default_ylab</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;refline_value&#39;</span><span class="p">,</span> <span class="n">default_refline</span><span class="p">)</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="p">)</span>

        <span class="n">plot_caterpillar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span> 
            <span class="n">estimate_col</span><span class="o">=</span><span class="n">estimate_col_name</span><span class="p">,</span>
            <span class="n">ci_lower_col</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> 
            <span class="n">ci_upper_col</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span>
            <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> 
            <span class="n">flag_col</span><span class="o">=</span><span class="n">flag_col_name</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">plot_kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.plot_coefficient_forest">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.plot_coefficient_forest">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_coefficient_forest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
        <span class="n">refline_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#34495E&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">error_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#95A5A6&quot;</span><span class="p">,</span>
        <span class="n">capsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">errorbar_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">errorbar_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figure_size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">plot_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Forest Plot of Covariate Coefficients&quot;</span><span class="p">,</span>
        <span class="n">xlab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Coefficient Estimate&quot;</span><span class="p">,</span>
        <span class="n">ylab</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Covariate&quot;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a forest plot of covariate coefficients with 95% confidence intervals.</span>

<span class="sd">        Plots each covariate&#39;s coefficient estimate and its confidence interval</span>
<span class="sd">        in a vertical or horizontal layout, with a reference line at a specified value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orientation : {&#39;vertical&#39;,&#39;horizontal&#39;}, default &#39;vertical&#39;</span>
<span class="sd">            &#39;vertical&#39;: covariate names on the y-axis, estimates on the x-axis.</span>
<span class="sd">            &#39;horizontal&#39;: covariate names on the x-axis, estimates on the y-axis.</span>
<span class="sd">        refline_value : float or None, default 0.0</span>
<span class="sd">            Draws a reference line at this value (vertical or horizontal). None disables it.</span>
<span class="sd">        point_color : str, default &quot;#34495E&quot;</span>
<span class="sd">            Color of the coefficient marker.</span>
<span class="sd">        point_alpha : float, default 0.8</span>
<span class="sd">            Opacity of the coefficient marker.</span>
<span class="sd">        edge_color : str or None, default None</span>
<span class="sd">            Edge color of the marker. None for no edge.</span>
<span class="sd">        edge_linewidth : float, default 0</span>
<span class="sd">            Width of the marker edge.</span>
<span class="sd">        point_size : float, default 0.5</span>
<span class="sd">            Scale factor for marker size.</span>
<span class="sd">        error_color : str, default &quot;#95A5A6&quot;</span>
<span class="sd">            Color of the error bars.</span>
<span class="sd">        capsize : float, default 5</span>
<span class="sd">            Cap size for error bars.</span>
<span class="sd">        errorbar_size : float, default 0.5</span>
<span class="sd">            Thickness of the error bar lines.</span>
<span class="sd">        errorbar_alpha : float, default 0.5</span>
<span class="sd">            Opacity of the error bars.</span>
<span class="sd">        line_color : str, default &quot;red&quot;</span>
<span class="sd">            Color of the reference line.</span>
<span class="sd">        line_style : str, default &quot;--&quot;</span>
<span class="sd">            Line style of the reference line.</span>
<span class="sd">        line_size : float, default 0.8</span>
<span class="sd">            Thickness of the reference line.</span>
<span class="sd">        font_size : float, default 12</span>
<span class="sd">            Font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default 10</span>
<span class="sd">            Font size for tick labels.</span>
<span class="sd">        add_grid : bool, default True</span>
<span class="sd">            Whether to draw a light grid.</span>
<span class="sd">        grid_style : str, default &quot;:&quot;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default 0.6</span>
<span class="sd">            Opacity of the grid.</span>
<span class="sd">        remove_top_right_spines : bool, default True</span>
<span class="sd">            Hide the top and right spines.</span>
<span class="sd">        figure_size : tuple, default (10, 6)</span>
<span class="sd">            Size of the figure in inches.</span>
<span class="sd">        plot_title : str, default &quot;Forest Plot of Covariate Coefficients&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        xlab : str, default &quot;Coefficient Estimate&quot;</span>
<span class="sd">            Label for the x-axis (or y-axis if horizontal).</span>
<span class="sd">        ylab : str, default &quot;Covariate&quot;</span>
<span class="sd">            Label for the y-axis (or x-axis if horizontal).</span>
<span class="sd">        save_path : str or None, default None</span>
<span class="sd">            File path to save the figure. If None, the plot is shown.</span>
<span class="sd">        dpi : int, default 300</span>
<span class="sd">            Resolution (dots per inch) for saving.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model is not fitted or if an invalid orientation is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preconditions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variances_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting coefficients.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orientation must be &#39;vertical&#39; or &#39;horizontal&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Compute estimates and 95% CIs</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">se_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variances_</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]))</span>
        <span class="n">df_denom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
        <span class="n">crit</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df_denom</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">crit</span> <span class="o">*</span> <span class="n">se_beta</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">crit</span> <span class="o">*</span> <span class="n">se_beta</span>

        <span class="n">coef_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;covariate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariate_names_</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
                <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
                <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="n">upper</span>
            <span class="p">})</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;estimate&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Positions</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coef_df</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># Prepare coordinates and errors</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">],</span> <span class="n">positions</span>
            <span class="n">xerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="n">positions</span><span class="p">,</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_lower&quot;</span><span class="p">],</span>
                <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;estimate&quot;</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="c1"># Plot setup</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_size</span><span class="p">)</span>

        <span class="c1"># Draw errorbars and points</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">xerr</span><span class="o">=</span><span class="n">xerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span>
                <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="n">error_color</span><span class="p">,</span>
                <span class="n">capsize</span><span class="o">=</span><span class="n">capsize</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">edge_color</span>
            <span class="p">)</span>

        <span class="c1"># Reference line</span>
        <span class="k">if</span> <span class="n">refline_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">refline_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_size</span><span class="p">)</span>

        <span class="c1"># Labels, ticks, grid</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ylab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s2">&quot;covariate&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">)</span>

        <span class="c1"># Spines</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;vertical&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="c1"># Title &amp; layout</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1"># Save or show</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="LinearFixedEffectModel.plot_residuals">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.plot_residuals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_residuals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#1F78B4&quot;</span><span class="p">,</span>
        <span class="n">point_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">edge_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
        <span class="n">edge_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">point_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">line_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">line_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Fitted Values&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Residuals&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Residuals vs. Fitted Values&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">grid_style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>
        <span class="n">grid_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots residuals versus fitted values.</span>

<span class="sd">        This diagnostic plot helps assess model assumptions such as linearity</span>
<span class="sd">        and homoscedasticity (constant variance of errors). Ideally, the points</span>
<span class="sd">        should show no discernible pattern and be randomly scattered around the</span>
<span class="sd">        horizontal line at zero.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figsize : tuple, default=(8, 5)</span>
<span class="sd">            Size of the figure to create.</span>
<span class="sd">        point_color : str, default=&quot;#1F78B4&quot;</span>
<span class="sd">            Color for the residual points.</span>
<span class="sd">        point_alpha : float, default=0.6</span>
<span class="sd">            Transparency level for the points.</span>
<span class="sd">        edge_color : str or None, default=&quot;grey&quot;</span>
<span class="sd">            Edge color for the points. None means no edge.</span>
<span class="sd">        edge_linewidth : float, default=0.5</span>
<span class="sd">            Width of the point edges if `edge_color` is specified.</span>
<span class="sd">        point_size : float, default=30</span>
<span class="sd">            Size of the scatter plot markers.</span>
<span class="sd">        line_color : str, default=&quot;red&quot;</span>
<span class="sd">            Color of the horizontal reference line at zero.</span>
<span class="sd">        line_style : str, default=&quot;--&quot;</span>
<span class="sd">            Line style for the reference line.</span>
<span class="sd">        line_width : float, default=1.5</span>
<span class="sd">            Width of the reference line.</span>
<span class="sd">        xlabel : str, default=&quot;Fitted Values&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylabel : str, default=&quot;Residuals&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">        title : str, default=&quot;Residuals vs. Fitted Values&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        add_grid : bool, default=True</span>
<span class="sd">            Whether to add a background grid.</span>
<span class="sd">        grid_style : str, default=&#39;:&#39;</span>
<span class="sd">            Line style for the grid.</span>
<span class="sd">        grid_alpha : float, default=0.6</span>
<span class="sd">            Transparency for the grid lines.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">            Whether to remove the top and right plot spines.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has not been fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting residuals.&quot;</span><span class="p">)</span>

        <span class="c1"># Create a new figure and axes for the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">point_alpha</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">edge_linewidth</span> <span class="k">if</span> <span class="n">edge_color</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">point_size</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">line_style</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">line_width</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">grid_style</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">grid_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        <span class="c1"># No return value</span>

<div class="viewcode-block" id="LinearFixedEffectModel.plot_qq">
<a class="viewcode-back" href="../../api.html#pprof_py.linear_fixed_effect.LinearFixedEffectModel.plot_qq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_qq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Normal Q-Q Plot of Residuals&quot;</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Theoretical Normal Quantiles&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Ordered Residuals&quot;</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">tick_label_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">point_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#1F78B4&quot;</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">add_grid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">remove_top_right_spines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Q-Q plot of residuals against a Normal distribution.</span>

<span class="sd">        This plot helps assess the assumption of normally distributed errors,</span>
<span class="sd">        which is important for the validity of t-tests and confidence intervals</span>
<span class="sd">        in linear models. Points falling approximately along the diagonal line</span>
<span class="sd">        suggest normality.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        figsize : tuple, default=(7, 6)</span>
<span class="sd">            Size of the figure to create.</span>
<span class="sd">        title : str, default=&quot;Normal Q-Q Plot of Residuals&quot;</span>
<span class="sd">            Title of the plot.</span>
<span class="sd">        xlabel : str, default=&quot;Theoretical Normal Quantiles&quot;</span>
<span class="sd">            Label for the x-axis.</span>
<span class="sd">        ylabel : str, default=&quot;Ordered Residuals&quot;</span>
<span class="sd">            Label for the y-axis.</span>
<span class="sd">        font_size : float, default=12</span>
<span class="sd">            Base font size for labels and title.</span>
<span class="sd">        tick_label_size : float, default=10</span>
<span class="sd">            Font size for axis tick labels.</span>
<span class="sd">        point_color : str, default=&quot;#1F78B4&quot;</span>
<span class="sd">            Color for the points representing residuals.</span>
<span class="sd">        line_color : str, default=&quot;red&quot;</span>
<span class="sd">            Color for the diagonal reference line.</span>
<span class="sd">        add_grid : bool, default=False</span>
<span class="sd">            Whether to add a background grid.</span>
<span class="sd">        remove_top_right_spines : bool, default=True</span>
<span class="sd">            Whether to remove the top and right plot spines.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the model has not been fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be fitted before plotting QQ plot.&quot;</span><span class="p">)</span>

        <span class="c1"># Create a new figure and axes for the plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Ensure residuals are 1D array</span>
        <span class="n">residuals_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Create the Q-Q plot using scipy.stats.probplot</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">osm</span><span class="p">,</span> <span class="n">osr</span><span class="p">),</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_sq</span><span class="p">)</span> <span class="o">=</span> <span class="n">probplot</span><span class="p">(</span><span class="n">residuals_flat</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Plot the ordered residuals against theoretical quantiles</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">osm</span><span class="p">,</span> <span class="n">osr</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="c1"># Plot the fitted line</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">osm</span><span class="p">,</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">osm</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not generate Q-Q plot data, possibly due to issues with residuals: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Plot empty axes as placeholder if data generation fails</span>
            <span class="k">pass</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">tick_label_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_grid</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_top_right_spines</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kevin He.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>